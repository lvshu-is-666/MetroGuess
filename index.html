<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地铁站名猜谜游戏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="encrypted_data.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .icon {
            display: inline-block;
            width: 1.25em;
            height: 1.25em;
            vertical-align: middle;
        }
        .icon-sm { width: 1em; height: 1em; }
        .icon-lg { width: 1.5em; height: 1.5em; }
        
        :root {
            --primary-color: #4F46E5;
            --primary-light: #818CF8;
            --primary-dark: #3730A3;
            --success-color: #10B981;
            --warning-color: #F97316;
            --hint-color: #8B5CF6;
            --error-color: #EF4444;
            --cta-color: #F97316;
            --bg-color: #EEF2FF;
            --text-color: #1E1B4B;
            --transition-fast: 0.15s ease-out;
            --transition-normal: 0.25s ease-out;
            --shadow-sm: 0 4px 12px;
            --shadow-glow: 0 0 20px;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
        }
        
        html {
            scroll-behavior: smooth;
        }
        
        * {
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif;
            box-sizing: border-box;
        }
        
        h1, h2, h3, h4, h5, h6, .font-display {
            font-family: 'Fredoka', 'Nunito', sans-serif;
        }
        
        .glass-panel {
            background: rgba(238, 242, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(129, 140, 248, 0.3);
            box-shadow: 0 8px 32px rgba(79, 70, 229, 0.1);
        }
        
        .station-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(238, 242, 255, 0.9) 100%);
            border: 2px solid rgba(129, 140, 248, 0.4);
            transition: border-color var(--transition-normal), box-shadow var(--transition-normal), transform var(--transition-normal);
            box-shadow: 0 4px 16px rgba(79, 70, 229, 0.08);
            will-change: transform;
        }
        
        .station-card:hover {
            border-color: var(--primary-light);
            box-shadow: 0 8px 32px rgba(79, 70, 229, 0.2), 0 0 20px rgba(129, 140, 248, 0.3);
            transform: translateY(-2px);
        }
        
        .station-card.solved {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.1) 100%);
            border-color: var(--success-color);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }
        
        .letter-display {
            font-family: 'Courier New', monospace;
            letter-spacing: 0.15em;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            transition: transform var(--transition-fast), box-shadow var(--transition-fast);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
            will-change: transform;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4), 0 0 30px rgba(129, 140, 248, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--cta-color) 0%, #FB923C 100%);
            transition: transform var(--transition-fast), box-shadow var(--transition-fast);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
            will-change: transform;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(249, 115, 22, 0.4), 0 0 30px rgba(251, 146, 60, 0.3);
        }
        
        .btn-hint {
            background: linear-gradient(135deg, var(--hint-color) 0%, #A78BFA 100%);
            transition: transform var(--transition-fast), box-shadow var(--transition-fast);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
            will-change: transform;
        }
        
        .btn-hint:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4), 0 0 30px rgba(167, 139, 250, 0.3);
        }
        
        .mode-btn, .difficulty-btn {
            transition: background-color var(--transition-normal), border-color var(--transition-normal), box-shadow var(--transition-normal);
            background-color: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(129, 140, 248, 0.3);
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.08);
        }
        
        .mode-btn:hover, .difficulty-btn:hover {
            background-color: rgba(238, 242, 255, 0.95);
            border-color: var(--primary-light);
            box-shadow: 0 4px 16px rgba(79, 70, 229, 0.15);
        }
        
        .mode-btn.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 16px rgba(79, 70, 229, 0.3), 0 0 20px rgba(129, 140, 248, 0.2);
        }
        
        .difficulty-btn.active {
            background: linear-gradient(135deg, #059669 0%, #10B981 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3), 0 0 20px rgba(16, 185, 129, 0.2);
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .guess-history-item, .leaderboard-item { 
            animation: slideIn 0.25s ease-out;
            will-change: transform, opacity;
        }
        .letter-reveal { 
            animation: popIn 0.3s ease-out;
            will-change: transform, opacity;
        }
        .score-popup { 
            animation: popIn 0.4s ease-out;
            will-change: transform, opacity;
        }
        .achievement-badge { animation: badgeShine 2s ease infinite; }
        .toast { 
            animation: fadeInUp 0.25s ease-out;
            will-change: transform, opacity;
        }
        .toast-exit { animation: toastExit 0.25s ease-out forwards; }
        
        @keyframes badgeShine {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
        }
        
        .crt-overlay {
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.03),
                rgba(0, 0, 0, 0.03) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
        }
        
        .neon-glow {
            text-shadow: 
                0 0 10px rgba(129, 140, 248, 0.8),
                0 0 20px rgba(129, 140, 248, 0.6),
                0 0 40px rgba(79, 70, 229, 0.4),
                0 0 80px rgba(79, 70, 229, 0.2);
            animation: neonPulse 2s ease-in-out infinite alternate;
        }
        
        @keyframes neonPulse {
            from {
                text-shadow: 
                    0 0 10px rgba(129, 140, 248, 0.8),
                    0 0 20px rgba(129, 140, 248, 0.6),
                    0 0 40px rgba(79, 70, 229, 0.4),
                    0 0 80px rgba(79, 70, 229, 0.2);
            }
            to {
                text-shadow: 
                    0 0 15px rgba(129, 140, 248, 1),
                    0 0 30px rgba(129, 140, 248, 0.8),
                    0 0 60px rgba(79, 70, 229, 0.6),
                    0 0 100px rgba(79, 70, 229, 0.3);
            }
        }
        
        .input-glow:focus {
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        
        .letter-key {
            transition: transform var(--transition-fast), background-color var(--transition-fast), border-color var(--transition-fast);
            will-change: transform;
        }
        
        .letter-key:hover {
            transform: scale(1.08);
        }
        
        .letter-key.used {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }
        
        .letter-key.found {
            background: var(--success-color);
            color: white;
        }
        
        .letter-key.not-found {
            background: var(--error-color);
            color: white;
        }
        
        .timer-display {
            font-variant-numeric: tabular-nums;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, var(--success-color), #16a34a);
            transition: width 0.35s ease-out;
            will-change: width;
        }
        
        .shake { animation: shake 0.5s ease; }
        .pulse-success { animation: pulseSuccess 0.5s ease; }
        .combo-display { animation: comboPop 0.3s ease; }
        .float-score {
            animation: floatScore 1s ease forwards;
            pointer-events: none;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        
        @keyframes pulseSuccess {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        
        @keyframes floatScore {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-40px) scale(1.3); }
        }
        
        @keyframes comboPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        @keyframes toastExit {
            to { opacity: 0; transform: translateY(-15px); }
        }
        
        .particle {
            position: fixed;
            pointer-events: none;
            animation: particleFall 0.7s ease-out forwards;
            will-change: transform, opacity;
        }
        
        @keyframes particleFall {
            0% { opacity: 1; transform: translateY(0) rotate(0deg); }
            100% { opacity: 0; transform: translateY(80px) rotate(360deg); }
        }
        
        .firework {
            position: fixed;
            pointer-events: none;
        }
        
        .firework-particle {
            position: absolute;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            animation: fireworkExplode 0.8s ease-out forwards;
            will-change: transform, opacity;
        }
        
        @keyframes fireworkExplode {
            0% { opacity: 1; transform: translate(0, 0) scale(1); }
            100% { opacity: 0; transform: var(--end-pos) scale(0); }
        }
        
        .tooltip {
            position: relative;
        }
        
        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 8px;
            background: #1e293b;
            color: white;
            font-size: 12px;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        
        .tooltip:hover::after {
            opacity: 1;
        }
        
        @media (max-width: 640px) {
            .letter-display {
                letter-spacing: 0.08em;
                font-size: 0.875rem;
            }
        }
        
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            
            .neon-glow {
                animation: none;
            }
            
            .station-card:hover,
            .btn-primary:hover,
            .btn-secondary:hover,
            .btn-hint:hover {
                transform: none;
            }
            
            .particle,
            .firework-particle {
                display: none;
            }
        }
        
        .hidden {
            display: none !important;
        }
        
        .sound-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .sound-toggle:hover {
            transform: scale(1.1);
        }
        
        .dark .glass-panel {
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(71, 85, 105, 0.5);
        }
        
        .dark .station-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-color: #475569;
        }
        
        .dark .station-card:hover {
            border-color: #60a5fa;
            box-shadow: 0 4px 20px rgba(96, 165, 250, 0.2);
        }
        
        .dark .station-card.solved {
            background: linear-gradient(135deg, #14532d 0%, #166534 100%);
            border-color: var(--success-color);
        }
        
        .dark h1 { color: #f1f5f9; }
        .dark h2, .dark h3, .dark h4 { color: #e2e8f0; }
        .dark .text-slate-900 { color: #f1f5f9; }
        .dark .text-slate-800 { color: #e2e8f0; }
        .dark .text-slate-700 { color: #cbd5e1; }
        .dark .text-slate-600 { color: #94a3b8; }
        .dark .text-slate-500 { color: #64748b; }
        .dark .bg-slate-200 { background-color: #334155; }
        .dark .bg-slate-100, .dark .bg-slate-50, .dark .bg-white { background-color: #1e293b; }
        .dark .border-slate-200 { border-color: #475569; }
        .dark .hover\:bg-slate-300:hover { background-color: #475569; }
        .dark .hover\:bg-slate-200:hover { background-color: #334155; }
        
        .dark input[type="text"],
        .dark input[type="number"],
        .dark select,
        .dark textarea {
            background-color: #1e293b;
            border-color: #475569;
            color: #e2e8f0;
        }
        
        .dark input[type="text"]::placeholder,
        .dark input[type="number"]::placeholder {
            color: #64748b;
        }
        
        .dark input[type="text"]:focus,
        .dark input[type="number"]:focus,
        .dark select:focus {
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        
        .dark .mode-btn, .dark .difficulty-btn, .dark .leaderboard-tab, .dark .mp-mode-btn {
            background-color: #1e293b;
            border-color: #475569;
            color: #cbd5e1;
        }
        
        .dark .mode-btn:hover, .dark .difficulty-btn:hover, 
        .dark .leaderboard-tab:hover, .dark .mp-mode-btn:hover {
            background-color: #334155;
        }
        
        .dark .mode-btn.active, .dark .leaderboard-tab.active, .dark .mp-mode-btn.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            color: white;
        }
        
        .dark .difficulty-btn.active {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
        }
        
        .dark #btn-theme {
            background-color: #334155;
            color: #fbbf24;
        }
        
        .dark #btn-theme:hover { background-color: #475569; }
        
        .dark .letter-key {
            background-color: #334155;
            border-color: #475569;
            color: #e2e8f0;
        }
        
        .dark .letter-key:hover {
            background-color: #475569;
            border-color: #60a5fa;
        }
        
        .dark .letter-key.used {
            background-color: #1e293b;
            color: #64748b;
        }
        
        .dark .letter-key.found {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
        }
        
        .dark .letter-key.not-found {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: white;
        }
        
        .dark .neon-glow {
            text-shadow: 0 0 10px rgba(96, 165, 250, 0.6),
                         0 0 20px rgba(96, 165, 250, 0.4),
                         0 0 30px rgba(96, 165, 250, 0.3);
        }
        
        .dark .progress-bar {
            background: linear-gradient(90deg, var(--success-color), #4ade80);
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
        }
        
        .dark #chat-messages { background-color: #0f172a; }
        
        .dark #victory-modal > div {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #475569;
        }
        
        .dark #victory-modal h2 { color: #f1f5f9; }
        .dark #victory-modal p { color: #94a3b8; }
        .dark #victory-modal .bg-slate-100 { background-color: #0f172a; }
        .dark .tooltip::after { background: #f1f5f9; color: #1e293b; }
        
        .dark .sound-toggle {
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(71, 85, 105, 0.5);
        }
        
        .dark a { color: #60a5fa; }
        .dark a:hover { color: #93c5fd; }
        
        .dark ::-webkit-scrollbar { width: 8px; height: 8px; }
        .dark ::-webkit-scrollbar-track { background: #1e293b; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .dark .bg-green-50 { background-color: rgba(34, 197, 94, 0.1); }
        .dark .border-green-200 { border-color: rgba(34, 197, 94, 0.3); }
        .dark .text-green-700 { color: #4ade80; }
        .dark .bg-blue-100 { background-color: rgba(59, 130, 246, 0.2); }
        .dark .text-blue-700 { color: #60a5fa; }
        .dark .bg-blue-50 { background-color: rgba(59, 130, 246, 0.1); }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-blue-100 min-h-screen text-slate-800 transition-colors duration-300">

    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2" role="alert" aria-live="polite"></div>
    
    <div id="floating-scores" class="fixed inset-0 pointer-events-none z-40" aria-hidden="true"></div>
    
    <button id="sound-toggle" class="sound-toggle glass-panel shadow-lg cursor-pointer" title="切换音效" aria-label="切换音效">
        <svg id="sound-on-icon" class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
        </svg>
        <svg id="sound-off-icon" class="icon hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <line x1="23" y1="9" x2="17" y2="15"></line>
            <line x1="17" y1="9" x2="23" y2="15"></line>
        </svg>
    </button>
    
    <main class="relative z-10 container mx-auto px-4 py-6 max-w-6xl">
        <header class="text-center mb-6">
            <div class="flex justify-center items-center gap-4 mb-2">
                <h1 class="text-3xl md:text-4xl font-bold text-slate-900 neon-glow">
                    地铁站名猜谜游戏
                </h1>
                <button id="btn-theme" class="p-2 rounded-lg bg-slate-200 hover:bg-slate-300 transition-all cursor-pointer" title="切换主题 (T)" aria-label="切换主题">
                    <svg id="theme-moon-icon" class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="theme-sun-icon" class="icon hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
            <p class="text-slate-600 text-sm md:text-base">
                开字母 · 猜站名 · 挑战你的地铁知识
            </p>
        </header>
        
        <section id="game-settings" class="glass-panel rounded-2xl p-4 mb-4 shadow-lg" aria-label="游戏设置">
            <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium text-slate-700">难度:</span>
                        <div class="flex gap-2">
                            <button data-difficulty="easy" class="difficulty-btn px-3 py-1.5 rounded-lg text-sm font-medium text-slate-700 cursor-pointer">
                                简单
                            </button>
                            <button data-difficulty="normal" class="difficulty-btn active px-3 py-1.5 rounded-lg text-sm font-medium text-slate-700 cursor-pointer">
                                普通
                            </button>
                            <button data-difficulty="hard" class="difficulty-btn px-3 py-1.5 rounded-lg text-sm font-medium text-slate-700 cursor-pointer">
                                困难
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium text-slate-700">站名数:</span>
                        <input type="number" id="station-count" min="1" max="20" value="4" class="w-16 px-2 py-1.5 rounded-lg border border-slate-200 bg-white text-slate-700 text-sm text-center">
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium text-slate-700">城市:</span>
                        <select id="city-select" class="px-3 py-1.5 rounded-lg border border-slate-200 bg-white text-slate-700 text-sm cursor-pointer">
                            <option value="all">全部城市</option>
                        </select>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-center">
                        <div class="text-xs text-slate-500">计时</div>
                        <div id="timer" class="text-xl font-bold text-blue-600 timer-display">00:00</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-slate-500">得分</div>
                        <div id="score" class="text-xl font-bold text-green-600">0</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-slate-500">连击</div>
                        <div id="combo" class="text-xl font-bold text-orange-600">0</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-slate-500">提示</div>
                        <div id="hints-left" class="text-xl font-bold text-purple-600">3</div>
                    </div>
                </div>
            </div>
            
            <div class="mt-3">
                <div class="flex justify-between text-xs text-slate-500 mb-1">
                    <span>进度</span>
                    <span id="progress-text">0/0</span>
                </div>
                <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
                    <div id="progress-bar" class="progress-bar h-full rounded-full" style="width: 0%"></div>
                </div>
            </div>
            
            <div id="game-controls" class="mt-3 pt-3 border-t border-slate-200/50 text-center">
                <div class="flex items-center justify-center gap-4 text-sm">
                    <a id="btn-new-game" href="#" class="text-blue-600 hover:text-blue-700 font-medium cursor-pointer">新游戏</a>
                    <span class="text-slate-300">|</span>
                    <a id="btn-save" href="#" class="text-slate-600 hover:text-slate-800 cursor-pointer">保存</a>
                    <a id="btn-load" href="#" class="text-slate-600 hover:text-slate-800 cursor-pointer">加载</a>
                    <span class="text-slate-300">|</span>
                    <a id="btn-hint" href="#" class="text-purple-600 hover:text-purple-700 cursor-pointer">提示</a>
                    <span class="text-slate-300">|</span>
                    <span class="text-slate-500">已猜 <span id="guess-count" class="text-slate-700">0</span> 次</span>
                </div>
            </div>
        </section>
        
        <nav class="flex justify-center gap-3 mb-4 flex-wrap" aria-label="游戏模式">
            <button id="mode-normal" class="mode-btn active px-4 py-2 rounded-lg font-medium text-sm text-slate-700 cursor-pointer">
                普通模式
            </button>
            <button id="mode-multiplayer" class="mode-btn px-4 py-2 rounded-lg font-medium text-sm text-slate-700 cursor-pointer">
                联机对战
            </button>
            <button id="mode-reverse" class="mode-btn px-4 py-2 rounded-lg font-medium text-sm text-slate-700 cursor-pointer hidden">
                逆向模式
            </button>
            <button id="mode-leaderboard" class="mode-btn px-4 py-2 rounded-lg font-medium text-sm text-slate-700 cursor-pointer">
                排行榜
            </button>
        </nav>
        
        <div id="normal-mode-area" class="space-y-4">
            <div id="stations-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            </div>
            
            <div class="glass-panel rounded-2xl p-4 shadow-lg">
                <h3 class="text-sm font-semibold text-slate-700 mb-3">字母键盘 (点击或输入字母开字母)</h3>
                <div id="letter-keyboard" class="flex flex-wrap gap-1.5 justify-center">
                </div>
            </div>
            
            <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-lg">
                <div class="flex flex-col md:flex-row gap-3">
                    <input 
                        type="text" 
                        id="guess-input" 
                        placeholder="输入字母开字母，或输入站名猜测" 
                        class="flex-1 px-4 py-3 rounded-lg border border-slate-200 bg-white text-slate-800 placeholder-slate-400 input-glow focus:outline-none focus:border-blue-500 transition-all"
                        autocomplete="off"
                    >
                    <button id="btn-submit" class="btn-secondary px-6 py-3 rounded-lg text-white font-medium cursor-pointer">
                        提交
                    </button>
                </div>
                <p class="text-xs text-slate-500 mt-2">
                    在输入框输入<span class="text-blue-600 font-medium">字母</span>开字母，或输入<span class="text-orange-600 font-medium">站名</span>猜测
                    <span class="mx-2">|</span>
                    <span class="text-slate-600">也可用：开 [字母] / 猜 [站名] / 结束</span>
                </p>
            </div>
        </div>
        
        <div id="reverse-mode-area" class="space-y-4 hidden">
            <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-lg">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">逆向模式：输入提示，让系统猜测</h3>
                <div class="flex flex-col gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">输入带星号的提示（如：****e**）</label>
                        <input 
                            type="text" 
                            id="reverse-input" 
                            placeholder="输入提示，用*代表未知字母" 
                            class="w-full px-4 py-3 rounded-lg border border-slate-200 bg-white text-slate-800 placeholder-slate-400 input-glow focus:outline-none focus:border-blue-500 transition-all letter-display text-center text-lg"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">已揭开的字母（*位置不能是这些字母）</label>
                        <input 
                            type="text" 
                            id="revealed-letters-input" 
                            placeholder="输入已揭开的字母，如：abc" 
                            class="w-full px-4 py-3 rounded-lg border border-slate-200 bg-white text-slate-800 placeholder-slate-400 input-glow focus:outline-none focus:border-blue-500 transition-all text-center text-lg"
                        >
                    </div>
                    <div class="flex gap-3">
                        <button id="btn-reverse-guess" class="btn-primary px-6 py-3 rounded-lg text-white font-medium cursor-pointer">
                            系统猜测
                        </button>
                        <button id="btn-reverse-clear" class="bg-slate-500 hover:bg-slate-600 px-6 py-3 rounded-lg text-white font-medium transition-all cursor-pointer">
                            清空
                        </button>
                    </div>
                </div>
                
                <div id="reverse-results" class="mt-6 hidden">
                    <h4 class="text-sm font-medium text-slate-700 mb-3">可能的答案：</h4>
                    <div id="reverse-results-list" class="space-y-2 max-h-64 overflow-y-auto">
                    </div>
                </div>
            </div>
        </div>
        
        <div id="multiplayer-area" class="hidden">
            <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-lg">
                <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    联机对战
                </h3>
                
                <div id="mp-lobby" class="space-y-4">
                    <div class="flex gap-3 flex-wrap">
                        <button id="btn-create-room" class="btn-primary px-4 py-2 rounded-lg text-white font-medium text-sm cursor-pointer">
                            创建房间
                        </button>
                        <button id="btn-quick-match" class="btn-secondary px-4 py-2 rounded-lg text-white font-medium text-sm cursor-pointer">
                            快速匹配
                        </button>
                    </div>
                    
                    <div class="flex gap-2 items-center">
                        <input type="text" id="room-code-input" placeholder="输入房间号" maxlength="6" class="flex-1 px-4 py-2 rounded-lg border border-slate-200 bg-white text-slate-800 uppercase tracking-widest text-center font-mono text-lg">
                        <button id="btn-join-room" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg text-white font-medium text-sm transition-all cursor-pointer">
                            加入房间
                        </button>
                    </div>
                    
                    <div id="online-rooms" class="space-y-2">
                        <p class="text-slate-500 text-sm text-center">正在加载在线房间...</p>
                    </div>
                </div>
                
                <div id="mp-room" class="hidden space-y-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="text-sm text-slate-500">房间号:</span>
                            <span id="room-code-display" class="text-2xl font-bold text-blue-600 font-mono tracking-widest ml-2"></span>
                        </div>
                        <button id="btn-copy-room" class="bg-slate-200 hover:bg-slate-300 px-3 py-1.5 rounded-lg text-slate-700 text-sm cursor-pointer flex items-center gap-1">
                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            复制
                        </button>
                    </div>
                    
                    <div class="flex gap-2 flex-wrap">
                        <button id="btn-ready" class="btn-primary px-4 py-2 rounded-lg text-white font-medium text-sm cursor-pointer">
                            准备
                        </button>
                        <button id="btn-start-game" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg text-white font-medium text-sm transition-all cursor-pointer hidden">
                            开始游戏
                        </button>
                        <button id="btn-leave-room" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg text-white font-medium text-sm transition-all cursor-pointer">
                            离开房间
                        </button>
                    </div>
                    
                    <div id="room-players" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    </div>
                    
                    <div id="room-chat" class="space-y-2">
                        <div id="chat-messages" class="h-32 overflow-y-auto bg-slate-50 rounded-lg p-2 text-sm">
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="chat-input" placeholder="输入消息..." class="flex-1 px-3 py-1.5 rounded-lg border border-slate-200 bg-white text-slate-800 text-sm">
                            <button id="btn-send-chat" class="bg-blue-500 hover:bg-blue-600 px-3 py-1.5 rounded-lg text-white text-sm cursor-pointer">
                                发送
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="mp-game" class="hidden space-y-4">
                    <div class="flex justify-between items-center flex-wrap gap-2">
                        <div class="flex items-center gap-4">
                            <div class="text-center">
                                <div class="text-xs text-slate-500">计时</div>
                                <div id="mp-timer" class="text-xl font-bold text-blue-600 timer-display">00:00</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-slate-500">得分</div>
                                <div id="mp-score" class="text-xl font-bold text-green-600">0</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-slate-500">连击</div>
                                <div id="mp-combo" class="text-xl font-bold text-orange-600">0</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-slate-500">提示</div>
                                <div id="mp-hints-left" class="text-xl font-bold text-purple-600">3</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <div class="flex justify-between text-xs text-slate-500 mb-1">
                            <span>进度</span>
                            <span id="mp-progress-text">0/0</span>
                        </div>
                        <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
                            <div id="mp-progress-bar" class="progress-bar h-full rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div id="mp-players-status" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    </div>
                    
                    <div id="mp-stations-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    </div>
                    
                    <div class="glass-panel rounded-2xl p-4 shadow-lg">
                        <h3 class="text-sm font-semibold text-slate-700 mb-3">字母键盘 (点击开字母)</h3>
                        <div id="mp-keyboard" class="flex flex-wrap gap-1.5 justify-center">
                        </div>
                    </div>
                    
                    <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-lg">
                        <div class="flex flex-col md:flex-row gap-3">
                            <input 
                                type="text" 
                                id="mp-guess-input" 
                                placeholder="输入字母开字母，或输入站名猜测" 
                                class="flex-1 px-4 py-3 rounded-lg border border-slate-200 bg-white text-slate-800 placeholder-slate-400 input-glow focus:outline-none focus:border-blue-500 transition-all"
                                autocomplete="off"
                            >
                            <button id="mp-submit-btn" class="btn-secondary px-6 py-3 rounded-lg text-white font-medium cursor-pointer">
                                提交
                            </button>
                        </div>
                        <p class="text-xs text-slate-500 mt-2">
                            直接输入<span class="text-blue-600 font-medium">字母</span>开字母，或输入<span class="text-orange-600 font-medium">站名</span>猜测
                        </p>
                    </div>
                    
                    <div class="flex gap-2 justify-center flex-wrap">
                        <button id="mp-hint-btn" class="btn-hint px-4 py-2.5 rounded-lg text-white font-medium text-sm cursor-pointer">
                            提示
                        </button>
                    </div>
                    
                    <div id="mp-game-result" class="hidden glass-panel rounded-xl p-6 text-center">
                        <h3 class="text-2xl font-bold text-slate-800 mb-4 flex items-center justify-center gap-2">
                            <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                            游戏结束！
                        </h3>
                        <div id="mp-final-rankings" class="space-y-2 mb-4"></div>
                        <button id="mp-play-again" class="btn-primary px-6 py-2 rounded-lg text-white font-medium cursor-pointer">
                            再来一局
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="leaderboard-area" class="hidden">
            <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-lg">
                <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
                        <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
                        <path d="M4 22h16"></path>
                        <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>
                        <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path>
                        <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
                    </svg>
                    排行榜
                </h3>
                <div class="flex gap-2 mb-4">
                    <button data-board="easy" class="leaderboard-tab px-3 py-1.5 rounded-lg text-sm font-medium border border-slate-200 bg-white text-slate-700 cursor-pointer">简单</button>
                    <button data-board="normal" class="leaderboard-tab active px-3 py-1.5 rounded-lg text-sm font-medium bg-blue-500 text-white cursor-pointer">普通</button>
                    <button data-board="hard" class="leaderboard-tab px-3 py-1.5 rounded-lg text-sm font-medium border border-slate-200 bg-white text-slate-700 cursor-pointer">困难</button>
                </div>
                <div id="leaderboard-list" class="space-y-2">
                </div>
            </div>
            
            <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-lg mt-4">
                <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="20" x2="18" y2="10"></line>
                        <line x1="12" y1="20" x2="12" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="14"></line>
                    </svg>
                    统计数据
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="text-center p-3 bg-slate-50 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600" id="stat-games">0</div>
                        <div class="text-xs text-slate-500">游戏次数</div>
                    </div>
                    <div class="text-center p-3 bg-slate-50 rounded-lg">
                        <div class="text-2xl font-bold text-green-600" id="stat-wins">0</div>
                        <div class="text-xs text-slate-500">胜利次数</div>
                    </div>
                    <div class="text-center p-3 bg-slate-50 rounded-lg">
                        <div class="text-2xl font-bold text-orange-600" id="stat-stations">0</div>
                        <div class="text-xs text-slate-500">猜对站名</div>
                    </div>
                    <div class="text-center p-3 bg-slate-50 rounded-lg">
                        <div class="text-2xl font-bold text-purple-600" id="stat-total">0</div>
                        <div class="text-xs text-slate-500">总得分</div>
                    </div>
                </div>
            </div>
            
            <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-lg mt-4">
                <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="8" r="7"></circle>
                        <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline>
                    </svg>
                    成就
                </h3>
                <div id="achievements-list" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                </div>
            </div>
        </div>
        
        <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-lg mt-4">
            <h3 class="text-lg font-semibold text-slate-800 mb-4">猜测记录</h3>
            <div id="guess-history" class="space-y-2 max-h-48 overflow-y-auto">
                <p class="text-slate-400 text-sm italic">暂无记录</p>
            </div>
        </div>
        
        <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-lg mt-4">
            <h3 class="text-lg font-semibold text-slate-800 mb-4">游戏规则</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-slate-600">
                <div>
                    <h4 class="font-medium text-slate-800 mb-2">普通模式</h4>
                    <ul class="space-y-1 list-disc list-inside">
                        <li>系统根据难度选择对应难度的站名</li>
                        <li>简单模式：短站名、常见字母</li>
                        <li>普通模式：中等长度、适中难度</li>
                        <li>困难模式：长站名、稀有字母</li>
                        <li>可自定义站名数量（1-20个）</li>
                        <li>输入 <span class="font-mono bg-slate-100 px-1 rounded">开 [字母]</span> 揭开字母</li>
                        <li>输入 <span class="font-mono bg-slate-100 px-1 rounded">猜 [站名]</span> 猜测站名</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-medium text-slate-800 mb-2">得分规则</h4>
                    <ul class="space-y-1 list-disc list-inside">
                        <li>猜对站名: +100分</li>
                        <li>开字母猜对: -5分</li>
                        <li>开字母猜错: -15分</li>
                        <li>连击奖励: 连击数×5分</li>
                        <li>使用提示: -30分</li>
                        <li>时间奖励: 剩余时间×2分</li>
                        <li>难度加成: 简单×1, 普通×1.5, 困难×2</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <footer class="text-center mt-6 text-sm text-slate-500">
            <p>制作者：<a href="https://space.bilibili.com/1944366810" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-700 font-medium">bilibili@lvshu</a></p>
        </footer>
    </main>
    
    <div id="victory-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 md:p-8 max-w-md w-full shadow-2xl transform scale-100 transition-transform">
            <div class="text-center">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-br from-green-400 to-emerald-500 flex items-center justify-center shadow-lg">
                    <svg class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-slate-900 mb-2 font-display">恭喜获胜！</h2>
                <p class="text-slate-600 mb-4">你成功猜对了所有地铁站名！</p>
                <div class="bg-slate-100 rounded-lg p-4 mb-4">
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <div class="text-sm text-slate-500">用时</div>
                            <div id="final-time" class="text-xl font-bold text-blue-600">00:00</div>
                        </div>
                        <div>
                            <div class="text-sm text-slate-500">得分</div>
                            <div id="final-score" class="text-xl font-bold text-green-600 score-popup">0</div>
                        </div>
                        <div>
                            <div class="text-sm text-slate-500">猜测次数</div>
                            <div id="final-guesses" class="text-xl font-bold text-orange-600">0</div>
                        </div>
                        <div>
                            <div class="text-sm text-slate-500">使用提示</div>
                            <div id="final-hints" class="text-xl font-bold text-purple-600">0</div>
                        </div>
                    </div>
                </div>
                <div class="mb-4">
                    <input type="text" id="player-name" placeholder="输入你的名字" maxlength="20" class="w-full px-4 py-2 rounded-lg border border-slate-200 bg-white text-slate-800 placeholder-slate-400 focus:outline-none focus:border-blue-500">
                </div>
                <div class="flex justify-center gap-3">
                    <button id="btn-save-score" class="btn-primary px-6 py-2.5 rounded-lg text-white font-medium cursor-pointer">
                        保存成绩
                    </button>
                    <button id="btn-play-again" class="btn-secondary px-6 py-2.5 rounded-lg text-white font-medium cursor-pointer">
                        再玩一次
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const DIFFICULTY_SETTINGS = {
            easy: { stationCount: 3, hints: 5, timeBonus: 180, multiplier: 1, difficultyLevel: 'easy' },
            normal: { stationCount: 4, hints: 3, timeBonus: 300, multiplier: 1.5, difficultyLevel: 'normal' },
            hard: { stationCount: 6, hints: 2, timeBonus: 480, multiplier: 2, difficultyLevel: 'hard' }
        };

        const LETTER_FREQUENCY = {
            superCommon: ['a', 'e', 'i', 'n', 'o', 's', 'u'],
            common: ['g', 'h', 't', 'l', 'r', 'd', 'c'],
            medium: ['y', 'j', 'x', 'z', 'p', 'm', 'w', 'b'],
            rare: ['q', 'f', 'k', 'v']
        };

        const ACHIEVEMENTS = [
            { id: 'first_win', name: '初次胜利', desc: '完成第一局游戏', icon: 'trophy' },
            { id: 'speed_demon', name: '速度恶魔', desc: '60秒内完成游戏', icon: 'zap' },
            { id: 'perfect', name: '完美猜测', desc: '不使用提示完成游戏', icon: 'check-circle' },
            { id: 'explorer', name: '探索者', desc: '解锁所有城市', icon: 'map' },
            { id: 'master', name: '地铁大师', desc: '累计得分超过10000', icon: 'crown' },
            { id: 'streak_3', name: '三连胜', desc: '连续获胜3局', icon: 'flame' },
            { id: 'streak_5', name: '五连胜', desc: '连续获胜5局', icon: 'gem' },
            { id: 'collector', name: '收藏家', desc: '猜对100个站名', icon: 'target' }
        ];
        
        const ACHIEVEMENT_ICONS = {
            trophy: '<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg>',
            zap: '<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>',
            'check-circle': '<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>',
            map: '<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon><line x1="8" y1="2" x2="8" y2="18"></line><line x1="16" y1="6" x2="16" y2="22"></line></svg>',
            crown: '<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 4l3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"></path></svg>',
            flame: '<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"></path></svg>',
            gem: '<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 3h12l4 6-10 13L2 9z"></path><path d="M11 3 8 9l4 13 4-13-3-6"></path><path d="M2 9h20"></path></svg>',
            target: '<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>'
        };

        const $ = id => document.getElementById(id);
        const $all = sel => document.querySelectorAll(sel);
        const createEl = (tag, className, innerHTML) => {
            const el = document.createElement(tag);
            if (className) el.className = className;
            if (innerHTML) el.innerHTML = innerHTML;
            return el;
        };

        function calculateStationDifficulty(station) {
            const name = station.station_en.toLowerCase();
            let score = 0;
            
            const length = name.replace(/[^a-z]/g, '').length;
            if (length <= 5) score += 1;
            else if (length <= 8) score += 2;
            else if (length <= 12) score += 3;
            else score += 4;
            
            const specialChars = (name.match(/['().]/g) || []).length;
            score += specialChars * 1.5;
            
            const letters = name.replace(/[^a-z]/g, '');
            const uniqueLetters = new Set(letters.split(''));
            
            LETTER_FREQUENCY.rare.forEach(letter => {
                if (uniqueLetters.has(letter)) score += 1.5;
            });
            
            LETTER_FREQUENCY.medium.forEach(letter => {
                if (uniqueLetters.has(letter)) score += 0.5;
            });
            
            const letterCounts = {};
            letters.split('').forEach(l => letterCounts[l] = (letterCounts[l] || 0) + 1);
            const repeatCount = Object.values(letterCounts).filter(c => c > 1).length;
            score -= repeatCount * 0.2;
            
            const commonLetterCount = LETTER_FREQUENCY.common.filter(l => uniqueLetters.has(l)).length;
            score -= commonLetterCount * 0.2;
            
            const superCommonLetterCount = LETTER_FREQUENCY.superCommon.filter(l => uniqueLetters.has(l)).length;
            score -= superCommonLetterCount * 0.3;
            
            const superCommonRatio = superCommonLetterCount / uniqueLetters.size;
            if (superCommonRatio > 0.6) score -= 1;
            
            if (score <= 1.5) return 'easy';
            if (score <= 3) return 'normal';
            return 'hard';
        }

        function classifyStationsByDifficulty() {
            const classified = { easy: [], normal: [], hard: [] };
            stationDatabase.forEach(station => {
                const difficulty = calculateStationDifficulty(station);
                classified[difficulty].push({ ...station, calculatedDifficulty: difficulty });
            });
            return classified;
        }

        let gameState = {
            mode: 'normal',
            difficulty: 'normal',
            selectedCity: 'all',
            stations: [],
            revealedLetters: {},
            revealedSpecialChars: new Set(),
            solvedStations: new Set(),
            guessCount: 0,
            guessHistory: [],
            gameWon: false,
            score: 0,
            hintsUsed: 0,
            hintsLeft: 3,
            startTime: null,
            elapsedTime: 0,
            usedLetters: new Set(),
            usedSpecialChars: new Set(),
            foundLetters: new Set(),
            foundSpecialChars: new Set(),
            combo: 0,
            lastCorrectTime: 0,
            devMode: false
        };

        let stationDatabase = [];
        let timerInterval = null;
        let isDarkMode = false;
        let soundEnabled = true;
        let audioContext = null;
        let stats = {
            totalScore: 0,
            gamesPlayed: 0,
            gamesWon: 0,
            stationsSolved: 0,
            currentStreak: 0,
            bestStreak: 0,
            unlockedCities: new Set(['all']),
            achievements: new Set(),
            leaderboards: { easy: [], normal: [], hard: [] }
        };

        const elements = {
            stationsContainer: $('stations-container'),
            guessInput: $('guess-input'),
            reverseInput: $('reverse-input'),
            revealedLettersInput: $('revealed-letters-input'),
            btnSubmit: $('btn-submit'),
            btnReverseGuess: $('btn-reverse-guess'),
            btnReverseClear: $('btn-reverse-clear'),
            btnNewGame: $('btn-new-game'),
            btnSave: $('btn-save'),
            btnLoad: $('btn-load'),
            btnHint: $('btn-hint'),
            btnTheme: $('btn-theme'),
            btnPlayAgain: $('btn-play-again'),
            btnSaveScore: $('btn-save-score'),
            modeNormal: $('mode-normal'),
            modeReverse: $('mode-reverse'),
            modeLeaderboard: $('mode-leaderboard'),
            normalModeArea: $('normal-mode-area'),
            reverseModeArea: $('reverse-mode-area'),
            leaderboardArea: $('leaderboard-area'),
            gameSettings: $('game-settings'),
            reverseResults: $('reverse-results'),
            reverseResultsList: $('reverse-results-list'),
            guessHistory: $('guess-history'),
            victoryModal: $('victory-modal'),
            guessCount: $('guess-count'),
            timer: $('timer'),
            score: $('score'),
            hintsLeft: $('hints-left'),
            letterKeyboard: $('letter-keyboard'),
            citySelect: $('city-select'),
            leaderboardList: $('leaderboard-list'),
            achievementsList: $('achievements-list'),
            themeIcon: $('theme-icon'),
            playerName: $('player-name'),
            finalTime: $('final-time'),
            finalScore: $('final-score'),
            finalGuesses: $('final-guesses'),
            finalHints: $('final-hints'),
            progressBar: $('progress-bar'),
            progressText: $('progress-text'),
            combo: $('combo'),
            toastContainer: $('toast-container'),
            floatingScores: $('floating-scores'),
            soundToggle: $('sound-toggle'),
            modeMultiplayer: $('mode-multiplayer'),
            gameControls: $('game-controls'),
            multiplayerArea: $('multiplayer-area'),
            mpLobby: $('mp-lobby'),
            mpRoom: $('mp-room'),
            mpGame: $('mp-game'),
            roomCodeInput: $('room-code-input'),
            roomCodeDisplay: $('room-code-display'),
            onlineRooms: $('online-rooms'),
            roomPlayers: $('room-players'),
            chatMessages: $('chat-messages'),
            chatInput: $('chat-input')
        };

        const csvData = `city_cn,city_en,station_cn,station_en
北京,Beijing,古城,Gucheng
北京,Beijing,八宝山,Babaoshan
北京,Beijing,玉泉路,Yuquan Lu
北京,Beijing,五棵松,Wukesong
北京,Beijing,万寿路,Wanshou Lu
北京,Beijing,公主坟,Gongzhufen
北京,Beijing,军事博物馆,Military Museum
北京,Beijing,木樨地,Muxidi
北京,Beijing,南礼士路,Nanlishi Lu
北京,Beijing,复兴门,Fuxingmen
北京,Beijing,西单,Xidan
北京,Beijing,天安门西,Tian'anmenxi
北京,Beijing,天安门东,Tian'anmendong
北京,Beijing,王府井,Wangfujing
北京,Beijing,东单,Dongdan
北京,Beijing,建国门,Jianguomen
北京,Beijing,永安里,Yong'an Li
北京,Beijing,国贸,Guomao
北京,Beijing,大望路,Dawang Lu
北京,Beijing,四惠,Sihui
北京,Beijing,四惠东,Sihui Dong (E)
北京,Beijing,高碑店,Gaobeidian
北京,Beijing,传媒大学,Communication Univ. of China
北京,Beijing,双桥,Shuang Qiao
北京,Beijing,管庄,Guaanzhuang
北京,Beijing,八里桥,Bali Qiao
北京,Beijing,通州北苑,Tongzhou Beiyuan
北京,Beijing,果园,Guoyuan
北京,Beijing,九棵树,Jiukeshu
北京,Beijing,梨园,Liyuan
北京,Beijing,临河里,Linheli
北京,Beijing,土桥,Tu Qiao
北京,Beijing,花庄,Huazhuang
北京,Beijing,环球度假区,Universal Resort
北京,Beijing,西直门,Xizhimen
北京,Beijing,车公庄,Chegongzhuang
北京,Beijing,阜成门,Fucheng Men
北京,Beijing,长椿街,Changchun Jie
北京,Beijing,宣武门,Xuanwu Men
北京,Beijing,和平门,Heping Men
北京,Beijing,前门,Qianmen
北京,Beijing,崇文门,Chongwen Men
北京,Beijing,北京站,Beijing Zhan
北京,Beijing,朝阳门,Chaoyang Men
北京,Beijing,东四十条,Dongsi Shitiao
北京,Beijing,东直门,Dongzhimen
北京,Beijing,雍和宫,Yonghegong
北京,Beijing,安定门,Anding Men
北京,Beijing,鼓楼大街,Gulou Dajie
北京,Beijing,积水潭,Jishuitan
北京,Beijing,工人体育场,Workers' Stadium
北京,Beijing,团结湖,Tuanjiehu
北京,Beijing,朝阳公园,Chaoyang Park
上海,Shanghai,人民广场,People's Square
上海,Shanghai,南京东路,East Nanjing Road
上海,Shanghai,陆家嘴,Lujiazui
上海,Shanghai,豫园,Yuyuan Garden
上海,Shanghai,外滩,The Bund
上海,Shanghai,南京西路,West Nanjing Road
上海,Shanghai,静安寺,Jing'an Temple
上海,Shanghai,徐家汇,Xujiahui
上海,Shanghai,淮海中路,Middle Huaihai Road
上海,Shanghai,新天地,Xintiandi
广州,Guangzhou,体育西路,Tiyu Xilu
广州,Guangzhou,珠江新城,Zhujiang New Town
广州,Guangzhou,广州塔,Canton Tower
广州,Guangzhou,公园前,Gongyuan Qian
广州,Guangzhou,北京路,Beijing Road
广州,Guangzhou,烈士陵园,Martyrs' Park
深圳,Shenzhen,华强北,Huaqiangbei
深圳,Shenzhen,世界之窗,Window of the World
深圳,Shenzhen,欢乐谷,Happy Valley
深圳,Shenzhen,市民中心,Civic Center
深圳,Shenzhen,购物公园,Shopping Park
成都,Chengdu,春熙路,Chunxi Road
成都,Chengdu,天府广场,Tianfu Square
成都,Chengdu,宽窄巷子,Kuanzhai Alley
成都,Chengdu,锦里,Jinli
成都,Chengdu,熊猫基地,Panda Base
杭州,Hangzhou,西湖,West Lake
杭州,Hangzhou,龙翔桥,Longxiangqiao
杭州,Hangzhou,武林广场,Wulin Square
杭州,Hangzhou,钱江新城,Qianjiang New City
杭州,Hangzhou,萧山机场,Xiaoshan Airport
南京,Nanjing,新街口,Xinjiekou
南京,Nanjing,夫子庙,Confucius Temple
南京,Nanjing,玄武湖,Xuanwu Lake
南京,Nanjing,中山陵,Sun Yat-sen Mausoleum
南京,Nanjing,南京南站,Nanjing South Station`;

        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.log('Web Audio API not supported');
            }
        }

        function playSound(type) {
            if (!soundEnabled || !audioContext) return;
            
            const now = audioContext.currentTime;
            
            switch (type) {
                case 'reveal':
                    playTone(440, 0.1, 0.08, now, 880);
                    break;
                case 'correct':
                    playTone(523, 0.3, 0.12, now);
                    playTone(659, 0.3, 0.12, now + 0.1);
                    playTone(784, 0.3, 0.12, now + 0.2);
                    break;
                case 'wrong':
                    playTone(200, 0.2, 0.08, now, 100);
                    break;
                case 'victory':
                    const notes = [523, 587, 659, 698, 784, 880, 988, 1047];
                    notes.forEach((freq, i) => {
                        playTone(freq, 0.15, 0.08, now + i * 0.1);
                    });
                    break;
                case 'hint':
                    playTone(600, 0.15, 0.08, now, 400);
                    break;
                case 'combo':
                    playTone(800 + gameState.combo * 50, 0.08, 0.06, now);
                    break;
            }
        }
        
        function playTone(freq, duration, volume, startTime, endFreq = null) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(freq, startTime);
            if (endFreq) {
                oscillator.frequency.exponentialRampToValueAtTime(endFreq, startTime + duration);
            }
            
            gainNode.gain.setValueAtTime(volume, startTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
            
            oscillator.start(startTime);
            oscillator.stop(startTime + duration);
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            const soundOnIcon = $('sound-on-icon');
            const soundOffIcon = $('sound-off-icon');
            if (soundOnIcon && soundOffIcon) {
                if (soundEnabled) {
                    soundOnIcon.classList.remove('hidden');
                    soundOffIcon.classList.add('hidden');
                } else {
                    soundOnIcon.classList.add('hidden');
                    soundOffIcon.classList.remove('hidden');
                }
            }
            if (soundEnabled && !audioContext) {
                initAudio();
            }
            showToast(soundEnabled ? '音效已开启' : '音效已关闭', 'info');
        }

        function showToast(message, type = 'info') {
            requestAnimationFrame(() => {
                const toast = document.createElement('div');
                toast.className = `toast px-4 py-2 rounded-lg shadow-lg text-sm font-medium cursor-pointer ${
                    type === 'success' ? 'bg-green-500 text-white' :
                    type === 'error' ? 'bg-red-500 text-white' :
                    'bg-slate-700 text-white'
                }`;
                toast.textContent = message;
                elements.toastContainer.appendChild(toast);
                
                setTimeout(() => {
                    toast.classList.add('toast-exit');
                    setTimeout(() => toast.remove(), 250);
                }, 1800);
            });
        }

        function showFloatingScore(points, x, y) {
            requestAnimationFrame(() => {
                const scoreEl = document.createElement('div');
                scoreEl.className = 'float-score text-2xl font-bold text-green-500';
                scoreEl.textContent = `+${points}`;
                scoreEl.style.left = `${x}px`;
                scoreEl.style.top = `${y}px`;
                elements.floatingScores.appendChild(scoreEl);
                
                setTimeout(() => scoreEl.remove(), 800);
            });
        }

        const particlePool = [];
        const MAX_PARTICLES = 20;
        
        function getParticle() {
            return particlePool.pop() || document.createElement('div');
        }
        
        function returnParticle(particle) {
            if (particlePool.length < MAX_PARTICLES) {
                particle.className = '';
                particle.style.cssText = '';
                particlePool.push(particle);
            } else {
                particle.remove();
            }
        }

        function createParticles(x, y, count = 5) {
            const colors = ['#22c55e', '#3b82f6', '#f97316'];
            const reducedCount = Math.min(count, 4);
            
            requestAnimationFrame(() => {
                for (let i = 0; i < reducedCount; i++) {
                    const particle = getParticle();
                    particle.className = 'particle';
                    particle.style.left = `${x + (Math.random() - 0.5) * 50}px`;
                    particle.style.top = `${y}px`;
                    particle.style.width = `${Math.random() * 5 + 3}px`;
                    particle.style.height = particle.style.width;
                    particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    particle.style.borderRadius = '50%';
                    document.body.appendChild(particle);
                    
                    setTimeout(() => {
                        particle.remove();
                        returnParticle(particle);
                    }, 600);
                }
            });
        }

        function createFireworks() {
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00'];
            
            requestAnimationFrame(() => {
                for (let f = 0; f < 2; f++) {
                    setTimeout(() => {
                        const x = Math.random() * window.innerWidth;
                        const y = Math.random() * window.innerHeight * 0.5;
                        
                        for (let i = 0; i < 10; i++) {
                            const particle = getParticle();
                            particle.className = 'firework-particle';
                            particle.style.left = `${x}px`;
                            particle.style.top = `${y}px`;
                            particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                            
                            const angle = (i / 10) * Math.PI * 2;
                            const distance = 35 + Math.random() * 50;
                            const endX = Math.cos(angle) * distance;
                            const endY = Math.sin(angle) * distance;
                            
                            particle.style.setProperty('--end-pos', `translate(${endX}px, ${endY}px)`);
                            
                            const firework = document.createElement('div');
                            firework.className = 'firework';
                            firework.style.left = '0';
                            firework.style.top = '0';
                            firework.appendChild(particle);
                            document.body.appendChild(firework);
                            
                            setTimeout(() => {
                                firework.remove();
                                returnParticle(particle);
                            }, 700);
                        }
                    }, f * 180);
                }
            });
        }

        function parseCSV(data) {
            const lines = data.trim().split('\n');
            const result = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (const char of line) {
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());
                
                if (values.length >= 4) {
                    result.push({
                        city_cn: values[0],
                        city_en: values[1],
                        station_cn: values[2],
                        station_en: values[3]
                    });
                }
            }
            return result;
        }

        

        function decryptData(encryptedBase64, key) {
            const encrypted = Uint8Array.from(atob(encryptedBase64), c => c.charCodeAt(0));
            const keyBytes = new TextEncoder().encode(key);
            const decrypted = new Uint8Array(encrypted.length);
            for (let i = 0; i < encrypted.length; i++) {
                decrypted[i] = encrypted[i] ^ keyBytes[i % keyBytes.length];
            }
            return new TextDecoder().decode(decrypted);
        }

        function loadEncryptedData() {
            try {
                const decrypted = decryptData(ENCRYPTED_DATA, DECRYPT_KEY);
                const parsed = parseCSV(decrypted);
                if (parsed.length > 0) {
                    stationDatabase = parsed;
                    console.log(`Loaded ${parsed.length} stations from encrypted data`);
                    updateCitySelect();
                }
            } catch (e) {
                console.log('Failed to decrypt data:', e);
            }
        }

        async function loadCSVFromFile() {
            loadEncryptedData();
        }

        function updateCitySelect() {
            const cities = [...new Set(stationDatabase.map(s => s.city_cn))].sort();
            elements.citySelect.innerHTML = '<option value="all">全部城市</option>';
            cities.forEach(city => {
                elements.citySelect.appendChild(createEl('option')).textContent = city;
                elements.citySelect.lastChild.value = city;
            });
        }

        function loadStats() {
            const saved = localStorage.getItem('subwayGameStats');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    stats = {
                        ...stats,
                        ...parsed,
                        unlockedCities: new Set(parsed.unlockedCities || ['all']),
                        achievements: new Set(parsed.achievements || []),
                        leaderboards: parsed.leaderboards || { easy: [], normal: [], hard: [] }
                    };
                } catch (e) {
                    console.error('Failed to load stats:', e);
                }
            }
        }

        function saveStats() {
            const toSave = {
                ...stats,
                unlockedCities: Array.from(stats.unlockedCities),
                achievements: Array.from(stats.achievements)
            };
            localStorage.setItem('subwayGameStats', JSON.stringify(toSave));
        }

        async function syncToCloud() {
            if (!mpState.connected || !db) {
                showToast('请先连接网络', 'error');
                return;
            }

            try {
                const userRef = db.ref('users/' + mpState.playerId);
                const toSync = {
                    ...stats,
                    unlockedCities: Array.from(stats.unlockedCities),
                    achievements: Array.from(stats.achievements),
                    lastSync: Date.now()
                };
                
                await userRef.set(toSync);
                showToast('数据已同步到云端！', 'success');
            } catch (e) {
                console.error('Cloud sync failed:', e);
                showToast('同步失败: ' + e.message, 'error');
            }
        }

        async function loadFromCloud() {
            if (!mpState.connected || !db) {
                showToast('请先连接网络', 'error');
                return;
            }

            try {
                const userRef = db.ref('users/' + mpState.playerId);
                const snapshot = await userRef.once('value');
                
                if (snapshot.exists()) {
                    const cloudData = snapshot.val();
                    
                    const mergedLeaderboards = {
                        easy: mergeLeaderboardArrays(stats.leaderboards.easy, cloudData.leaderboards?.easy || []),
                        normal: mergeLeaderboardArrays(stats.leaderboards.normal, cloudData.leaderboards?.normal || []),
                        hard: mergeLeaderboardArrays(stats.leaderboards.hard, cloudData.leaderboards?.hard || [])
                    };
                    
                    stats = {
                        gamesPlayed: Math.max(stats.gamesPlayed, cloudData.gamesPlayed || 0),
                        gamesWon: Math.max(stats.gamesWon, cloudData.gamesWon || 0),
                        stationsSolved: Math.max(stats.stationsSolved, cloudData.stationsSolved || 0),
                        totalScore: Math.max(stats.totalScore, cloudData.totalScore || 0),
                        currentStreak: cloudData.currentStreak || stats.currentStreak,
                        bestStreak: Math.max(stats.bestStreak, cloudData.bestStreak || 0),
                        unlockedCities: new Set([...stats.unlockedCities, ...(cloudData.unlockedCities || ['all'])]),
                        achievements: new Set([...stats.achievements, ...(cloudData.achievements || [])]),
                        leaderboards: mergedLeaderboards
                    };
                    
                    saveStats();
                    updateStatsDisplay();
                    renderLeaderboard(gameState.difficulty);
                    showToast('云端数据已加载！', 'success');
                } else {
                    showToast('云端暂无数据', 'info');
                }
            } catch (e) {
                console.error('Load from cloud failed:', e);
                showToast('加载失败: ' + e.message, 'error');
            }
        }

        function mergeLeaderboardArrays(local, cloud) {
            const merged = [...local];
            cloud.forEach(entry => {
                const exists = merged.find(e => 
                    e.stationName === entry.stationName && 
                    e.date === entry.date &&
                    e.score === entry.score
                );
                if (!exists) {
                    merged.push(entry);
                }
            });
            merged.sort((a, b) => b.score - a.score);
            return merged.slice(0, 10);
        }

        async function handleCloudSync() {
            await loadFromCloud();
            await syncToCloud();
        }

        function updateStatsDisplay() {
            document.getElementById('stat-games').textContent = stats.gamesPlayed;
            document.getElementById('stat-wins').textContent = stats.gamesWon;
            document.getElementById('stat-stations').textContent = stats.stationsSolved;
            document.getElementById('stat-total').textContent = stats.totalScore;
        }

        // ========== 联机模块 ==========
        const MULTIPLAYER_CONFIG = {
            apiKey: "AIzaSyDPs3vZRgXUCEYJ6qWJc69YYKVfRfj8PuM",
            authDomain: "metroguess-lvshu.firebaseapp.com",
            databaseURL: "https://metroguess-lvshu-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "metroguess-lvshu",
            storageBucket: "metroguess-lvshu.firebasestorage.app",
            messagingSenderId: "331461414999",
            appId: "1:331461414999:web:50beeb73a94ca4ba971312",
            measurementId: "G-YWSMLL0YNC"
        };

        let mpState = {
            connected: false,
            playerId: null,
            playerName: '玩家' + Math.random().toString(36).substr(2, 4).toUpperCase(),
            roomId: null,
            isHost: false,
            isReady: false,
            gameStarted: false
        };

        let db = null;
        let roomRef = null;
        let playersRef = null;
        let chatRef = null;
        let leaderboardRef = null;
        let cloudLeaderboards = { easy: [], normal: [], hard: [] };

        function initFirebase() {
            try {
                if (typeof firebase !== 'undefined') {
                    if (!firebase.apps.length) {
                        firebase.initializeApp(MULTIPLAYER_CONFIG);
                    }
                    db = firebase.database();
                    mpState.connected = true;
                    mpState.playerId = localStorage.getItem('mp_player_id') || generatePlayerId();
                    localStorage.setItem('mp_player_id', mpState.playerId);
                    console.log('Firebase initialized successfully');
                    loadOnlineRooms();
                    initLeaderboardListener();
                } else {
                    console.log('Firebase SDK not loaded');
                }
            } catch (e) {
                console.log('Firebase init failed, running in offline mode:', e);
            }
        }

        function initLeaderboardListener() {
            if (!db) return;
            
            leaderboardRef = db.ref('leaderboards');
            leaderboardRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    cloudLeaderboards = {
                        easy: data.easy ? Object.values(data.easy).sort((a, b) => b.score - a.score).slice(0, 10) : [],
                        normal: data.normal ? Object.values(data.normal).sort((a, b) => b.score - a.score).slice(0, 10) : [],
                        hard: data.hard ? Object.values(data.hard).sort((a, b) => b.score - a.score).slice(0, 10) : []
                    };
                    if (elements.leaderboardArea && !elements.leaderboardArea.classList.contains('hidden')) {
                        renderLeaderboard(gameState.difficulty);
                    }
                }
            });
        }

        function generatePlayerId() {
            return 'p_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        function generateRoomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        async function createRoom() {
            console.log('createRoom called, connected:', mpState.connected);
            
            if (!mpState.connected) {
                showToast('正在连接服务器...', 'info');
                initFirebase();
                await new Promise(resolve => setTimeout(resolve, 1000));
                if (!mpState.connected) {
                    showToast('连接失败，请检查网络', 'error');
                    return;
                }
            }

            try {
                const roomCode = generateRoomCode();
                mpState.roomId = roomCode;
                mpState.isHost = true;

                roomRef = db.ref('rooms/' + roomCode);
                
                await roomRef.set({
                    host: mpState.playerId,
                    status: 'waiting',
                    createdAt: Date.now(),
                    settings: {
                        difficulty: gameState.difficulty,
                        stationCount: parseInt(document.getElementById('station-count').value) || 5
                    }
                });

                playersRef = roomRef.child('players/' + mpState.playerId);
                await playersRef.set({
                    name: mpState.playerName,
                    score: 0,
                    isReady: true,
                    isHost: true,
                    joinedAt: Date.now()
                });

                setupRoomListeners();
                showRoomUI(roomCode);
                showToast('房间已创建: ' + roomCode, 'success');
            } catch (e) {
                console.error('createRoom error:', e);
                showToast('创建房间失败: ' + e.message, 'error');
            }
        }

        async function joinRoom(roomCode) {
            if (!mpState.connected) {
                showToast('请先连接网络', 'error');
                return;
            }

            roomCode = roomCode.toUpperCase().trim();
            if (roomCode.length !== 6) {
                showToast('房间号格式错误', 'error');
                return;
            }

            roomRef = db.ref('rooms/' + roomCode);
            
            const snapshot = await roomRef.once('value');
            if (!snapshot.exists()) {
                showToast('房间不存在', 'error');
                return;
            }

            const roomData = snapshot.val();
            if (roomData.status !== 'waiting') {
                showToast('游戏已开始', 'error');
                return;
            }

            mpState.roomId = roomCode;
            mpState.isHost = false;

            playersRef = roomRef.child('players/' + mpState.playerId);
            await playersRef.set({
                name: mpState.playerName,
                score: 0,
                isReady: false,
                isHost: false,
                joinedAt: Date.now()
            });

            setupRoomListeners();
            showRoomUI(roomCode);
            showToast('已加入房间', 'success');
        }

        function setupRoomListeners() {
            if (!roomRef) return;

            roomRef.child('players').on('value', debounce((snapshot) => {
                const players = snapshot.val() || {};
                renderRoomPlayers(players);
            }, 100));

            roomRef.child('status').on('value', (snapshot) => {
                const status = snapshot.val();
                if (status === 'playing') {
                    startMultiplayerGame();
                }
            });

            chatRef = roomRef.child('chat');
            chatRef.limitToLast(50).on('child_added', (snapshot) => {
                const msg = snapshot.val();
                addChatMessage(msg.name, msg.text, msg.time);
            });
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function renderRoomPlayers(players) {
            elements.roomPlayers.innerHTML = '';
            Object.entries(players).forEach(([id, player]) => {
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg border ${player.isReady ? 'bg-green-50 border-green-200' : 'bg-slate-50 border-slate-200'}`;
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="font-medium ${id === mpState.playerId ? 'text-blue-600' : 'text-slate-800'}">${player.name}</span>
                        ${player.isHost ? '<span class="text-xs bg-yellow-100 text-yellow-700 px-1 rounded">房主</span>' : ''}
                    </div>
                    <div class="text-xs ${player.isReady ? 'text-green-600' : 'text-slate-500'}">
                        ${player.isReady ? '✓ 已准备' : '等待中...'}
                    </div>
                `;
                elements.roomPlayers.appendChild(div);
            });
        }

        function addChatMessage(name, text, time) {
            const div = document.createElement('div');
            div.className = 'text-sm';
            div.innerHTML = `<span class="font-medium text-blue-600">${name}:</span> <span class="text-slate-700">${text}</span>`;
            elements.chatMessages.appendChild(div);
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
        }

        async function sendChatMessage() {
            const text = elements.chatInput.value.trim();
            if (!text || !chatRef) return;
            
            await chatRef.push({
                name: mpState.playerName,
                text: text,
                time: Date.now()
            });
            elements.chatInput.value = '';
        }

        async function toggleReady() {
            if (!playersRef) return;
            mpState.isReady = !mpState.isReady;
            await playersRef.child('isReady').set(mpState.isReady);
            
            document.getElementById('btn-ready').textContent = mpState.isReady ? '取消准备' : '准备';
            document.getElementById('btn-ready').className = mpState.isReady 
                ? 'bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded-lg text-white font-medium text-sm cursor-pointer'
                : 'btn-primary px-4 py-2 rounded-lg text-white font-medium text-sm cursor-pointer';

            updateStartButton();
        }

        function updateStartButton() {
            const startBtn = document.getElementById('btn-start-game');
            if (mpState.isHost && mpState.isReady) {
                startBtn.classList.remove('hidden');
            } else {
                startBtn.classList.add('hidden');
            }
        }

        async function startGame() {
            if (!roomRef || !mpState.isHost) return;
            await roomRef.child('status').set('playing');
        }

        async function checkAllReady() {
            if (!roomRef) return;
            const snapshot = await roomRef.child('players').once('value');
            const players = snapshot.val() || {};
            const allReady = Object.values(players).every(p => p.isReady);
            const playerCount = Object.keys(players).length;

            if (allReady && playerCount >= 1) {
                updateStartButton();
            }
        }

        async function leaveRoom() {
            if (playersRef) {
                await playersRef.remove();
            }
            if (mpState.isHost && roomRef) {
                await roomRef.remove();
            }
            cleanupRoom();
            showLobbyUI();
            showToast('已离开房间', 'info');
        }

        function cleanupRoom() {
            if (roomRef) {
                roomRef.child('players').off();
                roomRef.child('status').off();
                if (chatRef) chatRef.off();
            }
            roomRef = null;
            playersRef = null;
            chatRef = null;
            mpState.roomId = null;
            mpState.isHost = false;
            mpState.isReady = false;
        }

        function showRoomUI(roomCode) {
            elements.mpLobby.classList.add('hidden');
            elements.mpRoom.classList.remove('hidden');
            elements.roomCodeDisplay.textContent = roomCode;
            elements.chatMessages.innerHTML = '';
        }

        function showLobbyUI() {
            elements.mpLobby.classList.remove('hidden');
            elements.mpRoom.classList.add('hidden');
            elements.mpGame.classList.add('hidden');
        }

        const ROOM_EXPIRE_TIME = 2 * 60 * 60 * 1000;

        async function cleanupExpiredRooms() {
            if (!db) return;
            
            try {
                const roomsRef = db.ref('rooms');
                const snapshot = await roomsRef.once('value');
                const rooms = snapshot.val() || {};
                const now = Date.now();
                const expiredRooms = [];

                for (const [roomCode, roomData] of Object.entries(rooms)) {
                    const createdAt = roomData.createdAt || 0;
                    
                    if (now - createdAt > ROOM_EXPIRE_TIME) {
                        expiredRooms.push(roomCode);
                    }
                }

                if (expiredRooms.length > 0) {
                    const deletePromises = expiredRooms.map(code => 
                        db.ref('rooms/' + code).remove()
                    );
                    await Promise.all(deletePromises);
                    console.log(`已清理 ${expiredRooms.length} 个过期房间:`, expiredRooms);
                }
            } catch (e) {
                console.error('清理过期房间失败:', e);
            }
        }

        async function loadOnlineRooms() {
            if (!db) return;
            
            await cleanupExpiredRooms();
            
            const roomsRef = db.ref('rooms');
            roomsRef.orderByChild('status').equalTo('waiting').limitToLast(10).on('value', (snapshot) => {
                const rooms = snapshot.val() || {};
                renderOnlineRooms(rooms);
            });
        }

        function renderOnlineRooms(rooms) {
            elements.onlineRooms.innerHTML = '';
            
            if (Object.keys(rooms).length === 0) {
                elements.onlineRooms.innerHTML = '<p class="text-slate-500 text-sm text-center">暂无在线房间</p>';
                return;
            }

            Object.entries(rooms).forEach(([code, room]) => {
                const playerCount = room.players ? Object.keys(room.players).length : 0;
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-slate-50 rounded-lg hover:bg-slate-100 cursor-pointer transition-all';
                div.innerHTML = `
                    <div>
                        <span class="font-mono font-bold text-blue-600">${code}</span>
                        <span class="text-xs text-slate-500 ml-2">${room.settings?.difficulty || '普通'} · ${playerCount}人</span>
                    </div>
                    <button class="join-room-btn bg-green-500 hover:bg-green-600 px-3 py-1 rounded text-white text-sm cursor-pointer" data-room="${code}">
                        加入
                    </button>
                `;
                elements.onlineRooms.appendChild(div);
            });

            document.querySelectorAll('.join-room-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    joinRoom(btn.dataset.room);
                });
            });
        }

        function startMultiplayerGame() {
            elements.mpLobby.classList.add('hidden');
            elements.mpRoom.classList.add('hidden');
            elements.mpGame.classList.remove('hidden');
            mpState.gameStarted = true;
            
            // 初始化游戏状态 - 与主游戏相同
            mpState.revealedLetters = {};
            mpState.revealedSpecialChars = new Set();
            mpState.solvedStations = new Set();
            mpState.mpHintsUsed = 0;
            mpState.mpHintsLeft = DIFFICULTY_SETTINGS[gameState.difficulty]?.hints || 3;
            mpState.usedLetters = new Set();
            mpState.usedSpecialChars = new Set();
            mpState.foundLetters = new Set();
            mpState.foundSpecialChars = new Set();
            mpState.score = 0;
            mpState.combo = 0;
            mpState.lastCorrectTime = 0;
            mpState.guessCount = 0;
            
            if (mpState.isHost) {
                initMultiplayerGame();
            }
            
            setupGameListeners();
            showToast('游戏开始！', 'success');
        }

        async function initMultiplayerGame() {
            if (!roomRef) return;
            
            const settings = DIFFICULTY_SETTINGS[gameState.difficulty];
            const stationCount = parseInt(document.getElementById('station-count').value) || 4;
            
            const classified = classifyStationsByDifficulty();
            const targetDifficulty = settings.difficultyLevel;
            let pool = classified[targetDifficulty];
            
            if (gameState.selectedCity !== 'all') {
                pool = pool.filter(s => s.city_cn === gameState.selectedCity);
            }
            
            pool = pool.map(s => ({
                ...s,
                calculatedDifficulty: targetDifficulty
            }));
            
            const shuffled = [...pool].sort(() => Math.random() - 0.5);
            const selected = shuffled.slice(0, stationCount);
            
            // 为每个站名初始化揭示字母集合
            const revealedLettersInit = {};
            selected.forEach((_, index) => {
                revealedLettersInit[index] = [];
            });
            
            const gameData = {
                stations: selected,
                stationCount: stationCount,
                startedAt: Date.now(),
                status: 'playing',
                difficulty: gameState.difficulty,
                selectedCity: gameState.selectedCity,
                revealedLetters: revealedLettersInit,
                revealedSpecialChars: [],
                solvedStations: [],
                usedLetters: [],
                foundLetters: []
            };
            
            await roomRef.child('game').set(gameData);
        }

        function setupGameListeners() {
            if (!roomRef) return;
            
            roomRef.child('game').on('value', (snapshot) => {
                const gameData = snapshot.val();
                if (!gameData) return;
                
                mpState.gameData = gameData;
                
                // 从服务器同步状态
                if (gameData.revealedLetters) {
                    mpState.revealedLetters = {};
                    Object.entries(gameData.revealedLetters).forEach(([index, letters]) => {
                        mpState.revealedLetters[index] = new Set(letters);
                    });
                }
                if (gameData.revealedSpecialChars) {
                    mpState.revealedSpecialChars = new Set(gameData.revealedSpecialChars);
                }
                if (gameData.solvedStations) {
                    mpState.solvedStations = new Set(gameData.solvedStations);
                }
                if (gameData.usedLetters) {
                    mpState.usedLetters = new Set(gameData.usedLetters);
                }
                if (gameData.foundLetters) {
                    mpState.foundLetters = new Set(gameData.foundLetters);
                }
                
                renderMultiplayerGame(gameData);
            });
            
            roomRef.child('players').on('value', (snapshot) => {
                const players = snapshot.val() || {};
                renderPlayersStatus(players);
            });
        }

        function renderMultiplayerGame(gameData) {
            if (!gameData.stations) return;
            
            // 检查游戏是否结束
            const solvedCount = mpState.solvedStations ? mpState.solvedStations.size : 0;
            const totalStations = gameData.stationCount || gameData.stations.length;
            
            if (solvedCount >= totalStations) {
                showGameResult();
                return;
            }
            
            renderMpStations(gameData);
            
            // 渲染键盘
            renderMpKeyboard();
            
            // 更新进度
            updateMpProgress();
            
            // 更新分数显示
            updateMpScoreDisplay();
            
            // 更新提示次数
            document.getElementById('mp-hints-left').textContent = mpState.mpHintsLeft || 3;
            
            // 更新连击显示
            document.getElementById('mp-combo').textContent = mpState.combo || 0;
        }
        
        function renderMpStations(gameData) {
            const container = document.getElementById('mp-stations-container');
            container.innerHTML = '';
            
            gameData.stations.forEach((station, index) => {
                const isSolved = mpState.solvedStations && mpState.solvedStations.has(index);
                const revealed = mpState.revealedLetters && mpState.revealedLetters[index] ? mpState.revealedLetters[index] : new Set();
                const displayText = getMpDisplayText(station.station_en, revealed, isSolved, mpState.revealedSpecialChars);
                const difficulty = station.calculatedDifficulty || calculateStationDifficulty(station);
                const difficultyLabel = difficulty === 'easy' ? '简单' : difficulty === 'normal' ? '普通' : '困难';
                const difficultyColor = difficulty === 'easy' ? 'bg-green-100 text-green-700' : 
                                       difficulty === 'normal' ? 'bg-yellow-100 text-yellow-700' : 
                                       'bg-red-100 text-red-700';
                
                const card = document.createElement('div');
                card.className = `station-card rounded-xl p-4 ${isSolved ? 'solved' : ''}`;
                card.id = `mp-station-${index}`;
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs font-medium text-slate-500">#${index + 1}</span>
                        <div class="flex items-center gap-2">
                            <span class="text-xs px-2 py-0.5 rounded ${difficultyColor}">${difficultyLabel}</span>
                            ${isSolved ? '<span class="text-green-600 text-sm font-medium">✓ 已解开</span>' : ''}
                        </div>
                    </div>
                    <div class="letter-display text-lg md:text-xl font-bold text-slate-800 mb-3 text-center py-2 bg-white/50 rounded-lg dark:bg-slate-700/50 dark:text-slate-200">
                        ${displayText}
                    </div>
                    ${isSolved ? `
                        <div class="text-center text-sm">
                            <p class="text-slate-800 font-medium dark:text-slate-200">${station.station_cn}</p>
                            <p class="text-slate-500 text-xs">${station.city_cn} · ${station.city_en}</p>
                        </div>
                    ` : ''}
                `;
                container.appendChild(card);
            });
        }
        
        function getMpDisplayText(stationName, revealedLetters, isSolved, revealedSpecialChars) {
            if (isSolved) {
                return stationName;
            }
            
            return stationName.split('').map(char => {
                const lowerChar = char.toLowerCase();
                if (/[a-z]/.test(lowerChar)) {
                    if (revealedLetters && revealedLetters.has(lowerChar)) {
                        return `<span class="letter-reveal text-blue-600">${char}</span>`;
                    }
                    return '*';
                }
                if (char === ' ') {
                    return ' ';
                }
                if (revealedSpecialChars && revealedSpecialChars.has(char)) {
                    return `<span class="letter-reveal text-blue-600">${char}</span>`;
                }
                return '*';
            }).join('');
        }
        
        function updateMpProgress() {
            const solvedCount = mpState.solvedStations ? mpState.solvedStations.size : 0;
            const totalStations = mpState.gameData ? (mpState.gameData.stationCount || mpState.gameData.stations.length) : 0;
            
            document.getElementById('mp-progress-text').textContent = `${solvedCount}/${totalStations}`;
            const percentage = totalStations > 0 ? (solvedCount / totalStations) * 100 : 0;
            document.getElementById('mp-progress-bar').style.width = `${percentage}%`;
        }
        
        function renderMpKeyboard() {
            const keyboard = document.getElementById('mp-keyboard');
            keyboard.innerHTML = '';
            const letters = 'abcdefghijklmnopqrstuvwxyz'.split('');
            
            letters.forEach(letter => {
                const btn = document.createElement('button');
                const isUsed = mpState.usedLetters && mpState.usedLetters.has(letter);
                const isFound = mpState.foundLetters && mpState.foundLetters.has(letter);
                
                btn.className = `letter-key w-8 h-8 rounded text-sm font-medium cursor-pointer ${
                    isFound ? 'found' : isUsed ? 'not-found used' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'
                }`;
                btn.textContent = letter.toUpperCase();
                btn.disabled = isUsed;
                btn.dataset.letter = letter;
                
                if (!isUsed) {
                    btn.addEventListener('click', () => revealMpLetter(letter));
                }
                
                keyboard.appendChild(btn);
            });
        }
        
        async function revealMpLetter(letter) {
            if (!mpState.gameData || !mpState.gameData.stations) return;
            
            if (mpState.usedLetters && mpState.usedLetters.has(letter)) {
                showToast('该字母已使用', 'error');
                return;
            }
            
            mpState.usedLetters = mpState.usedLetters || new Set();
            mpState.foundLetters = mpState.foundLetters || new Set();
            mpState.revealedLetters = mpState.revealedLetters || {};
            mpState.solvedStations = mpState.solvedStations || new Set();
            mpState.score = mpState.score || 0;
            
            mpState.usedLetters.add(letter);
            let found = false;
            let matchCount = 0;
            
            // 遍历所有未解开的站名
            mpState.gameData.stations.forEach((station, index) => {
                if (mpState.solvedStations.has(index)) return;
                
                const stationLower = station.station_en.toLowerCase();
                if (stationLower.includes(letter)) {
                    found = true;
                    matchCount++;
                    
                    // 初始化该站名的揭示字母集合
                    if (!mpState.revealedLetters[index]) {
                        mpState.revealedLetters[index] = new Set();
                    }
                    mpState.revealedLetters[index].add(letter);
                }
            });
            
            if (found) {
                mpState.foundLetters.add(letter);
                mpState.score = Math.max(0, mpState.score - 5);
                playSound('reveal');
                showToast(`开 ${letter.toUpperCase()} - 在 ${matchCount} 个站名中找到 (-5分)`, 'success');
            } else {
                mpState.score = Math.max(0, mpState.score - 15);
                playSound('wrong');
                showToast(`开 ${letter.toUpperCase()} - 未找到 (-15分)`, 'error');
            }
            
            // 同步到服务器
            await syncMpGameState();
            
            renderMultiplayerGame(mpState.gameData);
        }
        
        async function syncMpGameState() {
            if (!roomRef || !playersRef) return;
            
            // 将 Set 转换为数组以便存储到 Firebase
            const revealedLettersData = {};
            Object.entries(mpState.revealedLetters).forEach(([index, set]) => {
                revealedLettersData[index] = Array.from(set);
            });
            
            await roomRef.child('game').update({
                revealedLetters: revealedLettersData,
                revealedSpecialChars: Array.from(mpState.revealedSpecialChars || []),
                solvedStations: Array.from(mpState.solvedStations || []),
                usedLetters: Array.from(mpState.usedLetters || []),
                foundLetters: Array.from(mpState.foundLetters || [])
            });
            
            await playersRef.update({ score: mpState.score || 0 });
        }
        
        function updateMpScoreDisplay() {
            const scoreEl = document.getElementById('mp-score');
            if (scoreEl) {
                scoreEl.textContent = mpState.score || 0;
            }
        }

        function renderPlayersStatus(players) {
            const container = document.getElementById('mp-players-status');
            container.innerHTML = '';
            
            const sortedPlayers = Object.entries(players).sort((a, b) => b[1].score - a[1].score);
            
            sortedPlayers.forEach(([id, player], index) => {
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg border ${id === mpState.playerId ? 'bg-blue-50 border-blue-200' : 'bg-slate-50 border-slate-200'}`;
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="font-medium ${id === mpState.playerId ? 'text-blue-600' : 'text-slate-800'}">
                            ${index === 0 ? '👑' : ''} ${player.name}
                        </span>
                        ${player.currentStationSolved ? '<span class="text-green-500">✓</span>' : ''}
                    </div>
                    <div class="text-lg font-bold text-blue-600">${player.score || 0} 分</div>
                `;
                container.appendChild(div);
            });
        }

        async function submitMpGuess() {
            const input = document.getElementById('mp-guess-input');
            const guess = input.value.trim();
            if (!guess || !mpState.gameData) return;
            
            mpState.guessCount = (mpState.guessCount || 0) + 1;
            
            // 支持输入字母或站名
            if (guess.length === 1 && /[a-z]/i.test(guess)) {
                // 输入单个字母，开字母
                input.value = '';
                await revealMpLetter(guess.toLowerCase());
                return;
            }
            
            // 查找匹配的站名
            let correct = false;
            let matchedStation = null;
            let matchedIndex = -1;
            const guessLower = guess.toLowerCase();
            
            mpState.gameData.stations.forEach((station, index) => {
                if (mpState.solvedStations && mpState.solvedStations.has(index)) return;
                
                const stationCn = station.station_cn.toLowerCase();
                const stationEn = station.station_en.toLowerCase();
                
                if (guessLower === stationCn || guessLower === stationEn) {
                    correct = true;
                    matchedIndex = index;
                    matchedStation = station;
                }
            });
            
            input.value = '';
            
            if (correct && matchedIndex !== -1) {
                mpState.solvedStations = mpState.solvedStations || new Set();
                mpState.solvedStations.add(matchedIndex);
                
                // 计算combo
                const now = Date.now();
                if (now - (mpState.lastCorrectTime || 0) < 5000) {
                    mpState.combo = (mpState.combo || 0) + 1;
                    playSound('combo');
                } else {
                    mpState.combo = 1;
                }
                mpState.lastCorrectTime = now;
                
                // 计算得分：基础分 + combo加成
                const comboBonus = mpState.combo * 5;
                const totalScore = 100 + comboBonus;
                mpState.score = (mpState.score || 0) + totalScore;
                
                playSound('correct');
                showToast(`猜 ${guess} - 正确！${matchedStation.city_cn} · ${matchedStation.station_cn} (+${totalScore}分)`, 'success');
                
                // 同步到服务器
                await syncMpGameState();
                
                // 检查是否全部猜对
                const solvedCount = mpState.solvedStations.size;
                const totalStations = mpState.gameData.stationCount || mpState.gameData.stations.length;
                
                if (solvedCount >= totalStations) {
                    // 游戏结束
                    setTimeout(() => showGameResult(), 500);
                }
                
                renderMultiplayerGame(mpState.gameData);
            } else {
                mpState.combo = 0;
                playSound('wrong');
                showToast(`猜 ${guess} - 不正确`, 'error');
            }
        }

        async function useMpHint() {
            if (!mpState.gameData) return;
            
            mpState.mpHintsLeft = mpState.mpHintsLeft || 3;
            if (mpState.mpHintsLeft <= 0) {
                showToast('提示次数已用完', 'error');
                return;
            }
            
            // 找出未解开的站名
            const unsolvedIndices = mpState.gameData.stations
                .map((_, index) => index)
                .filter(index => !mpState.solvedStations || !mpState.solvedStations.has(index));
            
            if (unsolvedIndices.length === 0) {
                showToast('所有站名已解开', 'info');
                return;
            }
            
            // 随机选择一个未解开的站名
            const randomIndex = unsolvedIndices[Math.floor(Math.random() * unsolvedIndices.length)];
            const station = mpState.gameData.stations[randomIndex];
            const stationLower = station.station_en.toLowerCase();
            
            // 找出该站名中未揭示的字母
            mpState.revealedLetters = mpState.revealedLetters || {};
            const revealedSet = mpState.revealedLetters[randomIndex] || new Set();
            
            const unrevealedLetters = stationLower
                .split('')
                .filter(char => /[a-z]/.test(char) && !revealedSet.has(char));
            
            if (unrevealedLetters.length === 0) {
                showToast('该站名已全部揭开', 'info');
                return;
            }
            
            // 随机揭示一个字母
            const randomLetter = unrevealedLetters[Math.floor(Math.random() * unrevealedLetters.length)];
            
            // 初始化该站名的揭示字母集合
            if (!mpState.revealedLetters[randomIndex]) {
                mpState.revealedLetters[randomIndex] = new Set();
            }
            mpState.revealedLetters[randomIndex].add(randomLetter);
            
            mpState.usedLetters = mpState.usedLetters || new Set();
            mpState.foundLetters = mpState.foundLetters || new Set();
            mpState.usedLetters.add(randomLetter);
            mpState.foundLetters.add(randomLetter);
            mpState.mpHintsLeft--;
            mpState.mpHintsUsed = (mpState.mpHintsUsed || 0) + 1;
            mpState.score = Math.max(0, (mpState.score || 0) - 30);
            
            // 同步到服务器
            await syncMpGameState();
            
            playSound('hint');
            showToast(`提示：字母 ${randomLetter.toUpperCase()} (-30分)`, 'info');
            
            renderMultiplayerGame(mpState.gameData);
        }

        async function showGameResult() {
            document.getElementById('mp-game-result').classList.remove('hidden');
            
            if (!roomRef) return;
            const snapshot = await roomRef.child('players').once('value');
            const players = snapshot.val() || {};
            
            const sortedPlayers = Object.values(players).sort((a, b) => b.score - a.score);
            
            const container = document.getElementById('mp-final-rankings');
            container.innerHTML = '';
            
            sortedPlayers.forEach((player, index) => {
                const div = document.createElement('div');
                div.className = `flex justify-between items-center p-3 rounded-lg ${index === 0 ? 'bg-yellow-100' : 'bg-slate-100'}`;
                div.innerHTML = `
                    <span class="font-medium">
                        ${index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `第${index + 1}名`}
                        ${player.name}
                    </span>
                    <span class="font-bold text-blue-600">${player.score} 分</span>
                `;
                container.appendChild(div);
            });
        }

        async function playAgain() {
            if (mpState.isHost && roomRef) {
                await roomRef.child('game').remove();
                const snapshot = await roomRef.child('players').once('value');
                const players = snapshot.val() || {};
                const updates = {};
                Object.keys(players).forEach(id => {
                    updates[`${id}/score`] = 0;
                });
                await roomRef.child('players').update(updates);
            }
            
            // 重置所有状态 - 与主游戏相同
            mpState.revealedLetters = {};
            mpState.revealedSpecialChars = new Set();
            mpState.solvedStations = new Set();
            mpState.mpHintsUsed = 0;
            mpState.mpHintsLeft = DIFFICULTY_SETTINGS[gameState.difficulty]?.hints || 3;
            mpState.usedLetters = new Set();
            mpState.usedSpecialChars = new Set();
            mpState.foundLetters = new Set();
            mpState.foundSpecialChars = new Set();
            mpState.score = 0;
            mpState.combo = 0;
            mpState.lastCorrectTime = 0;
            mpState.guessCount = 0;
            
            document.getElementById('mp-game-result').classList.add('hidden');
            
            if (mpState.isHost) {
                initMultiplayerGame();
            }
        }

        function quickMatch() {
            showToast('正在匹配...', 'info');
            setTimeout(() => {
                const fakeRoom = generateRoomCode();
                joinRoom(fakeRoom);
            }, 1500);
        }

        function copyRoomCode() {
            navigator.clipboard.writeText(mpState.roomId).then(() => {
                showToast('房间号已复制', 'success');
            });
        }

        // ========== 联机模块结束 ==========

        async function init() {
            stationDatabase = parseCSV(csvData);
            await loadCSVFromFile();
            loadStats();
            updateCitySelect();
            renderAchievements();
            updateStatsDisplay();
            startNewGame();
            setupEventListeners();
            initAudio();
            initFirebase();
            
            setTimeout(async () => {
                if (mpState.connected && db) {
                    await loadFromCloud();
                }
            }, 1000);
        }

        function startNewGame() {
            stopTimer();
            
            const settings = DIFFICULTY_SETTINGS[gameState.difficulty];
            const customCount = parseInt(document.getElementById('station-count').value) || settings.stationCount;
            const stationCount = Math.min(Math.max(customCount, 1), 20);
            
            const classified = classifyStationsByDifficulty();
            const targetDifficulty = settings.difficultyLevel;
            
            let pool = classified[targetDifficulty];
            
            if (gameState.selectedCity !== 'all') {
                pool = pool.filter(s => s.city_cn === gameState.selectedCity);
            }
            
            if (pool.length < stationCount) {
                let allPool = gameState.selectedCity === 'all' 
                    ? stationDatabase 
                    : stationDatabase.filter(s => s.city_cn === gameState.selectedCity);
                allPool = allPool.map(s => ({
                    ...s,
                    calculatedDifficulty: targetDifficulty
                }));
                pool = allPool;
            }
            
            pool = pool.map(s => ({
                ...s,
                calculatedDifficulty: targetDifficulty
            }));
            
            const shuffled = [...pool].sort(() => Math.random() - 0.5);
            const selected = shuffled.slice(0, stationCount);
            
            gameState = {
                mode: gameState.mode,
                difficulty: gameState.difficulty,
                selectedCity: gameState.selectedCity,
                stations: selected,
                revealedLetters: {},
                revealedSpecialChars: new Set(),
                solvedStations: new Set(),
                guessCount: 0,
                guessHistory: [],
                gameWon: false,
                score: 0,
                hintsUsed: 0,
                hintsLeft: settings.hints,
                startTime: Date.now(),
                elapsedTime: 0,
                usedLetters: new Set(),
                usedSpecialChars: new Set(),
                foundLetters: new Set(),
                foundSpecialChars: new Set(),
                combo: 0,
                lastCorrectTime: 0,
                devMode: false
            };
            
            selected.forEach((_, index) => {
                gameState.revealedLetters[index] = new Set();
            });
            
            elements.victoryModal.classList.add('hidden');
            
            renderStations();
            renderLetterKeyboard();
            updateStats();
            renderGuessHistory();
            startTimer();
            updateProgressBar();
        }

        function startTimer() {
            stopTimer();
            timerInterval = setInterval(() => {
                gameState.elapsedTime = Math.floor((Date.now() - gameState.startTime) / 1000);
                updateTimerDisplay();
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(gameState.elapsedTime / 60);
            const seconds = gameState.elapsedTime % 60;
            elements.timer.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function updateProgressBar() {
            const total = gameState.stations.length;
            const solved = gameState.solvedStations.size;
            const percent = total > 0 ? (solved / total) * 100 : 0;
            elements.progressBar.style.width = `${percent}%`;
            elements.progressText.textContent = `${solved}/${total}`;
        }

        function renderStations() {
            const container = elements.stationsContainer;
            const currentCards = container.children;
            
            if (currentCards.length !== gameState.stations.length) {
                container.innerHTML = '';
                gameState.stations.forEach((station, index) => {
                    const card = createStationCard(station, index);
                    container.appendChild(card);
                });
                return;
            }
            
            for (let i = 0; i < gameState.stations.length; i++) {
                const station = gameState.stations[i];
                const card = currentCards[i];
                updateStationCard(card, station, i);
            }
        }
        
        function createStationCard(station, index) {
            const isSolved = gameState.solvedStations.has(index);
            const revealed = gameState.revealedLetters[index];
            const displayText = getDisplayText(station.station_en, revealed, isSolved, gameState.devMode, gameState.revealedSpecialChars);
            const difficulty = station.calculatedDifficulty || calculateStationDifficulty(station);
            const difficultyLabel = difficulty === 'easy' ? '简单' : difficulty === 'normal' ? '普通' : '困难';
            const difficultyColor = difficulty === 'easy' ? 'bg-green-100 text-green-700' : 
                                   difficulty === 'normal' ? 'bg-yellow-100 text-yellow-700' : 
                                   'bg-red-100 text-red-700';
            
            const card = document.createElement('div');
            card.className = `station-card rounded-xl p-4 ${isSolved ? 'solved' : ''}`;
            card.id = `station-${index}`;
            
            const stationInfoHtml = (isSolved || gameState.devMode) ? `
                <div class="station-info text-center text-sm">
                    <p class="text-slate-800 font-medium dark:text-slate-200 station-cn">${station.station_cn}</p>
                    <p class="text-slate-500 text-xs">${station.city_cn} · ${station.city_en}</p>
                </div>
            ` : '';
            
            card.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-medium text-slate-500">#${index + 1}</span>
                    <div class="flex items-center gap-2">
                        <span class="text-xs px-2 py-0.5 rounded ${difficultyColor} difficulty-badge">${difficultyLabel}</span>
                        <span class="solved-badge ${isSolved ? '' : 'hidden'} text-green-600 text-sm font-medium">✓ 已解开</span>
                    </div>
                </div>
                <div class="letter-display text-lg md:text-xl font-bold text-slate-800 mb-3 text-center py-2 bg-white/50 rounded-lg dark:bg-slate-700/50 dark:text-slate-200">
                    ${displayText}
                </div>
                ${stationInfoHtml}
            `;
            return card;
        }
        
        function updateStationCard(card, station, index) {
            const isSolved = gameState.solvedStations.has(index);
            const revealed = gameState.revealedLetters[index];
            const displayText = getDisplayText(station.station_en, revealed, isSolved, gameState.devMode, gameState.revealedSpecialChars);
            const difficulty = station.calculatedDifficulty || calculateStationDifficulty(station);
            const difficultyLabel = difficulty === 'easy' ? '简单' : difficulty === 'normal' ? '普通' : '困难';
            const difficultyColor = difficulty === 'easy' ? 'bg-green-100 text-green-700' : 
                                   difficulty === 'normal' ? 'bg-yellow-100 text-yellow-700' : 
                                   'bg-red-100 text-red-700';
            
            card.className = `station-card rounded-xl p-4 ${isSolved ? 'solved' : ''}`;
            
            const letterDisplay = card.querySelector('.letter-display');
            if (letterDisplay) letterDisplay.innerHTML = displayText;
            
            const solvedBadge = card.querySelector('.solved-badge');
            if (solvedBadge) solvedBadge.classList.toggle('hidden', !isSolved);
            
            const difficultyBadge = card.querySelector('.difficulty-badge');
            if (difficultyBadge) {
                difficultyBadge.textContent = difficultyLabel;
                difficultyBadge.className = `text-xs px-2 py-0.5 rounded ${difficultyColor} difficulty-badge`;
            }
            
            const existingInfo = card.querySelector('.station-info');
            const shouldShowInfo = isSolved || gameState.devMode;
            
            if (shouldShowInfo && !existingInfo) {
                const infoDiv = document.createElement('div');
                infoDiv.className = 'station-info text-center text-sm';
                infoDiv.innerHTML = `
                    <p class="text-slate-800 font-medium dark:text-slate-200 station-cn">${station.station_cn}</p>
                    <p class="text-slate-500 text-xs">${station.city_cn} · ${station.city_en}</p>
                `;
                card.appendChild(infoDiv);
            } else if (!shouldShowInfo && existingInfo) {
                existingInfo.remove();
            }
        }

        function getDisplayText(stationName, revealedLetters, isSolved, devMode = false, revealedSpecialChars = null) {
            if (isSolved || devMode) {
                return stationName;
            }
            
            return stationName.split('').map(char => {
                const lowerChar = char.toLowerCase();
                if (/[a-z]/.test(lowerChar)) {
                    if (revealedLetters.has(lowerChar)) {
                        return `<span class="letter-reveal text-blue-600">${char}</span>`;
                    }
                    return '*';
                }
                if (char === ' ') {
                    return ' ';
                }
                if (revealedSpecialChars && revealedSpecialChars.has(char)) {
                    return `<span class="letter-reveal text-blue-600">${char}</span>`;
                }
                return '*';
            }).join('');
        }

        function renderLetterKeyboard() {
            const keyboard = elements.letterKeyboard;
            
            if (keyboard.children.length === 0) {
                const letters = 'abcdefghijklmnopqrstuvwxyz'.split('');
                letters.forEach(letter => {
                    const btn = document.createElement('button');
                    btn.className = 'letter-key w-8 h-8 rounded text-sm font-medium cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-700';
                    btn.textContent = letter.toUpperCase();
                    btn.dataset.letter = letter;
                    btn.addEventListener('click', () => revealLetter(letter));
                    keyboard.appendChild(btn);
                });
            }
            
            const buttons = keyboard.children;
            for (let i = 0; i < buttons.length; i++) {
                const btn = buttons[i];
                const letter = btn.dataset.letter;
                const isUsed = gameState.usedLetters.has(letter);
                const isFound = gameState.foundLetters.has(letter);
                
                btn.className = `letter-key w-8 h-8 rounded text-sm font-medium cursor-pointer ${
                    isFound ? 'found' : isUsed ? 'not-found used' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'
                }`;
                btn.disabled = isUsed || gameState.gameWon;
            }
        }

        function handleGuess() {
            const input = elements.guessInput.value.trim();
            if (!input) return;
            
            elements.guessInput.value = '';
            
            const command = input.toLowerCase();
            
            if (command === 'lvshu') {
                gameState.devMode = !gameState.devMode;
                renderStations();
                if (gameState.devMode) {
                    elements.modeReverse.classList.remove('hidden');
                    addToHistory('开发者模式已开启', 'info', '所有答案已显示');
                    showToast('开发者模式已开启', 'info');
                } else {
                    elements.modeReverse.classList.add('hidden');
                    if (gameState.mode === 'reverse') {
                        switchMode('normal');
                    }
                    addToHistory('开发者模式已关闭', 'info', '恢复游戏状态');
                    showToast('开发者模式已关闭', 'info');
                }
                return;
            }
            
            gameState.guessCount++;
            
            if (command === '结束') {
                addToHistory('结束游戏', 'info');
                startNewGame();
                return;
            }
            
            if (command.startsWith('开 ')) {
                const letter = command.slice(2).trim();
                if (letter.length === 1) {
                    revealLetter(letter.toLowerCase());
                } else {
                    addToHistory(`无效指令: ${input}`, 'error');
                }
            } else if (command.startsWith('猜 ')) {
                const guess = command.slice(2).trim();
                if (guess.length === 1 && /[a-z]/i.test(guess)) {
                    revealLetter(guess.toLowerCase());
                } else {
                    guessStation(guess);
                }
            } else if (command.length === 1) {
                revealLetter(command.toLowerCase());
            } else if (command.length > 1) {
                guessStation(command);
            } else {
                addToHistory(`无效指令: ${input}`, 'error');
            }
            
            updateStats();
        }

        function revealLetter(letter) {
            const isSpecialChar = !/[a-z]/.test(letter);
            
            if (isSpecialChar) {
                if (gameState.usedSpecialChars.has(letter)) {
                    addToHistory(`字符 ${letter} 已使用`, 'error');
                    showToast('该字符已使用', 'error');
                    return;
                }
                
                gameState.usedSpecialChars.add(letter);
                let found = false;
                let matchCount = 0;
                
                gameState.stations.forEach((station, index) => {
                    if (gameState.solvedStations.has(index)) return;
                    
                    const stationEn = station.station_en;
                    if (stationEn.includes(letter)) {
                        found = true;
                        matchCount++;
                    }
                });
                
                if (found) {
                    gameState.revealedSpecialChars.add(letter);
                    gameState.foundSpecialChars.add(letter);
                    gameState.score = Math.max(0, gameState.score - 5);
                    playSound('reveal');
                    addToHistory(`开 ${letter}`, 'success', `在 ${matchCount} 个站名中找到 (-5分)`);
                } else {
                    gameState.score = Math.max(0, gameState.score - 15);
                    playSound('wrong');
                    addToHistory(`开 ${letter}`, 'error', '未找到该字符 (-15分)');
                    
                    elements.stationsContainer.classList.add('shake');
                    setTimeout(() => elements.stationsContainer.classList.remove('shake'), 500);
                }
            } else {
                if (gameState.usedLetters.has(letter)) {
                    addToHistory(`字母 ${letter.toUpperCase()} 已使用`, 'error');
                    showToast('该字母已使用', 'error');
                    return;
                }
                
                gameState.usedLetters.add(letter);
                let found = false;
                let matchCount = 0;
                
                gameState.stations.forEach((station, index) => {
                    if (gameState.solvedStations.has(index)) return;
                    
                    const stationLower = station.station_en.toLowerCase();
                    if (stationLower.includes(letter)) {
                        found = true;
                        gameState.revealedLetters[index].add(letter);
                        matchCount++;
                    }
                });
                
                if (found) {
                    gameState.foundLetters.add(letter);
                    gameState.score = Math.max(0, gameState.score - 5);
                    playSound('reveal');
                    addToHistory(`开 ${letter.toUpperCase()}`, 'success', `在 ${matchCount} 个站名中找到 (-5分)`);
                    
                    const btn = document.querySelector(`[data-letter="${letter}"]`);
                    if (btn) {
                        createParticles(btn.getBoundingClientRect().left + 16, btn.getBoundingClientRect().top + 16, 5);
                    }
                } else {
                    gameState.score = Math.max(0, gameState.score - 15);
                    playSound('wrong');
                    addToHistory(`开 ${letter.toUpperCase()}`, 'error', '未找到该字母 (-15分)');
                    
                    elements.stationsContainer.classList.add('shake');
                    setTimeout(() => elements.stationsContainer.classList.remove('shake'), 500);
                }
            }
            
            renderStations();
            renderLetterKeyboard();
            updateScoreDisplay();
        }

        function guessStation(guess) {
            let correct = false;
            let matchedStation = null;
            let matchedIndex = -1;
            
            gameState.stations.forEach((station, index) => {
                if (gameState.solvedStations.has(index)) return;
                
                const stationCn = station.station_cn.toLowerCase();
                const stationEn = station.station_en.toLowerCase();
                const guessLower = guess.toLowerCase();
                
                if (guessLower === stationCn || guessLower === stationEn) {
                    correct = true;
                    matchedIndex = index;
                    matchedStation = station;
                }
            });
            
            if (correct && matchedIndex !== -1) {
                gameState.solvedStations.add(matchedIndex);
                
                const now = Date.now();
                if (now - gameState.lastCorrectTime < 5000) {
                    gameState.combo++;
                    playSound('combo');
                } else {
                    gameState.combo = 1;
                }
                gameState.lastCorrectTime = now;
                
                const comboBonus = gameState.combo * 5;
                const totalPoints = 100 + comboBonus;
                gameState.score += totalPoints;
                stats.stationsSolved++;
                
                playSound('correct');
                addToHistory(`猜 ${guess}`, 'success', `正确！${matchedStation.city_cn} · ${matchedStation.station_cn} (+${totalPoints}分)`);
                
                const card = document.getElementById(`station-${matchedIndex}`);
                if (card) {
                    card.classList.add('pulse-success');
                    const rect = card.getBoundingClientRect();
                    showFloatingScore(totalPoints, rect.left + rect.width / 2, rect.top);
                    createParticles(rect.left + rect.width / 2, rect.top + rect.height / 2, 15);
                }
                
                renderStations();
                updateScoreDisplay();
                updateProgressBar();
                updateComboDisplay();
                checkWinCondition();
            } else {
                gameState.combo = 0;
                updateComboDisplay();
                playSound('wrong');
                addToHistory(`猜 ${guess}`, 'error', '不正确');
                
                elements.stationsContainer.classList.add('shake');
                setTimeout(() => elements.stationsContainer.classList.remove('shake'), 500);
            }
        }

        function updateComboDisplay() {
            elements.combo.textContent = gameState.combo;
            if (gameState.combo > 1) {
                elements.combo.classList.add('combo-display');
                setTimeout(() => elements.combo.classList.remove('combo-display'), 300);
            }
        }

        function useHint() {
            if (gameState.hintsLeft <= 0) {
                addToHistory('提示次数已用完', 'error');
                showToast('提示次数已用完', 'error');
                return;
            }
            
            const unsolvedIndices = gameState.stations
                .map((_, index) => index)
                .filter(index => !gameState.solvedStations.has(index));
            
            if (unsolvedIndices.length === 0) return;
            
            const randomIndex = unsolvedIndices[Math.floor(Math.random() * unsolvedIndices.length)];
            const station = gameState.stations[randomIndex];
            const stationLower = station.station_en.toLowerCase();
            
            const unrevealedLetters = stationLower
                .split('')
                .filter(char => /[a-z]/.test(char) && !gameState.revealedLetters[randomIndex].has(char));
            
            if (unrevealedLetters.length === 0) {
                addToHistory('该站名已全部揭开', 'info');
                return;
            }
            
            const randomLetter = unrevealedLetters[Math.floor(Math.random() * unrevealedLetters.length)];
            gameState.revealedLetters[randomIndex].add(randomLetter);
            gameState.usedLetters.add(randomLetter);
            gameState.foundLetters.add(randomLetter);
            gameState.hintsLeft--;
            gameState.hintsUsed++;
            gameState.score = Math.max(0, gameState.score - 30);
            
            playSound('hint');
            addToHistory(`使用提示`, 'info', `揭示字母 ${randomLetter.toUpperCase()} (-30分)`);
            showToast(`提示：字母 ${randomLetter.toUpperCase()}`, 'info');
            
            renderStations();
            renderLetterKeyboard();
            updateScoreDisplay();
            elements.hintsLeft.textContent = gameState.hintsLeft;
        }

        function checkWinCondition() {
            if (gameState.solvedStations.size === gameState.stations.length) {
                gameState.gameWon = true;
                stopTimer();
                
                const settings = DIFFICULTY_SETTINGS[gameState.difficulty];
                const timeBonus = Math.max(0, settings.timeBonus - gameState.elapsedTime) * 2;
                gameState.score += timeBonus;
                gameState.score = Math.floor(gameState.score * settings.multiplier);
                
                stats.gamesPlayed++;
                stats.gamesWon++;
                stats.currentStreak++;
                stats.bestStreak = Math.max(stats.bestStreak, stats.currentStreak);
                stats.totalScore += gameState.score;
                
                checkAchievements();
                saveStats();
                updateStatsDisplay();
                
                playSound('victory');
                createFireworks();
                
                setTimeout(() => {
                    elements.finalTime.textContent = formatTime(gameState.elapsedTime);
                    elements.finalScore.textContent = gameState.score;
                    elements.finalGuesses.textContent = gameState.guessCount;
                    elements.finalHints.textContent = gameState.hintsUsed;
                    elements.victoryModal.classList.remove('hidden');
                }, 500);
            }
        }

        function checkAchievements() {
            if (!stats.achievements.has('first_win')) {
                stats.achievements.add('first_win');
                showToast('🏆 成就解锁：初次胜利！', 'success');
            }
            
            if (gameState.elapsedTime <= 60 && !stats.achievements.has('speed_demon')) {
                stats.achievements.add('speed_demon');
                showToast('🏆 成就解锁：速度恶魔！', 'success');
            }
            
            if (gameState.hintsUsed === 0 && !stats.achievements.has('perfect')) {
                stats.achievements.add('perfect');
                showToast('🏆 成就解锁：完美猜测！', 'success');
            }
            
            if (stats.currentStreak >= 3 && !stats.achievements.has('streak_3')) {
                stats.achievements.add('streak_3');
                showToast('🏆 成就解锁：三连胜！', 'success');
            }
            
            if (stats.currentStreak >= 5 && !stats.achievements.has('streak_5')) {
                stats.achievements.add('streak_5');
                showToast('🏆 成就解锁：五连胜！', 'success');
            }
            
            if (stats.totalScore >= 10000 && !stats.achievements.has('master')) {
                stats.achievements.add('master');
                showToast('🏆 成就解锁：地铁大师！', 'success');
            }
            
            if (stats.stationsSolved >= 100 && !stats.achievements.has('collector')) {
                stats.achievements.add('collector');
                showToast('🏆 成就解锁：收藏家！', 'success');
            }
            
            if (gameState.selectedCity !== 'all' && !stats.unlockedCities.has(gameState.selectedCity)) {
                stats.unlockedCities.add(gameState.selectedCity);
            }
            
            renderAchievements();
        }

        function renderAchievements() {
            elements.achievementsList.innerHTML = '';
            
            ACHIEVEMENTS.forEach(achievement => {
                const unlocked = stats.achievements.has(achievement.id);
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg border ${unlocked ? 'bg-yellow-50 border-yellow-200' : 'bg-slate-50 border-slate-200 opacity-50'}`;
                const iconSvg = ACHIEVEMENT_ICONS[achievement.icon] || '';
                div.innerHTML = `
                    <div class="flex items-center gap-2 mb-1">
                        <span class="${unlocked ? 'achievement-badge text-yellow-600' : 'text-slate-400'}">${iconSvg}</span>
                        <span class="font-medium text-sm ${unlocked ? 'text-slate-800' : 'text-slate-500'}">${achievement.name}</span>
                    </div>
                    <p class="text-xs text-slate-500">${achievement.desc}</p>
                `;
                elements.achievementsList.appendChild(div);
            });
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function updateScoreDisplay() {
            elements.score.textContent = gameState.score;
        }

        function handleReverseGuess() {
            const pattern = elements.reverseInput.value.trim().toLowerCase();
            const revealedLetters = elements.revealedLettersInput.value.trim().toLowerCase();
            if (!pattern) return;
            
            if (!/^[a-z*\s'().\[\]-]+$/.test(pattern)) {
                addToHistory('请输入有效的提示', 'error');
                return;
            }
            
            const matches = findMatchingStations(pattern, revealedLetters);
            renderReverseResults(matches, pattern, revealedLetters);
        }

        function findMatchingStations(pattern, revealedLetters = '') {
            const revealedSet = new Set(revealedLetters.replace(/[^a-z]/g, '').split(''));
            
            return stationDatabase.filter(station => {
                const name = station.station_en.toLowerCase();
                if (name.length !== pattern.length) return false;
                
                for (let i = 0; i < pattern.length; i++) {
                    if (pattern[i] !== '*' && pattern[i] !== name[i]) {
                        return false;
                    }
                    if (pattern[i] === '*' && !/[a-z]/.test(name[i])) {
                        return false;
                    }
                    if (pattern[i] === '*' && revealedSet.has(name[i])) {
                        return false;
                    }
                }
                
                return true;
            });
        }

        function renderReverseResults(matches, pattern, revealedLetters = '') {
            elements.reverseResults.classList.remove('hidden');
            elements.reverseResultsList.innerHTML = '';
            
            if (matches.length === 0) {
                elements.reverseResultsList.innerHTML = `
                    <div class="text-slate-500 text-center py-4">
                        未找到匹配的站名
                    </div>
                `;
                return;
            }
            
            matches.slice(0, 20).forEach(station => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-3 bg-white rounded-lg border border-slate-200 hover:border-blue-300 transition-all cursor-pointer';
                item.innerHTML = `
                    <div>
                        <p class="font-medium text-slate-800">${station.station_en}</p>
                        <p class="text-sm text-slate-500">${station.station_cn} · ${station.city_cn}</p>
                    </div>
                    <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">匹配</span>
                `;
                elements.reverseResultsList.appendChild(item);
            });
            
            if (matches.length > 20) {
                const more = document.createElement('div');
                more.className = 'text-center text-slate-500 text-sm py-2';
                more.textContent = `还有 ${matches.length - 20} 个结果...`;
                elements.reverseResultsList.appendChild(more);
            }
            
            const revealedInfo = revealedLetters ? `，已揭开字母: ${revealedLetters}` : '';
            addToHistory(`逆向猜测: ${pattern}${revealedInfo}`, 'info', `找到 ${matches.length} 个匹配`);
        }

        function addToHistory(action, type, detail = '') {
            const timestamp = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            const historyItem = { action, type, detail, timestamp };
            gameState.guessHistory.push(historyItem);
            appendHistoryItem(historyItem);
        }
        
        function appendHistoryItem(item) {
            if (gameState.guessHistory.length === 1) {
                elements.guessHistory.innerHTML = '';
            }
            
            const div = document.createElement('div');
            div.className = 'guess-history-item flex items-center justify-between p-2 rounded-lg text-sm';
            
            let typeClass = '';
            let typeIcon = '';
            switch (item.type) {
                case 'success':
                    typeClass = 'bg-green-50 text-green-800';
                    typeIcon = '✓';
                    break;
                case 'error':
                    typeClass = 'bg-red-50 text-red-800';
                    typeIcon = '✗';
                    break;
                default:
                    typeClass = 'bg-slate-50 text-slate-700';
                    typeIcon = '•';
            }
            
            div.className += ` ${typeClass}`;
            div.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="font-medium">${typeIcon}</span>
                    <span>${item.action}</span>
                    ${item.detail ? `<span class="text-xs opacity-75">- ${item.detail}</span>` : ''}
                </div>
                <span class="text-xs opacity-50">${item.timestamp}</span>
            `;
            elements.guessHistory.insertBefore(div, elements.guessHistory.firstChild);
            
            while (elements.guessHistory.children.length > 50) {
                elements.guessHistory.removeChild(elements.guessHistory.lastChild);
            }
        }

        function renderGuessHistory() {
            if (gameState.guessHistory.length === 0) {
                elements.guessHistory.innerHTML = '<p class="text-slate-400 text-sm italic">暂无记录</p>';
                return;
            }
            
            elements.guessHistory.innerHTML = '';
            [...gameState.guessHistory].reverse().forEach(item => {
                appendHistoryItem(item);
            });
        }

        function updateStats() {
            elements.guessCount.textContent = gameState.guessCount;
            elements.hintsLeft.textContent = gameState.hintsLeft;
        }

        function switchMode(mode) {
            gameState.mode = mode;
            
            elements.modeNormal.classList.remove('active');
            elements.modeReverse.classList.remove('active');
            elements.modeLeaderboard.classList.remove('active');
            elements.modeMultiplayer.classList.remove('active');
            elements.normalModeArea.classList.add('hidden');
            elements.reverseModeArea.classList.add('hidden');
            elements.leaderboardArea.classList.add('hidden');
            elements.multiplayerArea.classList.add('hidden');
            elements.gameControls.classList.add('hidden');
            elements.gameSettings.classList.add('hidden');
            
            if (mode === 'normal') {
                elements.modeNormal.classList.add('active');
                elements.normalModeArea.classList.remove('hidden');
                elements.gameSettings.classList.remove('hidden');
                elements.gameControls.classList.remove('hidden');
                elements.guessInput.focus();
            } else if (mode === 'reverse') {
                elements.modeReverse.classList.add('active');
                elements.reverseModeArea.classList.remove('hidden');
                elements.reverseInput.focus();
            } else if (mode === 'leaderboard') {
                elements.modeLeaderboard.classList.add('active');
                elements.leaderboardArea.classList.remove('hidden');
                renderLeaderboard('normal');
                updateStatsDisplay();
            } else if (mode === 'multiplayer') {
                elements.modeMultiplayer.classList.add('active');
                elements.multiplayerArea.classList.remove('hidden');
                if (mpState.isHost) {
                    elements.gameSettings.classList.remove('hidden');
                }
            }
        }

        function renderLeaderboard(difficulty) {
            let board = cloudLeaderboards[difficulty] && cloudLeaderboards[difficulty].length > 0 
                ? cloudLeaderboards[difficulty] 
                : (stats.leaderboards[difficulty] || []);
            
            elements.leaderboardList.innerHTML = '';
            
            document.querySelectorAll('.leaderboard-tab').forEach(tab => {
                tab.classList.remove('active', 'bg-blue-500', 'text-white');
                tab.classList.add('bg-white', 'text-slate-700');
                if (tab.dataset.board === difficulty) {
                    tab.classList.add('active', 'bg-blue-500', 'text-white');
                    tab.classList.remove('bg-white', 'text-slate-700');
                }
            });
            
            if (board.length === 0) {
                elements.leaderboardList.innerHTML = '<p class="text-slate-500 text-center py-4">暂无记录</p>';
                return;
            }
            
            board.slice(0, 10).forEach((entry, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item flex items-center justify-between p-3 bg-white rounded-lg border border-slate-200';
                item.style.animationDelay = `${index * 0.1}s`;
                
                const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`;
                
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-xl">${medal}</span>
                        <div>
                            <p class="font-medium text-slate-800">${entry.name}</p>
                            <p class="text-xs text-slate-500">${entry.date}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-green-600">${entry.score}</p>
                        <p class="text-xs text-slate-500">${formatTime(entry.time)} · ${entry.guesses}次</p>
                    </div>
                `;
                elements.leaderboardList.appendChild(item);
            });
        }

        async function saveScore() {
            const name = elements.playerName.value.trim() || '匿名玩家';
            const entry = {
                name,
                score: gameState.score,
                time: gameState.elapsedTime,
                guesses: gameState.guessCount,
                hints: gameState.hintsUsed,
                date: new Date().toLocaleDateString('zh-CN'),
                timestamp: Date.now()
            };
            
            if (!stats.leaderboards[gameState.difficulty]) {
                stats.leaderboards[gameState.difficulty] = [];
            }
            
            stats.leaderboards[gameState.difficulty].push(entry);
            stats.leaderboards[gameState.difficulty].sort((a, b) => b.score - a.score);
            stats.leaderboards[gameState.difficulty] = stats.leaderboards[gameState.difficulty].slice(0, 10);
            
            saveStats();
            
            if (db) {
                try {
                    if (!mpState.connected) {
                        initFirebase();
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    
                    if (db) {
                        const difficultyRef = db.ref('leaderboards/' + gameState.difficulty);
                        const newEntryRef = difficultyRef.push();
                        await newEntryRef.set(entry);
                        
                        const snapshot = await difficultyRef.orderByChild('score').once('value');
                        const allEntries = [];
                        snapshot.forEach(child => {
                            allEntries.push({ key: child.key, ...child.val() });
                        });
                        allEntries.sort((a, b) => b.score - a.score);
                        
                        if (allEntries.length > 50) {
                            const toRemove = allEntries.slice(50);
                            for (const item of toRemove) {
                                await db.ref('leaderboards/' + gameState.difficulty + '/' + item.key).remove();
                            }
                        }
                        
                        showToast('成绩已保存到云端排行榜！', 'success');
                    }
                } catch (e) {
                    console.error('Failed to save to cloud leaderboard:', e);
                    showToast('成绩已保存到本地！', 'success');
                }
            } else {
                showToast('成绩已保存！', 'success');
            }
            
            elements.victoryModal.classList.add('hidden');
            switchMode('leaderboard');
            renderLeaderboard(gameState.difficulty);
        }

        function saveGameState() {
            const stateToSave = {
                ...gameState,
                revealedLetters: Object.fromEntries(
                    Object.entries(gameState.revealedLetters).map(([k, v]) => [k, Array.from(v)])
                ),
                solvedStations: Array.from(gameState.solvedStations),
                usedLetters: Array.from(gameState.usedLetters),
                foundLetters: Array.from(gameState.foundLetters)
            };
            localStorage.setItem('subwayGameState', JSON.stringify(stateToSave));
            addToHistory('保存游戏', 'info', '游戏状态已保存');
            showToast('游戏已保存！', 'success');
        }

        function loadGameState() {
            const saved = localStorage.getItem('subwayGameState');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    gameState = {
                        ...parsed,
                        revealedLetters: Object.fromEntries(
                            Object.entries(parsed.revealedLetters || {}).map(([k, v]) => [k, new Set(v)])
                        ),
                        solvedStations: new Set(parsed.solvedStations || []),
                        usedLetters: new Set(parsed.usedLetters || []),
                        foundLetters: new Set(parsed.foundLetters || [])
                    };
                    
                    switchMode(gameState.mode);
                    renderStations();
                    renderLetterKeyboard();
                    updateStats();
                    updateScoreDisplay();
                    updateProgressBar();
                    renderGuessHistory();
                    
                    if (gameState.gameWon) {
                        elements.victoryModal.classList.remove('hidden');
                    }
                    
                    addToHistory('加载游戏', 'info', '游戏状态已加载');
                    showToast('游戏已加载！', 'success');
                } catch (e) {
                    console.error('Failed to load game state:', e);
                    showToast('加载失败！', 'error');
                }
            } else {
                showToast('没有找到保存的游戏！', 'error');
            }
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark', isDarkMode);
            
            const moonIcon = $('theme-moon-icon');
            const sunIcon = $('theme-sun-icon');
            
            if (isDarkMode) {
                document.body.classList.remove('bg-gradient-to-br', 'from-indigo-50', 'via-purple-50', 'to-blue-100');
                document.body.classList.add('bg-gradient-to-br', 'from-slate-950', 'via-slate-900', 'to-slate-950', 'text-slate-200');
                if (moonIcon) moonIcon.classList.add('hidden');
                if (sunIcon) sunIcon.classList.remove('hidden');
            } else {
                document.body.classList.remove('bg-gradient-to-br', 'from-slate-950', 'via-slate-900', 'to-slate-950', 'text-slate-200');
                document.body.classList.add('bg-gradient-to-br', 'from-indigo-50', 'via-purple-50', 'to-blue-100', 'text-slate-800');
                if (moonIcon) moonIcon.classList.remove('hidden');
                if (sunIcon) sunIcon.classList.add('hidden');
            }
            showToast(isDarkMode ? '已切换到暗色模式' : '已切换到亮色模式', 'info');
        }

        function setupEventListeners() {
            elements.btnSubmit.addEventListener('click', handleGuess);
            elements.guessInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleGuess();
            });
            
            elements.btnReverseGuess.addEventListener('click', handleReverseGuess);
            elements.btnReverseClear.addEventListener('click', () => {
                elements.reverseInput.value = '';
                elements.revealedLettersInput.value = '';
                elements.reverseResults.classList.add('hidden');
            });
            elements.reverseInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleReverseGuess();
            });
            
            elements.btnNewGame.addEventListener('click', () => {
                stats.currentStreak = 0;
                startNewGame();
                showToast('新游戏开始！', 'success');
            });
            
            if (elements.btnSave) elements.btnSave.addEventListener('click', saveGameState);
            if (elements.btnLoad) elements.btnLoad.addEventListener('click', loadGameState);
            elements.btnHint.addEventListener('click', useHint);
            elements.btnTheme.addEventListener('click', toggleTheme);
            elements.soundToggle.addEventListener('click', toggleSound);
            
            elements.btnPlayAgain.addEventListener('click', () => {
                elements.victoryModal.classList.add('hidden');
                startNewGame();
            });
            
            elements.btnSaveScore.addEventListener('click', saveScore);
            
            elements.modeNormal.addEventListener('click', () => switchMode('normal'));
            elements.modeReverse.addEventListener('click', () => switchMode('reverse'));
            elements.modeLeaderboard.addEventListener('click', () => switchMode('leaderboard'));
            elements.modeMultiplayer.addEventListener('click', () => switchMode('multiplayer'));
            
            $('btn-create-room').addEventListener('click', createRoom);
            $('btn-quick-match').addEventListener('click', quickMatch);
            $('btn-join-room').addEventListener('click', () => joinRoom(elements.roomCodeInput.value));
            $('btn-ready').addEventListener('click', toggleReady);
            $('btn-leave-room').addEventListener('click', leaveRoom);
            $('btn-start-game').addEventListener('click', startGame);
            $('mp-submit-btn').addEventListener('click', submitMpGuess);
            $('mp-hint-btn').addEventListener('click', useMpHint);
            $('mp-play-again').addEventListener('click', playAgain);
            $('mp-guess-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') submitMpGuess();
            });
            $('btn-copy-room').addEventListener('click', copyRoomCode);
            $('btn-send-chat').addEventListener('click', sendChatMessage);
            elements.chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendChatMessage();
            });
            elements.roomCodeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') joinRoom(elements.roomCodeInput.value);
            });
            
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    $all('.difficulty-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameState.difficulty = btn.dataset.difficulty;
                    stats.currentStreak = 0;
                    startNewGame();
                    showToast(`难度已切换到${btn.textContent}`, 'info');
                });
            });
            
            elements.citySelect.addEventListener('change', (e) => {
                gameState.selectedCity = e.target.value;
                stats.currentStreak = 0;
                startNewGame();
                showToast(`城市已切换到${e.target.options[e.target.selectedIndex].text}`, 'info');
            });
            
            $('station-count').addEventListener('change', (e) => {
                const count = parseInt(e.target.value);
                if (count >= 1 && count <= 20) {
                    stats.currentStreak = 0;
                    startNewGame();
                    showToast(`站名数已设置为${count}`, 'info');
                }
            });
            
            $all('.leaderboard-tab').forEach(tab => {
                tab.addEventListener('click', () => renderLeaderboard(tab.dataset.board));
            });
            
            let keySequence = '';
            let keyTimeout = null;
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    elements.victoryModal.classList.add('hidden');
                }
                
                if (e.ctrlKey || e.metaKey || e.altKey) return;
                if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') return;
                
                if (e.key.length === 1 && /[a-zA-Z]/.test(e.key)) {
                    keySequence += e.key.toLowerCase();
                    if (keySequence.length > 5) {
                        keySequence = keySequence.slice(-5);
                    }
                    
                    if (keyTimeout) clearTimeout(keyTimeout);
                    keyTimeout = setTimeout(() => { keySequence = ''; }, 2000);
                    
                    if (keySequence === 'lvshu') {
                        gameState.devMode = !gameState.devMode;
                        renderStations();
                        if (gameState.devMode) {
                            elements.modeReverse.classList.remove('hidden');
                            showToast('开发者模式已开启', 'info');
                        } else {
                            elements.modeReverse.classList.add('hidden');
                            if (gameState.mode === 'reverse') {
                                switchMode('normal');
                            }
                            showToast('开发者模式已关闭', 'info');
                        }
                        keySequence = '';
                    }
                }
            });
        }

        init();
    </script>
</body>
</html>
