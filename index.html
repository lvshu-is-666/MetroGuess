<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°é“ç«™åçŒœè°œæ¸¸æˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="encrypted_data.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .dark .glass-panel {
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .station-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .dark .station-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-color: #475569;
        }
        
        .station-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.15);
        }
        
        .station-card.solved {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border-color: #22c55e;
        }
        
        .dark .station-card.solved {
            background: linear-gradient(135deg, #14532d 0%, #166534 100%);
            border-color: #22c55e;
        }
        
        .letter-display {
            font-family: 'Courier New', monospace;
            letter-spacing: 0.15em;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #f97316 0%, #fb923c 100%);
            transition: all 0.2s ease;
        }
        
        .btn-secondary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
        }
        
        .btn-hint {
            background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
            transition: all 0.2s ease;
        }
        
        .btn-hint:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }
        
        .mode-btn {
            transition: all 0.3s ease;
        }
        
        .mode-btn.active {
            background: #2563eb;
            color: white;
        }
        
        .difficulty-btn {
            transition: all 0.3s ease;
        }
        
        .difficulty-btn.active {
            background: #059669;
            color: white;
        }
        
        .guess-history-item {
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .letter-reveal {
            animation: popIn 0.4s ease;
        }
        
        @keyframes popIn {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .crt-overlay {
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.03),
                rgba(0, 0, 0, 0.03) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
        }
        
        .neon-glow {
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.5),
                         0 0 20px rgba(59, 130, 246, 0.3),
                         0 0 30px rgba(59, 130, 246, 0.2);
        }
        
        .input-glow:focus {
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        
        .letter-key {
            transition: all 0.2s ease;
        }
        
        .letter-key:hover {
            transform: scale(1.1);
        }
        
        .letter-key.used {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .letter-key.found {
            background: #22c55e;
            color: white;
        }
        
        .letter-key.not-found {
            background: #ef4444;
            color: white;
        }
        
        .timer-display {
            font-variant-numeric: tabular-nums;
        }
        
        .score-popup {
            animation: scorePopup 0.5s ease;
        }
        
        @keyframes scorePopup {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .achievement-badge {
            animation: badgeShine 2s ease infinite;
        }
        
        @keyframes badgeShine {
            0%, 100% {
                filter: brightness(1);
            }
            50% {
                filter: brightness(1.2);
            }
        }
        
        .leaderboard-item {
            animation: fadeInUp 0.3s ease;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #22c55e, #16a34a);
            transition: width 0.5s ease;
        }
        
        .shake {
            animation: shake 0.5s ease;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        
        .pulse-success {
            animation: pulseSuccess 0.5s ease;
        }
        
        @keyframes pulseSuccess {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        
        .float-score {
            animation: floatScore 1s ease forwards;
            pointer-events: none;
        }
        
        @keyframes floatScore {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px) scale(1.5);
            }
        }
        
        .particle {
            position: fixed;
            pointer-events: none;
            animation: particleFall 1s ease forwards;
        }
        
        @keyframes particleFall {
            0% {
                opacity: 1;
                transform: translateY(0) rotate(0deg);
            }
            100% {
                opacity: 0;
                transform: translateY(100px) rotate(360deg);
            }
        }
        
        .firework {
            position: fixed;
            pointer-events: none;
        }
        
        .firework-particle {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            animation: fireworkExplode 1s ease forwards;
        }
        
        @keyframes fireworkExplode {
            0% {
                opacity: 1;
                transform: translate(0, 0) scale(1);
            }
            100% {
                opacity: 0;
                transform: var(--end-pos) scale(0);
            }
        }
        
        .combo-display {
            animation: comboPop 0.3s ease;
        }
        
        @keyframes comboPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        .toast {
            animation: toastSlide 0.3s ease;
        }
        
        @keyframes toastSlide {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .toast-exit {
            animation: toastExit 0.3s ease forwards;
        }
        
        @keyframes toastExit {
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
        
        .tooltip {
            position: relative;
        }
        
        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 8px;
            background: #1e293b;
            color: white;
            font-size: 12px;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        
        .tooltip:hover::after {
            opacity: 1;
        }
        
        @media (max-width: 640px) {
            .letter-display {
                letter-spacing: 0.08em;
                font-size: 0.875rem;
            }
        }
        
        .sound-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .sound-toggle:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 min-h-screen text-slate-800 transition-colors duration-300">
    <div class="crt-overlay fixed inset-0 z-50 opacity-30"></div>
    
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
    
    <div id="floating-scores" class="fixed inset-0 pointer-events-none z-40"></div>
    
    <button id="sound-toggle" class="sound-toggle glass-panel shadow-lg" title="åˆ‡æ¢éŸ³æ•ˆ">
        ğŸ”Š
    </button>
    
    <div class="relative z-10 container mx-auto px-4 py-6 max-w-6xl">
        <header class="text-center mb-6">
            <div class="flex justify-center items-center gap-4 mb-2">
                <h1 class="text-3xl md:text-4xl font-bold text-slate-900 neon-glow">
                    åœ°é“ç«™åçŒœè°œæ¸¸æˆ
                </h1>
                <button id="btn-theme" class="p-2 rounded-lg bg-slate-200 hover:bg-slate-300 transition-all cursor-pointer" title="åˆ‡æ¢ä¸»é¢˜ (T)">
                    <span id="theme-icon">ğŸŒ™</span>
                </button>
            </div>
            <p class="text-slate-600 text-sm md:text-base">
                å¼€å­—æ¯ Â· çŒœç«™å Â· æŒ‘æˆ˜ä½ çš„åœ°é“çŸ¥è¯†
            </p>
        </header>
        
        <div class="glass-panel rounded-2xl p-4 mb-4 shadow-lg">
            <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium text-slate-700">éš¾åº¦:</span>
                        <div class="flex gap-2">
                            <button data-difficulty="easy" class="difficulty-btn px-3 py-1.5 rounded-lg text-sm font-medium border border-slate-200 bg-white text-slate-700 cursor-pointer">
                                ç®€å•
                            </button>
                            <button data-difficulty="normal" class="difficulty-btn active px-3 py-1.5 rounded-lg text-sm font-medium border border-slate-200 bg-white text-slate-700 cursor-pointer">
                                æ™®é€š
                            </button>
                            <button data-difficulty="hard" class="difficulty-btn px-3 py-1.5 rounded-lg text-sm font-medium border border-slate-200 bg-white text-slate-700 cursor-pointer">
                                å›°éš¾
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium text-slate-700">ç«™åæ•°:</span>
                        <input type="number" id="station-count" min="1" max="20" value="4" class="w-16 px-2 py-1.5 rounded-lg border border-slate-200 bg-white text-slate-700 text-sm text-center">
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium text-slate-700">åŸå¸‚:</span>
                        <select id="city-select" class="px-3 py-1.5 rounded-lg border border-slate-200 bg-white text-slate-700 text-sm cursor-pointer">
                            <option value="all">å…¨éƒ¨åŸå¸‚</option>
                        </select>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-center">
                        <div class="text-xs text-slate-500">è®¡æ—¶</div>
                        <div id="timer" class="text-xl font-bold text-blue-600 timer-display">00:00</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-slate-500">å¾—åˆ†</div>
                        <div id="score" class="text-xl font-bold text-green-600">0</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-slate-500">è¿å‡»</div>
                        <div id="combo" class="text-xl font-bold text-orange-600">0</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-slate-500">æç¤º</div>
                        <div id="hints-left" class="text-xl font-bold text-purple-600">3</div>
                    </div>
                </div>
            </div>
            
            <div class="mt-3">
                <div class="flex justify-between text-xs text-slate-500 mb-1">
                    <span>è¿›åº¦</span>
                    <span id="progress-text">0/0</span>
                </div>
                <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
                    <div id="progress-bar" class="progress-bar h-full rounded-full" style="width: 0%"></div>
                </div>
            </div>
        </div>
        
        <div class="flex justify-center gap-3 mb-4 flex-wrap">
            <button id="mode-normal" class="mode-btn active px-4 py-2 rounded-lg font-medium text-sm border border-slate-200 bg-white text-slate-700 cursor-pointer">
                æ™®é€šæ¨¡å¼
            </button>
            <button id="mode-multiplayer" class="mode-btn px-4 py-2 rounded-lg font-medium text-sm border border-slate-200 bg-white text-slate-700 cursor-pointer">
                è”æœºå¯¹æˆ˜
            </button>
            <button id="mode-reverse" class="mode-btn px-4 py-2 rounded-lg font-medium text-sm border border-slate-200 bg-white text-slate-700 cursor-pointer hidden">
                é€†å‘æ¨¡å¼
            </button>
            <button id="mode-leaderboard" class="mode-btn px-4 py-2 rounded-lg font-medium text-sm border border-slate-200 bg-white text-slate-700 cursor-pointer">
                æ’è¡Œæ¦œ
            </button>
        </div>
        
        <div class="glass-panel rounded-2xl p-4 md:p-6 mb-4 shadow-lg">
            <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
                <div class="flex gap-3 flex-wrap justify-center">
                    <button id="btn-new-game" class="btn-primary px-5 py-2.5 rounded-lg text-white font-medium text-sm cursor-pointer tooltip" data-tooltip="å¿«æ·é”®: N">
                        æ–°æ¸¸æˆ
                    </button>
                    <button id="btn-save" class="bg-slate-700 hover:bg-slate-800 px-4 py-2.5 rounded-lg text-white font-medium text-sm transition-all cursor-pointer tooltip" data-tooltip="å¿«æ·é”®: S">
                        ä¿å­˜
                    </button>
                    <button id="btn-load" class="bg-slate-600 hover:bg-slate-700 px-4 py-2.5 rounded-lg text-white font-medium text-sm transition-all cursor-pointer tooltip" data-tooltip="å¿«æ·é”®: L">
                        åŠ è½½
                    </button>
                    <button id="btn-hint" class="btn-hint px-4 py-2.5 rounded-lg text-white font-medium text-sm cursor-pointer tooltip" data-tooltip="å¿«æ·é”®: H">
                        æç¤º
                    </button>
                </div>
                <div id="game-stats" class="text-sm text-slate-600">
                    <span>çŒœæµ‹: <span id="guess-count">0</span>æ¬¡</span>
                </div>
            </div>
        </div>
        
        <div id="normal-mode-area" class="space-y-4">
            <div id="stations-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            </div>
            
            <div class="glass-panel rounded-2xl p-4 shadow-lg">
                <h3 class="text-sm font-semibold text-slate-700 mb-3">å­—æ¯é”®ç›˜ (ç‚¹å‡»å¼€å­—æ¯)</h3>
                <div id="letter-keyboard" class="flex flex-wrap gap-1.5 justify-center">
                </div>
            </div>
            
            <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-lg">
                <div class="flex flex-col md:flex-row gap-3">
                    <input 
                        type="text" 
                        id="guess-input" 
                        placeholder="è¾“å…¥æŒ‡ä»¤ï¼šå¼€ a / çŒœ ç«™åæˆ–å­—æ¯ / ç»“æŸ" 
                        class="flex-1 px-4 py-3 rounded-lg border border-slate-200 bg-white text-slate-800 placeholder-slate-400 input-glow focus:outline-none focus:border-blue-500 transition-all"
                        autocomplete="off"
                    >
                    <button id="btn-submit" class="btn-secondary px-6 py-3 rounded-lg text-white font-medium cursor-pointer">
                        æäº¤
                    </button>
                </div>
                <p class="text-xs text-slate-500 mt-2">
                    æŒ‡ä»¤æ ¼å¼ï¼š<span class="text-blue-600 font-medium">å¼€ [å­—æ¯]</span> æˆ– <span class="text-orange-600 font-medium">çŒœ [ç«™å/å­—æ¯]</span> æˆ– <span class="text-slate-600 font-medium">ç»“æŸ</span>
                    <span class="mx-2">|</span>
                    <span class="text-green-600">å¿«æ·é”®: A-Z å¼€å­—æ¯, Enter æäº¤</span>
                </p>
            </div>
        </div>
        
        <div id="reverse-mode-area" class="space-y-4 hidden">
            <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-lg">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">é€†å‘æ¨¡å¼ï¼šè¾“å…¥æç¤ºï¼Œè®©ç³»ç»ŸçŒœæµ‹</h3>
                <div class="flex flex-col gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">è¾“å…¥å¸¦æ˜Ÿå·çš„æç¤ºï¼ˆå¦‚ï¼š****e**ï¼‰</label>
                        <input 
                            type="text" 
                            id="reverse-input" 
                            placeholder="è¾“å…¥æç¤ºï¼Œç”¨*ä»£è¡¨æœªçŸ¥å­—æ¯" 
                            class="w-full px-4 py-3 rounded-lg border border-slate-200 bg-white text-slate-800 placeholder-slate-400 input-glow focus:outline-none focus:border-blue-500 transition-all letter-display text-center text-lg"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">å·²æ­å¼€çš„å­—æ¯ï¼ˆ*ä½ç½®ä¸èƒ½æ˜¯è¿™äº›å­—æ¯ï¼‰</label>
                        <input 
                            type="text" 
                            id="revealed-letters-input" 
                            placeholder="è¾“å…¥å·²æ­å¼€çš„å­—æ¯ï¼Œå¦‚ï¼šabc" 
                            class="w-full px-4 py-3 rounded-lg border border-slate-200 bg-white text-slate-800 placeholder-slate-400 input-glow focus:outline-none focus:border-blue-500 transition-all text-center text-lg"
                        >
                    </div>
                    <div class="flex gap-3">
                        <button id="btn-reverse-guess" class="btn-primary px-6 py-3 rounded-lg text-white font-medium cursor-pointer">
                            ç³»ç»ŸçŒœæµ‹
                        </button>
                        <button id="btn-reverse-clear" class="bg-slate-500 hover:bg-slate-600 px-6 py-3 rounded-lg text-white font-medium transition-all cursor-pointer">
                            æ¸…ç©º
                        </button>
                    </div>
                </div>
                
                <div id="reverse-results" class="mt-6 hidden">
                    <h4 class="text-sm font-medium text-slate-700 mb-3">å¯èƒ½çš„ç­”æ¡ˆï¼š</h4>
                    <div id="reverse-results-list" class="space-y-2 max-h-64 overflow-y-auto">
                    </div>
                </div>
            </div>
        </div>
        
        <div id="multiplayer-area" class="hidden">
            <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-lg">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">ğŸ® è”æœºå¯¹æˆ˜</h3>
                
                <div id="mp-lobby" class="space-y-4">
                    <div class="flex gap-3 flex-wrap">
                        <button id="btn-create-room" class="btn-primary px-4 py-2 rounded-lg text-white font-medium text-sm cursor-pointer">
                            åˆ›å»ºæˆ¿é—´
                        </button>
                        <button id="btn-quick-match" class="btn-secondary px-4 py-2 rounded-lg text-white font-medium text-sm cursor-pointer">
                            å¿«é€ŸåŒ¹é…
                        </button>
                    </div>
                    
                    <div class="flex gap-2 items-center">
                        <input type="text" id="room-code-input" placeholder="è¾“å…¥æˆ¿é—´å·" maxlength="6" class="flex-1 px-4 py-2 rounded-lg border border-slate-200 bg-white text-slate-800 uppercase tracking-widest text-center font-mono text-lg">
                        <button id="btn-join-room" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg text-white font-medium text-sm transition-all cursor-pointer">
                            åŠ å…¥æˆ¿é—´
                        </button>
                    </div>
                    
                    <div id="online-rooms" class="space-y-2">
                        <p class="text-slate-500 text-sm text-center">æ­£åœ¨åŠ è½½åœ¨çº¿æˆ¿é—´...</p>
                    </div>
                </div>
                
                <div id="mp-room" class="hidden space-y-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="text-sm text-slate-500">æˆ¿é—´å·:</span>
                            <span id="room-code-display" class="text-2xl font-bold text-blue-600 font-mono tracking-widest ml-2"></span>
                        </div>
                        <button id="btn-copy-room" class="bg-slate-200 hover:bg-slate-300 px-3 py-1.5 rounded-lg text-slate-700 text-sm cursor-pointer">
                            ğŸ“‹ å¤åˆ¶
                        </button>
                    </div>
                    
                    <div class="flex gap-2 flex-wrap">
                        <button id="btn-ready" class="btn-primary px-4 py-2 rounded-lg text-white font-medium text-sm cursor-pointer">
                            å‡†å¤‡
                        </button>
                        <button id="btn-start-game" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg text-white font-medium text-sm transition-all cursor-pointer hidden">
                            å¼€å§‹æ¸¸æˆ
                        </button>
                        <button id="btn-leave-room" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg text-white font-medium text-sm transition-all cursor-pointer">
                            ç¦»å¼€æˆ¿é—´
                        </button>
                    </div>
                    
                    <div id="room-players" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    </div>
                    
                    <div id="room-chat" class="space-y-2">
                        <div id="chat-messages" class="h-32 overflow-y-auto bg-slate-50 rounded-lg p-2 text-sm">
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯..." class="flex-1 px-3 py-1.5 rounded-lg border border-slate-200 bg-white text-slate-800 text-sm">
                            <button id="btn-send-chat" class="bg-blue-500 hover:bg-blue-600 px-3 py-1.5 rounded-lg text-white text-sm cursor-pointer">
                                å‘é€
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="mp-game" class="hidden space-y-4">
                    <div class="flex justify-between items-center">
                        <div id="mp-timer" class="text-2xl font-bold text-blue-600">00:00</div>
                        <div id="mp-round" class="text-sm text-slate-500">ç¬¬ 1 è½®</div>
                    </div>
                    
                    <div id="mp-players-status" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    </div>
                    
                    <div id="mp-station-display" class="text-center py-4">
                        <div class="letter-display text-3xl font-bold text-slate-800 mb-2"></div>
                        <div class="text-sm text-slate-500">ç­‰å¾…æ¸¸æˆå¼€å§‹...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="leaderboard-area" class="hidden">
            <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-lg">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">ğŸ† æ’è¡Œæ¦œ</h3>
                <div class="flex gap-2 mb-4">
                    <button data-board="easy" class="leaderboard-tab px-3 py-1.5 rounded-lg text-sm font-medium border border-slate-200 bg-white text-slate-700 cursor-pointer">ç®€å•</button>
                    <button data-board="normal" class="leaderboard-tab active px-3 py-1.5 rounded-lg text-sm font-medium bg-blue-500 text-white cursor-pointer">æ™®é€š</button>
                    <button data-board="hard" class="leaderboard-tab px-3 py-1.5 rounded-lg text-sm font-medium border border-slate-200 bg-white text-slate-700 cursor-pointer">å›°éš¾</button>
                </div>
                <div id="leaderboard-list" class="space-y-2">
                </div>
            </div>
            
            <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-lg mt-4">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">ğŸ“Š ç»Ÿè®¡æ•°æ®</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="text-center p-3 bg-slate-50 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600" id="stat-games">0</div>
                        <div class="text-xs text-slate-500">æ¸¸æˆæ¬¡æ•°</div>
                    </div>
                    <div class="text-center p-3 bg-slate-50 rounded-lg">
                        <div class="text-2xl font-bold text-green-600" id="stat-wins">0</div>
                        <div class="text-xs text-slate-500">èƒœåˆ©æ¬¡æ•°</div>
                    </div>
                    <div class="text-center p-3 bg-slate-50 rounded-lg">
                        <div class="text-2xl font-bold text-orange-600" id="stat-stations">0</div>
                        <div class="text-xs text-slate-500">çŒœå¯¹ç«™å</div>
                    </div>
                    <div class="text-center p-3 bg-slate-50 rounded-lg">
                        <div class="text-2xl font-bold text-purple-600" id="stat-total">0</div>
                        <div class="text-xs text-slate-500">æ€»å¾—åˆ†</div>
                    </div>
                </div>
            </div>
            
            <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-lg mt-4">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">ğŸ–ï¸ æˆå°±</h3>
                <div id="achievements-list" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                </div>
            </div>
        </div>
        
        <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-lg mt-4">
            <h3 class="text-lg font-semibold text-slate-800 mb-4">çŒœæµ‹è®°å½•</h3>
            <div id="guess-history" class="space-y-2 max-h-48 overflow-y-auto">
                <p class="text-slate-400 text-sm italic">æš‚æ— è®°å½•</p>
            </div>
        </div>
        
        <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-lg mt-4">
            <h3 class="text-lg font-semibold text-slate-800 mb-4">æ¸¸æˆè§„åˆ™</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-slate-600">
                <div>
                    <h4 class="font-medium text-slate-800 mb-2">æ™®é€šæ¨¡å¼</h4>
                    <ul class="space-y-1 list-disc list-inside">
                        <li>ç³»ç»Ÿæ ¹æ®éš¾åº¦é€‰æ‹©å¯¹åº”éš¾åº¦çš„ç«™å</li>
                        <li>ç®€å•æ¨¡å¼ï¼šçŸ­ç«™åã€å¸¸è§å­—æ¯</li>
                        <li>æ™®é€šæ¨¡å¼ï¼šä¸­ç­‰é•¿åº¦ã€é€‚ä¸­éš¾åº¦</li>
                        <li>å›°éš¾æ¨¡å¼ï¼šé•¿ç«™åã€ç¨€æœ‰å­—æ¯</li>
                        <li>å¯è‡ªå®šä¹‰ç«™åæ•°é‡ï¼ˆ1-20ä¸ªï¼‰</li>
                        <li>è¾“å…¥ <span class="font-mono bg-slate-100 px-1 rounded">å¼€ [å­—æ¯]</span> æ­å¼€å­—æ¯</li>
                        <li>è¾“å…¥ <span class="font-mono bg-slate-100 px-1 rounded">çŒœ [ç«™å]</span> çŒœæµ‹ç«™å</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-medium text-slate-800 mb-2">å¾—åˆ†è§„åˆ™</h4>
                    <ul class="space-y-1 list-disc list-inside">
                        <li>çŒœå¯¹ç«™å: +100åˆ†</li>
                        <li>å¼€å­—æ¯æ‰¾åˆ°: +10åˆ†/ç«™</li>
                        <li>è¿å‡»å¥–åŠ±: è¿å‡»æ•°Ã—5åˆ†</li>
                        <li>ä½¿ç”¨æç¤º: -30åˆ†</li>
                        <li>æ—¶é—´å¥–åŠ±: å‰©ä½™æ—¶é—´Ã—2åˆ†</li>
                        <li>éš¾åº¦åŠ æˆ: ç®€å•Ã—1, æ™®é€šÃ—1.5, å›°éš¾Ã—2</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <footer class="text-center mt-6 text-sm text-slate-500">
            <p>åˆ¶ä½œè€…ï¼š<a href="https://space.bilibili.com/lvshu" target="_blank" class="text-blue-600 hover:text-blue-700 font-medium">bilibili@lvshu</a></p>
        </footer>
    </div>
    
    <div id="victory-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 md:p-8 max-w-md w-full shadow-2xl transform scale-100 transition-transform">
            <div class="text-center">
                <div class="text-6xl mb-4">ğŸ‰</div>
                <h2 class="text-2xl font-bold text-slate-900 mb-2">æ­å–œè·èƒœï¼</h2>
                <p class="text-slate-600 mb-4">ä½ æˆåŠŸçŒœå¯¹äº†æ‰€æœ‰åœ°é“ç«™åï¼</p>
                <div class="bg-slate-100 rounded-lg p-4 mb-4">
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <div class="text-sm text-slate-500">ç”¨æ—¶</div>
                            <div id="final-time" class="text-xl font-bold text-blue-600">00:00</div>
                        </div>
                        <div>
                            <div class="text-sm text-slate-500">å¾—åˆ†</div>
                            <div id="final-score" class="text-xl font-bold text-green-600 score-popup">0</div>
                        </div>
                        <div>
                            <div class="text-sm text-slate-500">çŒœæµ‹æ¬¡æ•°</div>
                            <div id="final-guesses" class="text-xl font-bold text-orange-600">0</div>
                        </div>
                        <div>
                            <div class="text-sm text-slate-500">ä½¿ç”¨æç¤º</div>
                            <div id="final-hints" class="text-xl font-bold text-purple-600">0</div>
                        </div>
                    </div>
                </div>
                <div class="mb-4">
                    <input type="text" id="player-name" placeholder="è¾“å…¥ä½ çš„åå­—" maxlength="20" class="w-full px-4 py-2 rounded-lg border border-slate-200 bg-white text-slate-800 placeholder-slate-400 focus:outline-none focus:border-blue-500">
                </div>
                <div class="flex justify-center gap-3">
                    <button id="btn-save-score" class="btn-primary px-6 py-2.5 rounded-lg text-white font-medium cursor-pointer">
                        ä¿å­˜æˆç»©
                    </button>
                    <button id="btn-play-again" class="btn-secondary px-6 py-2.5 rounded-lg text-white font-medium cursor-pointer">
                        å†ç©ä¸€æ¬¡
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const DIFFICULTY_SETTINGS = {
            easy: { stationCount: 3, hints: 5, timeBonus: 180, multiplier: 1, difficultyLevel: 'easy' },
            normal: { stationCount: 4, hints: 3, timeBonus: 300, multiplier: 1.5, difficultyLevel: 'normal' },
            hard: { stationCount: 6, hints: 2, timeBonus: 480, multiplier: 2, difficultyLevel: 'hard' }
        };

        const LETTER_FREQUENCY = {
            common: ['e', 'a', 'r', 'i', 'o', 't', 'n', 's', 'l', 'c'],
            medium: ['u', 'd', 'p', 'm', 'h', 'g', 'b', 'f', 'y', 'w'],
            rare: ['k', 'v', 'x', 'z', 'j', 'q']
        };

        function calculateStationDifficulty(station) {
            const name = station.station_en.toLowerCase();
            let score = 0;
            
            const length = name.replace(/[^a-z]/g, '').length;
            if (length <= 5) score += 1;
            else if (length <= 8) score += 2;
            else if (length <= 12) score += 3;
            else score += 4;
            
            const specialChars = (name.match(/['().]/g) || []).length;
            score += specialChars * 0.5;
            
            const letters = name.replace(/[^a-z]/g, '');
            const uniqueLetters = new Set(letters.split(''));
            
            LETTER_FREQUENCY.rare.forEach(letter => {
                if (uniqueLetters.has(letter)) score += 1;
            });
            
            LETTER_FREQUENCY.medium.forEach(letter => {
                if (uniqueLetters.has(letter)) score += 0.3;
            });
            
            const letterCounts = {};
            letters.split('').forEach(l => letterCounts[l] = (letterCounts[l] || 0) + 1);
            const repeatCount = Object.values(letterCounts).filter(c => c > 1).length;
            score -= repeatCount * 0.3;
            
            const commonLetterCount = LETTER_FREQUENCY.common.filter(l => uniqueLetters.has(l)).length;
            score -= commonLetterCount * 0.1;
            
            if (score <= 2) return 'easy';
            if (score <= 4) return 'normal';
            return 'hard';
        }

        function classifyStationsByDifficulty() {
            const classified = { easy: [], normal: [], hard: [] };
            stationDatabase.forEach(station => {
                const difficulty = calculateStationDifficulty(station);
                classified[difficulty].push({ ...station, calculatedDifficulty: difficulty });
            });
            return classified;
        }

        const ACHIEVEMENTS = [
            { id: 'first_win', name: 'åˆæ¬¡èƒœåˆ©', desc: 'å®Œæˆç¬¬ä¸€å±€æ¸¸æˆ', icon: 'ğŸ…' },
            { id: 'speed_demon', name: 'é€Ÿåº¦æ¶é­”', desc: '60ç§’å†…å®Œæˆæ¸¸æˆ', icon: 'âš¡' },
            { id: 'perfect', name: 'å®Œç¾çŒœæµ‹', desc: 'ä¸ä½¿ç”¨æç¤ºå®Œæˆæ¸¸æˆ', icon: 'ğŸ’¯' },
            { id: 'explorer', name: 'æ¢ç´¢è€…', desc: 'è§£é”æ‰€æœ‰åŸå¸‚', icon: 'ğŸ—ºï¸' },
            { id: 'master', name: 'åœ°é“å¤§å¸ˆ', desc: 'ç´¯è®¡å¾—åˆ†è¶…è¿‡10000', icon: 'ğŸ‘‘' },
            { id: 'streak_3', name: 'ä¸‰è¿èƒœ', desc: 'è¿ç»­è·èƒœ3å±€', icon: 'ğŸ”¥' },
            { id: 'streak_5', name: 'äº”è¿èƒœ', desc: 'è¿ç»­è·èƒœ5å±€', icon: 'ğŸ’' },
            { id: 'collector', name: 'æ”¶è—å®¶', desc: 'çŒœå¯¹100ä¸ªç«™å', icon: 'ğŸ¯' }
        ];

        let gameState = {
            mode: 'normal',
            difficulty: 'normal',
            selectedCity: 'all',
            stations: [],
            revealedLetters: {},
            solvedStations: new Set(),
            guessCount: 0,
            guessHistory: [],
            gameWon: false,
            score: 0,
            hintsUsed: 0,
            hintsLeft: 3,
            startTime: null,
            elapsedTime: 0,
            usedLetters: new Set(),
            foundLetters: new Set(),
            combo: 0,
            lastCorrectTime: 0,
            devMode: false
        };

        let stationDatabase = [];
        let timerInterval = null;
        let isDarkMode = false;
        let soundEnabled = true;
        let audioContext = null;
        let stats = {
            totalScore: 0,
            gamesPlayed: 0,
            gamesWon: 0,
            stationsSolved: 0,
            currentStreak: 0,
            bestStreak: 0,
            unlockedCities: new Set(['all']),
            achievements: new Set(),
            leaderboards: { easy: [], normal: [], hard: [] }
        };

        const elements = {
            stationsContainer: document.getElementById('stations-container'),
            guessInput: document.getElementById('guess-input'),
            reverseInput: document.getElementById('reverse-input'),
            revealedLettersInput: document.getElementById('revealed-letters-input'),
            btnSubmit: document.getElementById('btn-submit'),
            btnReverseGuess: document.getElementById('btn-reverse-guess'),
            btnReverseClear: document.getElementById('btn-reverse-clear'),
            btnNewGame: document.getElementById('btn-new-game'),
            btnSave: document.getElementById('btn-save'),
            btnLoad: document.getElementById('btn-load'),
            btnHint: document.getElementById('btn-hint'),
            btnTheme: document.getElementById('btn-theme'),
            btnPlayAgain: document.getElementById('btn-play-again'),
            btnSaveScore: document.getElementById('btn-save-score'),
            modeNormal: document.getElementById('mode-normal'),
            modeReverse: document.getElementById('mode-reverse'),
            modeLeaderboard: document.getElementById('mode-leaderboard'),
            normalModeArea: document.getElementById('normal-mode-area'),
            reverseModeArea: document.getElementById('reverse-mode-area'),
            leaderboardArea: document.getElementById('leaderboard-area'),
            reverseResults: document.getElementById('reverse-results'),
            reverseResultsList: document.getElementById('reverse-results-list'),
            guessHistory: document.getElementById('guess-history'),
            victoryModal: document.getElementById('victory-modal'),
            solvedCount: document.getElementById('solved-count'),
            totalCount: document.getElementById('total-count'),
            guessCount: document.getElementById('guess-count'),
            timer: document.getElementById('timer'),
            score: document.getElementById('score'),
            hintsLeft: document.getElementById('hints-left'),
            letterKeyboard: document.getElementById('letter-keyboard'),
            citySelect: document.getElementById('city-select'),
            leaderboardList: document.getElementById('leaderboard-list'),
            achievementsList: document.getElementById('achievements-list'),
            themeIcon: document.getElementById('theme-icon'),
            playerName: document.getElementById('player-name'),
            finalTime: document.getElementById('final-time'),
            finalScore: document.getElementById('final-score'),
            finalGuesses: document.getElementById('final-guesses'),
            finalHints: document.getElementById('final-hints'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            combo: document.getElementById('combo'),
            toastContainer: document.getElementById('toast-container'),
            floatingScores: document.getElementById('floating-scores'),
            soundToggle: document.getElementById('sound-toggle'),
            modeMultiplayer: document.getElementById('mode-multiplayer'),
            multiplayerArea: document.getElementById('multiplayer-area'),
            mpLobby: document.getElementById('mp-lobby'),
            mpRoom: document.getElementById('mp-room'),
            mpGame: document.getElementById('mp-game'),
            roomCodeInput: document.getElementById('room-code-input'),
            roomCodeDisplay: document.getElementById('room-code-display'),
            onlineRooms: document.getElementById('online-rooms'),
            roomPlayers: document.getElementById('room-players'),
            chatMessages: document.getElementById('chat-messages'),
            chatInput: document.getElementById('chat-input')
        };

        const csvData = `city_cn,city_en,station_cn,station_en
åŒ—äº¬,Beijing,å¤åŸ,Gucheng
åŒ—äº¬,Beijing,å…«å®å±±,Babaoshan
åŒ—äº¬,Beijing,ç‰æ³‰è·¯,Yuquan Lu
åŒ—äº¬,Beijing,äº”æ£µæ¾,Wukesong
åŒ—äº¬,Beijing,ä¸‡å¯¿è·¯,Wanshou Lu
åŒ—äº¬,Beijing,å…¬ä¸»åŸ,Gongzhufen
åŒ—äº¬,Beijing,å†›äº‹åšç‰©é¦†,Military Museum
åŒ—äº¬,Beijing,æœ¨æ¨¨åœ°,Muxidi
åŒ—äº¬,Beijing,å—ç¤¼å£«è·¯,Nanlishi Lu
åŒ—äº¬,Beijing,å¤å…´é—¨,Fuxingmen
åŒ—äº¬,Beijing,è¥¿å•,Xidan
åŒ—äº¬,Beijing,å¤©å®‰é—¨è¥¿,Tian'anmenxi
åŒ—äº¬,Beijing,å¤©å®‰é—¨ä¸œ,Tian'anmendong
åŒ—äº¬,Beijing,ç‹åºœäº•,Wangfujing
åŒ—äº¬,Beijing,ä¸œå•,Dongdan
åŒ—äº¬,Beijing,å»ºå›½é—¨,Jianguomen
åŒ—äº¬,Beijing,æ°¸å®‰é‡Œ,Yong'an Li
åŒ—äº¬,Beijing,å›½è´¸,Guomao
åŒ—äº¬,Beijing,å¤§æœ›è·¯,Dawang Lu
åŒ—äº¬,Beijing,å››æƒ ,Sihui
åŒ—äº¬,Beijing,å››æƒ ä¸œ,Sihui Dong (E)
åŒ—äº¬,Beijing,é«˜ç¢‘åº—,Gaobeidian
åŒ—äº¬,Beijing,ä¼ åª’å¤§å­¦,Communication Univ. of China
åŒ—äº¬,Beijing,åŒæ¡¥,Shuang Qiao
åŒ—äº¬,Beijing,ç®¡åº„,Guaanzhuang
åŒ—äº¬,Beijing,å…«é‡Œæ¡¥,Bali Qiao
åŒ—äº¬,Beijing,é€šå·åŒ—è‹‘,Tongzhou Beiyuan
åŒ—äº¬,Beijing,æœå›­,Guoyuan
åŒ—äº¬,Beijing,ä¹æ£µæ ‘,Jiukeshu
åŒ—äº¬,Beijing,æ¢¨å›­,Liyuan
åŒ—äº¬,Beijing,ä¸´æ²³é‡Œ,Linheli
åŒ—äº¬,Beijing,åœŸæ¡¥,Tu Qiao
åŒ—äº¬,Beijing,èŠ±åº„,Huazhuang
åŒ—äº¬,Beijing,ç¯çƒåº¦å‡åŒº,Universal Resort
åŒ—äº¬,Beijing,è¥¿ç›´é—¨,Xizhimen
åŒ—äº¬,Beijing,è½¦å…¬åº„,Chegongzhuang
åŒ—äº¬,Beijing,é˜œæˆé—¨,Fucheng Men
åŒ—äº¬,Beijing,é•¿æ¤¿è¡—,Changchun Jie
åŒ—äº¬,Beijing,å®£æ­¦é—¨,Xuanwu Men
åŒ—äº¬,Beijing,å’Œå¹³é—¨,Heping Men
åŒ—äº¬,Beijing,å‰é—¨,Qianmen
åŒ—äº¬,Beijing,å´‡æ–‡é—¨,Chongwen Men
åŒ—äº¬,Beijing,åŒ—äº¬ç«™,Beijing Zhan
åŒ—äº¬,Beijing,æœé˜³é—¨,Chaoyang Men
åŒ—äº¬,Beijing,ä¸œå››åæ¡,Dongsi Shitiao
åŒ—äº¬,Beijing,ä¸œç›´é—¨,Dongzhimen
åŒ—äº¬,Beijing,é›å’Œå®«,Yonghegong
åŒ—äº¬,Beijing,å®‰å®šé—¨,Anding Men
åŒ—äº¬,Beijing,é¼“æ¥¼å¤§è¡—,Gulou Dajie
åŒ—äº¬,Beijing,ç§¯æ°´æ½­,Jishuitan
åŒ—äº¬,Beijing,å·¥äººä½“è‚²åœº,Workers' Stadium
åŒ—äº¬,Beijing,å›¢ç»“æ¹–,Tuanjiehu
åŒ—äº¬,Beijing,æœé˜³å…¬å›­,Chaoyang Park
ä¸Šæµ·,Shanghai,äººæ°‘å¹¿åœº,People's Square
ä¸Šæµ·,Shanghai,å—äº¬ä¸œè·¯,East Nanjing Road
ä¸Šæµ·,Shanghai,é™†å®¶å˜´,Lujiazui
ä¸Šæµ·,Shanghai,è±«å›­,Yuyuan Garden
ä¸Šæµ·,Shanghai,å¤–æ»©,The Bund
ä¸Šæµ·,Shanghai,å—äº¬è¥¿è·¯,West Nanjing Road
ä¸Šæµ·,Shanghai,é™å®‰å¯º,Jing'an Temple
ä¸Šæµ·,Shanghai,å¾å®¶æ±‡,Xujiahui
ä¸Šæµ·,Shanghai,æ·®æµ·ä¸­è·¯,Middle Huaihai Road
ä¸Šæµ·,Shanghai,æ–°å¤©åœ°,Xintiandi
å¹¿å·,Guangzhou,ä½“è‚²è¥¿è·¯,Tiyu Xilu
å¹¿å·,Guangzhou,ç æ±Ÿæ–°åŸ,Zhujiang New Town
å¹¿å·,Guangzhou,å¹¿å·å¡”,Canton Tower
å¹¿å·,Guangzhou,å…¬å›­å‰,Gongyuan Qian
å¹¿å·,Guangzhou,åŒ—äº¬è·¯,Beijing Road
å¹¿å·,Guangzhou,çƒˆå£«é™µå›­,Martyrs' Park
æ·±åœ³,Shenzhen,åå¼ºåŒ—,Huaqiangbei
æ·±åœ³,Shenzhen,ä¸–ç•Œä¹‹çª—,Window of the World
æ·±åœ³,Shenzhen,æ¬¢ä¹è°·,Happy Valley
æ·±åœ³,Shenzhen,å¸‚æ°‘ä¸­å¿ƒ,Civic Center
æ·±åœ³,Shenzhen,è´­ç‰©å…¬å›­,Shopping Park
æˆéƒ½,Chengdu,æ˜¥ç†™è·¯,Chunxi Road
æˆéƒ½,Chengdu,å¤©åºœå¹¿åœº,Tianfu Square
æˆéƒ½,Chengdu,å®½çª„å··å­,Kuanzhai Alley
æˆéƒ½,Chengdu,é”¦é‡Œ,Jinli
æˆéƒ½,Chengdu,ç†ŠçŒ«åŸºåœ°,Panda Base
æ­å·,Hangzhou,è¥¿æ¹–,West Lake
æ­å·,Hangzhou,é¾™ç¿”æ¡¥,Longxiangqiao
æ­å·,Hangzhou,æ­¦æ—å¹¿åœº,Wulin Square
æ­å·,Hangzhou,é’±æ±Ÿæ–°åŸ,Qianjiang New City
æ­å·,Hangzhou,è§å±±æœºåœº,Xiaoshan Airport
å—äº¬,Nanjing,æ–°è¡—å£,Xinjiekou
å—äº¬,Nanjing,å¤«å­åº™,Confucius Temple
å—äº¬,Nanjing,ç„æ­¦æ¹–,Xuanwu Lake
å—äº¬,Nanjing,ä¸­å±±é™µ,Sun Yat-sen Mausoleum
å—äº¬,Nanjing,å—äº¬å—ç«™,Nanjing South Station`;

        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.log('Web Audio API not supported');
            }
        }

        function playSound(type) {
            if (!soundEnabled || !audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            const now = audioContext.currentTime;
            
            switch (type) {
                case 'reveal':
                    oscillator.frequency.setValueAtTime(440, now);
                    oscillator.frequency.exponentialRampToValueAtTime(880, now + 0.1);
                    gainNode.gain.setValueAtTime(0.1, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    oscillator.start(now);
                    oscillator.stop(now + 0.1);
                    break;
                case 'correct':
                    oscillator.frequency.setValueAtTime(523, now);
                    oscillator.frequency.setValueAtTime(659, now + 0.1);
                    oscillator.frequency.setValueAtTime(784, now + 0.2);
                    gainNode.gain.setValueAtTime(0.15, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                    oscillator.start(now);
                    oscillator.stop(now + 0.3);
                    break;
                case 'wrong':
                    oscillator.frequency.setValueAtTime(200, now);
                    oscillator.frequency.exponentialRampToValueAtTime(100, now + 0.2);
                    gainNode.gain.setValueAtTime(0.1, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                    oscillator.start(now);
                    oscillator.stop(now + 0.2);
                    break;
                case 'victory':
                    const notes = [523, 587, 659, 698, 784, 880, 988, 1047];
                    notes.forEach((freq, i) => {
                        const osc = audioContext.createOscillator();
                        const gain = audioContext.createGain();
                        osc.connect(gain);
                        gain.connect(audioContext.destination);
                        osc.frequency.setValueAtTime(freq, now + i * 0.1);
                        gain.gain.setValueAtTime(0.1, now + i * 0.1);
                        gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.1 + 0.15);
                        osc.start(now + i * 0.1);
                        osc.stop(now + i * 0.1 + 0.15);
                    });
                    break;
                case 'hint':
                    oscillator.frequency.setValueAtTime(600, now);
                    oscillator.frequency.exponentialRampToValueAtTime(400, now + 0.15);
                    gainNode.gain.setValueAtTime(0.1, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                    oscillator.start(now);
                    oscillator.stop(now + 0.15);
                    break;
                case 'combo':
                    oscillator.frequency.setValueAtTime(800 + gameState.combo * 50, now);
                    gainNode.gain.setValueAtTime(0.08, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.08);
                    oscillator.start(now);
                    oscillator.stop(now + 0.08);
                    break;
            }
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            elements.soundToggle.textContent = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
            if (soundEnabled && !audioContext) {
                initAudio();
            }
            showToast(soundEnabled ? 'éŸ³æ•ˆå·²å¼€å¯' : 'éŸ³æ•ˆå·²å…³é—­', 'info');
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast px-4 py-2 rounded-lg shadow-lg text-sm font-medium ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                'bg-slate-700 text-white'
            }`;
            toast.textContent = message;
            elements.toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('toast-exit');
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        function showFloatingScore(points, x, y) {
            const scoreEl = document.createElement('div');
            scoreEl.className = 'float-score text-2xl font-bold text-green-500';
            scoreEl.textContent = `+${points}`;
            scoreEl.style.left = `${x}px`;
            scoreEl.style.top = `${y}px`;
            elements.floatingScores.appendChild(scoreEl);
            
            setTimeout(() => scoreEl.remove(), 1000);
        }

        function createParticles(x, y, count = 10) {
            const colors = ['#22c55e', '#3b82f6', '#f97316', '#eab308', '#ec4899'];
            
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = `${x + (Math.random() - 0.5) * 100}px`;
                particle.style.top = `${y}px`;
                particle.style.width = `${Math.random() * 10 + 5}px`;
                particle.style.height = particle.style.width;
                particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                particle.style.borderRadius = '50%';
                document.body.appendChild(particle);
                
                setTimeout(() => particle.remove(), 1000);
            }
        }

        function createFireworks() {
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
            
            for (let f = 0; f < 5; f++) {
                setTimeout(() => {
                    const x = Math.random() * window.innerWidth;
                    const y = Math.random() * window.innerHeight * 0.5;
                    
                    for (let i = 0; i < 30; i++) {
                        const particle = document.createElement('div');
                        particle.className = 'firework-particle';
                        particle.style.left = `${x}px`;
                        particle.style.top = `${y}px`;
                        particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                        
                        const angle = (i / 30) * Math.PI * 2;
                        const distance = 50 + Math.random() * 100;
                        const endX = Math.cos(angle) * distance;
                        const endY = Math.sin(angle) * distance;
                        
                        particle.style.setProperty('--end-pos', `translate(${endX}px, ${endY}px)`);
                        
                        const firework = document.createElement('div');
                        firework.className = 'firework';
                        firework.style.left = '0';
                        firework.style.top = '0';
                        firework.appendChild(particle);
                        document.body.appendChild(firework);
                        
                        setTimeout(() => firework.remove(), 1000);
                    }
                }, f * 300);
            }
        }

        function parseCSV(data) {
            const lines = data.trim().split('\n');
            const result = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());
                
                if (values.length >= 4) {
                    result.push({
                        city_cn: values[0],
                        city_en: values[1],
                        station_cn: values[2],
                        station_en: values[3]
                    });
                }
            }
            return result;
        }

        

        function decryptData(encryptedBase64, key) {
            const encrypted = Uint8Array.from(atob(encryptedBase64), c => c.charCodeAt(0));
            const keyBytes = new TextEncoder().encode(key);
            const decrypted = new Uint8Array(encrypted.length);
            for (let i = 0; i < encrypted.length; i++) {
                decrypted[i] = encrypted[i] ^ keyBytes[i % keyBytes.length];
            }
            return new TextDecoder().decode(decrypted);
        }

        function loadEncryptedData() {
            try {
                const decrypted = decryptData(ENCRYPTED_DATA, DECRYPT_KEY);
                const parsed = parseCSV(decrypted);
                if (parsed.length > 0) {
                    stationDatabase = parsed;
                    console.log(`Loaded ${parsed.length} stations from encrypted data`);
                    updateCitySelect();
                }
            } catch (e) {
                console.log('Failed to decrypt data:', e);
            }
        }

        async function loadCSVFromFile() {
            loadEncryptedData();
        }

        function updateCitySelect() {
            const cities = [...new Set(stationDatabase.map(s => s.city_cn))].sort();
            elements.citySelect.innerHTML = '<option value="all">å…¨éƒ¨åŸå¸‚</option>';
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                elements.citySelect.appendChild(option);
            });
        }

        function loadStats() {
            const saved = localStorage.getItem('subwayGameStats');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    stats = {
                        ...parsed,
                        unlockedCities: new Set(parsed.unlockedCities || ['all']),
                        achievements: new Set(parsed.achievements || [])
                    };
                } catch (e) {
                    console.error('Failed to load stats:', e);
                }
            }
        }

        function saveStats() {
            const toSave = {
                ...stats,
                unlockedCities: Array.from(stats.unlockedCities),
                achievements: Array.from(stats.achievements)
            };
            localStorage.setItem('subwayGameStats', JSON.stringify(toSave));
        }

        function updateStatsDisplay() {
            document.getElementById('stat-games').textContent = stats.gamesPlayed;
            document.getElementById('stat-wins').textContent = stats.gamesWon;
            document.getElementById('stat-stations').textContent = stats.stationsSolved;
            document.getElementById('stat-total').textContent = stats.totalScore;
        }

        // ========== è”æœºæ¨¡å— ==========
        const MULTIPLAYER_CONFIG = {
            apiKey: "AIzaSyDPs3vZRgXUCEYJ6qWJc69YYKVfRfj8PuM",
            authDomain: "metroguess-lvshu.firebaseapp.com",
            databaseURL: "https://metroguess-lvshu-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "metroguess-lvshu",
            storageBucket: "metroguess-lvshu.firebasestorage.app",
            messagingSenderId: "331461414999",
            appId: "1:331461414999:web:50beeb73a94ca4ba971312",
            measurementId: "G-YWSMLL0YNC"
        };

        let mpState = {
            connected: false,
            playerId: null,
            playerName: 'ç©å®¶' + Math.random().toString(36).substr(2, 4).toUpperCase(),
            roomId: null,
            isHost: false,
            isReady: false,
            gameStarted: false
        };

        let db = null;
        let roomRef = null;
        let playersRef = null;
        let chatRef = null;

        function initFirebase() {
            try {
                if (typeof firebase !== 'undefined' && firebase.app) {
                    firebase.initializeApp(MULTIPLAYER_CONFIG);
                    db = firebase.database();
                    mpState.connected = true;
                    mpState.playerId = localStorage.getItem('mp_player_id') || generatePlayerId();
                    localStorage.setItem('mp_player_id', mpState.playerId);
                    console.log('Firebase initialized');
                    loadOnlineRooms();
                }
            } catch (e) {
                console.log('Firebase init failed, running in offline mode:', e);
            }
        }

        function generatePlayerId() {
            return 'p_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        function generateRoomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        async function createRoom() {
            if (!mpState.connected) {
                showToast('è¯·å…ˆè¿æ¥ç½‘ç»œ', 'error');
                return;
            }

            const roomCode = generateRoomCode();
            mpState.roomId = roomCode;
            mpState.isHost = true;

            roomRef = db.ref('rooms/' + roomCode);
            
            await roomRef.set({
                host: mpState.playerId,
                status: 'waiting',
                createdAt: Date.now(),
                settings: {
                    difficulty: gameState.difficulty,
                    stationCount: parseInt(document.getElementById('station-count').value) || 4
                }
            });

            playersRef = roomRef.child('players/' + mpState.playerId);
            await playersRef.set({
                name: mpState.playerName,
                score: 0,
                isReady: true,
                isHost: true,
                joinedAt: Date.now()
            });

            setupRoomListeners();
            showRoomUI(roomCode);
            showToast('æˆ¿é—´å·²åˆ›å»º: ' + roomCode, 'success');
        }

        async function joinRoom(roomCode) {
            if (!mpState.connected) {
                showToast('è¯·å…ˆè¿æ¥ç½‘ç»œ', 'error');
                return;
            }

            roomCode = roomCode.toUpperCase().trim();
            if (roomCode.length !== 6) {
                showToast('æˆ¿é—´å·æ ¼å¼é”™è¯¯', 'error');
                return;
            }

            roomRef = db.ref('rooms/' + roomCode);
            
            const snapshot = await roomRef.once('value');
            if (!snapshot.exists()) {
                showToast('æˆ¿é—´ä¸å­˜åœ¨', 'error');
                return;
            }

            const roomData = snapshot.val();
            if (roomData.status !== 'waiting') {
                showToast('æ¸¸æˆå·²å¼€å§‹', 'error');
                return;
            }

            mpState.roomId = roomCode;
            mpState.isHost = false;

            playersRef = roomRef.child('players/' + mpState.playerId);
            await playersRef.set({
                name: mpState.playerName,
                score: 0,
                isReady: false,
                isHost: false,
                joinedAt: Date.now()
            });

            setupRoomListeners();
            showRoomUI(roomCode);
            showToast('å·²åŠ å…¥æˆ¿é—´', 'success');
        }

        function setupRoomListeners() {
            if (!roomRef) return;

            roomRef.child('players').on('value', (snapshot) => {
                const players = snapshot.val() || {};
                renderRoomPlayers(players);
            });

            roomRef.child('status').on('value', (snapshot) => {
                const status = snapshot.val();
                if (status === 'playing') {
                    startMultiplayerGame();
                }
            });

            chatRef = roomRef.child('chat');
            chatRef.limitToLast(50).on('child_added', (snapshot) => {
                const msg = snapshot.val();
                addChatMessage(msg.name, msg.text, msg.time);
            });
        }

        function renderRoomPlayers(players) {
            elements.roomPlayers.innerHTML = '';
            Object.entries(players).forEach(([id, player]) => {
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg border ${player.isReady ? 'bg-green-50 border-green-200' : 'bg-slate-50 border-slate-200'}`;
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="font-medium ${id === mpState.playerId ? 'text-blue-600' : 'text-slate-800'}">${player.name}</span>
                        ${player.isHost ? '<span class="text-xs bg-yellow-100 text-yellow-700 px-1 rounded">æˆ¿ä¸»</span>' : ''}
                    </div>
                    <div class="text-xs ${player.isReady ? 'text-green-600' : 'text-slate-500'}">
                        ${player.isReady ? 'âœ“ å·²å‡†å¤‡' : 'ç­‰å¾…ä¸­...'}
                    </div>
                `;
                elements.roomPlayers.appendChild(div);
            });
        }

        function addChatMessage(name, text, time) {
            const div = document.createElement('div');
            div.className = 'text-sm';
            div.innerHTML = `<span class="font-medium text-blue-600">${name}:</span> <span class="text-slate-700">${text}</span>`;
            elements.chatMessages.appendChild(div);
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
        }

        async function sendChatMessage() {
            const text = elements.chatInput.value.trim();
            if (!text || !chatRef) return;
            
            await chatRef.push({
                name: mpState.playerName,
                text: text,
                time: Date.now()
            });
            elements.chatInput.value = '';
        }

        async function toggleReady() {
            if (!playersRef) return;
            mpState.isReady = !mpState.isReady;
            await playersRef.child('isReady').set(mpState.isReady);
            
            document.getElementById('btn-ready').textContent = mpState.isReady ? 'å–æ¶ˆå‡†å¤‡' : 'å‡†å¤‡';
            document.getElementById('btn-ready').className = mpState.isReady 
                ? 'bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded-lg text-white font-medium text-sm cursor-pointer'
                : 'btn-primary px-4 py-2 rounded-lg text-white font-medium text-sm cursor-pointer';

            updateStartButton();
        }

        function updateStartButton() {
            const startBtn = document.getElementById('btn-start-game');
            if (mpState.isHost && mpState.isReady) {
                startBtn.classList.remove('hidden');
            } else {
                startBtn.classList.add('hidden');
            }
        }

        async function startGame() {
            if (!roomRef || !mpState.isHost) return;
            await roomRef.child('status').set('playing');
        }

        async function checkAllReady() {
            if (!roomRef) return;
            const snapshot = await roomRef.child('players').once('value');
            const players = snapshot.val() || {};
            const allReady = Object.values(players).every(p => p.isReady);
            const playerCount = Object.keys(players).length;

            if (allReady && playerCount >= 1) {
                updateStartButton();
            }
        }

        async function leaveRoom() {
            if (playersRef) {
                await playersRef.remove();
            }
            if (mpState.isHost && roomRef) {
                await roomRef.remove();
            }
            cleanupRoom();
            showLobbyUI();
            showToast('å·²ç¦»å¼€æˆ¿é—´', 'info');
        }

        function cleanupRoom() {
            if (roomRef) {
                roomRef.child('players').off();
                roomRef.child('status').off();
                if (chatRef) chatRef.off();
            }
            roomRef = null;
            playersRef = null;
            chatRef = null;
            mpState.roomId = null;
            mpState.isHost = false;
            mpState.isReady = false;
        }

        function showRoomUI(roomCode) {
            elements.mpLobby.classList.add('hidden');
            elements.mpRoom.classList.remove('hidden');
            elements.roomCodeDisplay.textContent = roomCode;
            elements.chatMessages.innerHTML = '';
        }

        function showLobbyUI() {
            elements.mpLobby.classList.remove('hidden');
            elements.mpRoom.classList.add('hidden');
            elements.mpGame.classList.add('hidden');
        }

        async function loadOnlineRooms() {
            if (!db) return;
            
            const roomsRef = db.ref('rooms');
            roomsRef.orderByChild('status').equalTo('waiting').limitToLast(10).on('value', (snapshot) => {
                const rooms = snapshot.val() || {};
                renderOnlineRooms(rooms);
            });
        }

        function renderOnlineRooms(rooms) {
            elements.onlineRooms.innerHTML = '';
            
            if (Object.keys(rooms).length === 0) {
                elements.onlineRooms.innerHTML = '<p class="text-slate-500 text-sm text-center">æš‚æ— åœ¨çº¿æˆ¿é—´</p>';
                return;
            }

            Object.entries(rooms).forEach(([code, room]) => {
                const playerCount = room.players ? Object.keys(room.players).length : 0;
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-slate-50 rounded-lg hover:bg-slate-100 cursor-pointer transition-all';
                div.innerHTML = `
                    <div>
                        <span class="font-mono font-bold text-blue-600">${code}</span>
                        <span class="text-xs text-slate-500 ml-2">${room.settings?.difficulty || 'æ™®é€š'} Â· ${playerCount}äºº</span>
                    </div>
                    <button class="join-room-btn bg-green-500 hover:bg-green-600 px-3 py-1 rounded text-white text-sm" data-room="${code}">
                        åŠ å…¥
                    </button>
                `;
                elements.onlineRooms.appendChild(div);
            });

            document.querySelectorAll('.join-room-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    joinRoom(btn.dataset.room);
                });
            });
        }

        function startMultiplayerGame() {
            elements.mpRoom.classList.add('hidden');
            elements.mpGame.classList.remove('hidden');
            mpState.gameStarted = true;
            startNewGame();
            showToast('æ¸¸æˆå¼€å§‹ï¼', 'success');
        }

        function quickMatch() {
            showToast('æ­£åœ¨åŒ¹é…...', 'info');
            setTimeout(() => {
                const fakeRoom = generateRoomCode();
                joinRoom(fakeRoom);
            }, 1500);
        }

        function copyRoomCode() {
            navigator.clipboard.writeText(mpState.roomId).then(() => {
                showToast('æˆ¿é—´å·å·²å¤åˆ¶', 'success');
            });
        }

        // ========== è”æœºæ¨¡å—ç»“æŸ ==========

        async function init() {
            stationDatabase = parseCSV(csvData);
            await loadCSVFromFile();
            loadStats();
            updateCitySelect();
            renderAchievements();
            updateStatsDisplay();
            startNewGame();
            setupEventListeners();
            initAudio();
            initFirebase();
        }

        function startNewGame() {
            stopTimer();
            
            const settings = DIFFICULTY_SETTINGS[gameState.difficulty];
            const customCount = parseInt(document.getElementById('station-count').value) || settings.stationCount;
            const stationCount = Math.min(Math.max(customCount, 1), 20);
            
            const classified = classifyStationsByDifficulty();
            const targetDifficulty = settings.difficultyLevel;
            
            let pool = classified[targetDifficulty];
            
            if (gameState.selectedCity !== 'all') {
                pool = pool.filter(s => s.city_cn === gameState.selectedCity);
            }
            
            if (pool.length < stationCount) {
                let allPool = gameState.selectedCity === 'all' 
                    ? stationDatabase 
                    : stationDatabase.filter(s => s.city_cn === gameState.selectedCity);
                allPool = allPool.map(s => ({
                    ...s,
                    calculatedDifficulty: calculateStationDifficulty(s)
                }));
                pool = allPool;
            }
            
            const shuffled = [...pool].sort(() => Math.random() - 0.5);
            const selected = shuffled.slice(0, stationCount);
            
            gameState = {
                mode: gameState.mode,
                difficulty: gameState.difficulty,
                selectedCity: gameState.selectedCity,
                stations: selected,
                revealedLetters: {},
                solvedStations: new Set(),
                guessCount: 0,
                guessHistory: [],
                gameWon: false,
                score: 0,
                hintsUsed: 0,
                hintsLeft: settings.hints,
                startTime: Date.now(),
                elapsedTime: 0,
                usedLetters: new Set(),
                foundLetters: new Set(),
                combo: 0,
                lastCorrectTime: 0,
                devMode: false
            };
            
            selected.forEach((_, index) => {
                gameState.revealedLetters[index] = new Set();
            });
            
            elements.victoryModal.classList.add('hidden');
            
            renderStations();
            renderLetterKeyboard();
            updateStats();
            renderGuessHistory();
            startTimer();
            updateProgressBar();
        }

        function startTimer() {
            stopTimer();
            timerInterval = setInterval(() => {
                gameState.elapsedTime = Math.floor((Date.now() - gameState.startTime) / 1000);
                updateTimerDisplay();
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(gameState.elapsedTime / 60);
            const seconds = gameState.elapsedTime % 60;
            elements.timer.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function updateProgressBar() {
            const total = gameState.stations.length;
            const solved = gameState.solvedStations.size;
            const percent = total > 0 ? (solved / total) * 100 : 0;
            elements.progressBar.style.width = `${percent}%`;
            elements.progressText.textContent = `${solved}/${total}`;
        }

        function renderStations() {
            elements.stationsContainer.innerHTML = '';
            
            gameState.stations.forEach((station, index) => {
                const isSolved = gameState.solvedStations.has(index);
                const revealed = gameState.revealedLetters[index];
                const displayText = getDisplayText(station.station_en, revealed, isSolved, gameState.devMode);
                const difficulty = station.calculatedDifficulty || calculateStationDifficulty(station);
                const difficultyLabel = difficulty === 'easy' ? 'ç®€å•' : difficulty === 'normal' ? 'æ™®é€š' : 'å›°éš¾';
                const difficultyColor = difficulty === 'easy' ? 'bg-green-100 text-green-700' : 
                                       difficulty === 'normal' ? 'bg-yellow-100 text-yellow-700' : 
                                       'bg-red-100 text-red-700';
                
                const card = document.createElement('div');
                card.className = `station-card rounded-xl p-4 ${isSolved ? 'solved' : ''}`;
                card.id = `station-${index}`;
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs font-medium text-slate-500">#${index + 1}</span>
                        <div class="flex items-center gap-2">
                            <span class="text-xs px-2 py-0.5 rounded ${difficultyColor}">${difficultyLabel}</span>
                            ${isSolved ? '<span class="text-green-600 text-sm font-medium">âœ“ å·²è§£å¼€</span>' : ''}
                        </div>
                    </div>
                    <div class="letter-display text-lg md:text-xl font-bold text-slate-800 mb-3 text-center py-2 bg-white/50 rounded-lg dark:bg-slate-700/50 dark:text-slate-200">
                        ${displayText}
                    </div>
                    ${(isSolved || gameState.devMode) ? `
                        <div class="text-center text-sm">
                            <p class="text-slate-800 font-medium dark:text-slate-200">${station.station_cn}</p>
                            <p class="text-slate-500 text-xs">${station.city_cn} Â· ${station.city_en}</p>
                        </div>
                    ` : ''}
                `;
                elements.stationsContainer.appendChild(card);
            });
        }

        function getDisplayText(stationName, revealedLetters, isSolved, devMode = false) {
            if (isSolved || devMode) {
                return stationName;
            }
            
            return stationName.split('').map(char => {
                const lowerChar = char.toLowerCase();
                if (/[a-z]/.test(lowerChar)) {
                    if (revealedLetters.has(lowerChar)) {
                        return `<span class="letter-reveal text-blue-600">${char}</span>`;
                    }
                    return '*';
                }
                return '*';
            }).join('');
        }

        function renderLetterKeyboard() {
            elements.letterKeyboard.innerHTML = '';
            const letters = 'abcdefghijklmnopqrstuvwxyz'.split('');
            
            letters.forEach(letter => {
                const btn = document.createElement('button');
                const isUsed = gameState.usedLetters.has(letter);
                const isFound = gameState.foundLetters.has(letter);
                
                btn.className = `letter-key w-8 h-8 rounded text-sm font-medium cursor-pointer ${
                    isFound ? 'found' : isUsed ? 'not-found used' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'
                }`;
                btn.textContent = letter.toUpperCase();
                btn.disabled = isUsed || gameState.gameWon;
                btn.dataset.letter = letter;
                
                if (!isUsed && !gameState.gameWon) {
                    btn.addEventListener('click', () => {
                        revealLetter(letter);
                    });
                }
                
                elements.letterKeyboard.appendChild(btn);
            });
        }

        function handleGuess() {
            const input = elements.guessInput.value.trim();
            if (!input) return;
            
            elements.guessInput.value = '';
            
            const command = input.toLowerCase();
            
            if (command === 'lvshu') {
                gameState.devMode = !gameState.devMode;
                renderStations();
                if (gameState.devMode) {
                    elements.modeReverse.classList.remove('hidden');
                    addToHistory('å¼€å‘è€…æ¨¡å¼å·²å¼€å¯', 'info', 'æ‰€æœ‰ç­”æ¡ˆå·²æ˜¾ç¤º');
                    showToast('å¼€å‘è€…æ¨¡å¼å·²å¼€å¯', 'info');
                } else {
                    elements.modeReverse.classList.add('hidden');
                    if (gameState.mode === 'reverse') {
                        switchMode('normal');
                    }
                    addToHistory('å¼€å‘è€…æ¨¡å¼å·²å…³é—­', 'info', 'æ¢å¤æ¸¸æˆçŠ¶æ€');
                    showToast('å¼€å‘è€…æ¨¡å¼å·²å…³é—­', 'info');
                }
                return;
            }
            
            gameState.guessCount++;
            
            if (command === 'ç»“æŸ') {
                addToHistory('ç»“æŸæ¸¸æˆ', 'info');
                startNewGame();
                return;
            }
            
            if (command.startsWith('å¼€ ')) {
                const letter = command.slice(2).trim().toLowerCase();
                if (letter.length === 1 && /[a-z]/.test(letter)) {
                    revealLetter(letter);
                } else {
                    addToHistory(`æ— æ•ˆæŒ‡ä»¤: ${input}`, 'error');
                }
            } else if (command.startsWith('çŒœ ')) {
                const guess = command.slice(2).trim();
                if (guess.length === 1 && /[a-z]/i.test(guess)) {
                    revealLetter(guess.toLowerCase());
                } else {
                    guessStation(guess);
                }
            } else {
                addToHistory(`æ— æ•ˆæŒ‡ä»¤: ${input}`, 'error');
            }
            
            updateStats();
        }

        function revealLetter(letter) {
            if (gameState.usedLetters.has(letter)) {
                addToHistory(`å­—æ¯ ${letter.toUpperCase()} å·²ä½¿ç”¨`, 'error');
                showToast('è¯¥å­—æ¯å·²ä½¿ç”¨', 'error');
                return;
            }
            
            gameState.usedLetters.add(letter);
            let found = false;
            let matchCount = 0;
            
            gameState.stations.forEach((station, index) => {
                if (gameState.solvedStations.has(index)) return;
                
                const stationLower = station.station_en.toLowerCase();
                if (stationLower.includes(letter)) {
                    found = true;
                    gameState.revealedLetters[index].add(letter);
                    matchCount++;
                    gameState.score += 10;
                }
            });
            
            if (found) {
                gameState.foundLetters.add(letter);
                playSound('reveal');
                addToHistory(`å¼€ ${letter.toUpperCase()}`, 'success', `åœ¨ ${matchCount} ä¸ªç«™åä¸­æ‰¾åˆ° (+${matchCount * 10}åˆ†)`);
                
                const btn = document.querySelector(`[data-letter="${letter}"]`);
                if (btn) {
                    createParticles(btn.getBoundingClientRect().left + 16, btn.getBoundingClientRect().top + 16, 5);
                }
            } else {
                playSound('wrong');
                addToHistory(`å¼€ ${letter.toUpperCase()}`, 'error', 'æœªæ‰¾åˆ°è¯¥å­—æ¯');
                
                elements.stationsContainer.classList.add('shake');
                setTimeout(() => elements.stationsContainer.classList.remove('shake'), 500);
            }
            
            renderStations();
            renderLetterKeyboard();
            updateScoreDisplay();
        }

        function guessStation(guess) {
            let correct = false;
            let matchedStation = null;
            let matchedIndex = -1;
            
            gameState.stations.forEach((station, index) => {
                if (gameState.solvedStations.has(index)) return;
                
                const stationCn = station.station_cn.toLowerCase();
                const stationEn = station.station_en.toLowerCase();
                const guessLower = guess.toLowerCase();
                
                if (guessLower === stationCn || guessLower === stationEn) {
                    correct = true;
                    matchedIndex = index;
                    matchedStation = station;
                }
            });
            
            if (correct && matchedIndex !== -1) {
                gameState.solvedStations.add(matchedIndex);
                
                const now = Date.now();
                if (now - gameState.lastCorrectTime < 5000) {
                    gameState.combo++;
                    playSound('combo');
                } else {
                    gameState.combo = 1;
                }
                gameState.lastCorrectTime = now;
                
                const comboBonus = gameState.combo * 5;
                const totalPoints = 100 + comboBonus;
                gameState.score += totalPoints;
                stats.stationsSolved++;
                
                playSound('correct');
                addToHistory(`çŒœ ${guess}`, 'success', `æ­£ç¡®ï¼${matchedStation.city_cn} Â· ${matchedStation.station_cn} (+${totalPoints}åˆ†)`);
                
                const card = document.getElementById(`station-${matchedIndex}`);
                if (card) {
                    card.classList.add('pulse-success');
                    const rect = card.getBoundingClientRect();
                    showFloatingScore(totalPoints, rect.left + rect.width / 2, rect.top);
                    createParticles(rect.left + rect.width / 2, rect.top + rect.height / 2, 15);
                }
                
                renderStations();
                updateScoreDisplay();
                updateProgressBar();
                updateComboDisplay();
                checkWinCondition();
            } else {
                gameState.combo = 0;
                updateComboDisplay();
                playSound('wrong');
                addToHistory(`çŒœ ${guess}`, 'error', 'ä¸æ­£ç¡®');
                
                elements.stationsContainer.classList.add('shake');
                setTimeout(() => elements.stationsContainer.classList.remove('shake'), 500);
            }
        }

        function updateComboDisplay() {
            elements.combo.textContent = gameState.combo;
            if (gameState.combo > 1) {
                elements.combo.classList.add('combo-display');
                setTimeout(() => elements.combo.classList.remove('combo-display'), 300);
            }
        }

        function useHint() {
            if (gameState.hintsLeft <= 0) {
                addToHistory('æç¤ºæ¬¡æ•°å·²ç”¨å®Œ', 'error');
                showToast('æç¤ºæ¬¡æ•°å·²ç”¨å®Œ', 'error');
                return;
            }
            
            const unsolvedIndices = gameState.stations
                .map((_, index) => index)
                .filter(index => !gameState.solvedStations.has(index));
            
            if (unsolvedIndices.length === 0) return;
            
            const randomIndex = unsolvedIndices[Math.floor(Math.random() * unsolvedIndices.length)];
            const station = gameState.stations[randomIndex];
            const stationLower = station.station_en.toLowerCase();
            
            const unrevealedLetters = stationLower
                .split('')
                .filter(char => /[a-z]/.test(char) && !gameState.revealedLetters[randomIndex].has(char));
            
            if (unrevealedLetters.length === 0) {
                addToHistory('è¯¥ç«™åå·²å…¨éƒ¨æ­å¼€', 'info');
                return;
            }
            
            const randomLetter = unrevealedLetters[Math.floor(Math.random() * unrevealedLetters.length)];
            gameState.revealedLetters[randomIndex].add(randomLetter);
            gameState.usedLetters.add(randomLetter);
            gameState.foundLetters.add(randomLetter);
            gameState.hintsLeft--;
            gameState.hintsUsed++;
            gameState.score = Math.max(0, gameState.score - 30);
            
            playSound('hint');
            addToHistory(`ä½¿ç”¨æç¤º`, 'info', `æ­ç¤ºå­—æ¯ ${randomLetter.toUpperCase()} (-30åˆ†)`);
            showToast(`æç¤ºï¼šå­—æ¯ ${randomLetter.toUpperCase()}`, 'info');
            
            renderStations();
            renderLetterKeyboard();
            updateScoreDisplay();
            elements.hintsLeft.textContent = gameState.hintsLeft;
        }

        function checkWinCondition() {
            if (gameState.solvedStations.size === gameState.stations.length) {
                gameState.gameWon = true;
                stopTimer();
                
                const settings = DIFFICULTY_SETTINGS[gameState.difficulty];
                const timeBonus = Math.max(0, settings.timeBonus - gameState.elapsedTime) * 2;
                gameState.score += timeBonus;
                gameState.score = Math.floor(gameState.score * settings.multiplier);
                
                stats.gamesPlayed++;
                stats.gamesWon++;
                stats.currentStreak++;
                stats.bestStreak = Math.max(stats.bestStreak, stats.currentStreak);
                stats.totalScore += gameState.score;
                
                checkAchievements();
                saveStats();
                updateStatsDisplay();
                
                playSound('victory');
                createFireworks();
                
                setTimeout(() => {
                    elements.finalTime.textContent = formatTime(gameState.elapsedTime);
                    elements.finalScore.textContent = gameState.score;
                    elements.finalGuesses.textContent = gameState.guessCount;
                    elements.finalHints.textContent = gameState.hintsUsed;
                    elements.victoryModal.classList.remove('hidden');
                }, 500);
            }
        }

        function checkAchievements() {
            if (!stats.achievements.has('first_win')) {
                stats.achievements.add('first_win');
                showToast('ğŸ† æˆå°±è§£é”ï¼šåˆæ¬¡èƒœåˆ©ï¼', 'success');
            }
            
            if (gameState.elapsedTime <= 60 && !stats.achievements.has('speed_demon')) {
                stats.achievements.add('speed_demon');
                showToast('ğŸ† æˆå°±è§£é”ï¼šé€Ÿåº¦æ¶é­”ï¼', 'success');
            }
            
            if (gameState.hintsUsed === 0 && !stats.achievements.has('perfect')) {
                stats.achievements.add('perfect');
                showToast('ğŸ† æˆå°±è§£é”ï¼šå®Œç¾çŒœæµ‹ï¼', 'success');
            }
            
            if (stats.currentStreak >= 3 && !stats.achievements.has('streak_3')) {
                stats.achievements.add('streak_3');
                showToast('ğŸ† æˆå°±è§£é”ï¼šä¸‰è¿èƒœï¼', 'success');
            }
            
            if (stats.currentStreak >= 5 && !stats.achievements.has('streak_5')) {
                stats.achievements.add('streak_5');
                showToast('ğŸ† æˆå°±è§£é”ï¼šäº”è¿èƒœï¼', 'success');
            }
            
            if (stats.totalScore >= 10000 && !stats.achievements.has('master')) {
                stats.achievements.add('master');
                showToast('ğŸ† æˆå°±è§£é”ï¼šåœ°é“å¤§å¸ˆï¼', 'success');
            }
            
            if (stats.stationsSolved >= 100 && !stats.achievements.has('collector')) {
                stats.achievements.add('collector');
                showToast('ğŸ† æˆå°±è§£é”ï¼šæ”¶è—å®¶ï¼', 'success');
            }
            
            if (gameState.selectedCity !== 'all' && !stats.unlockedCities.has(gameState.selectedCity)) {
                stats.unlockedCities.add(gameState.selectedCity);
            }
            
            renderAchievements();
        }

        function renderAchievements() {
            elements.achievementsList.innerHTML = '';
            
            ACHIEVEMENTS.forEach(achievement => {
                const unlocked = stats.achievements.has(achievement.id);
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg border ${unlocked ? 'bg-yellow-50 border-yellow-200' : 'bg-slate-50 border-slate-200 opacity-50'}`;
                div.innerHTML = `
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-xl ${unlocked ? 'achievement-badge' : ''}">${achievement.icon}</span>
                        <span class="font-medium text-sm ${unlocked ? 'text-slate-800' : 'text-slate-500'}">${achievement.name}</span>
                    </div>
                    <p class="text-xs text-slate-500">${achievement.desc}</p>
                `;
                elements.achievementsList.appendChild(div);
            });
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function updateScoreDisplay() {
            elements.score.textContent = gameState.score;
        }

        function handleReverseGuess() {
            const pattern = elements.reverseInput.value.trim().toLowerCase();
            const revealedLetters = elements.revealedLettersInput.value.trim().toLowerCase();
            if (!pattern) return;
            
            if (!/^[a-z*\s'().]+$/.test(pattern)) {
                addToHistory('è¯·è¾“å…¥æœ‰æ•ˆçš„æç¤º', 'error');
                return;
            }
            
            const matches = findMatchingStations(pattern, revealedLetters);
            renderReverseResults(matches, pattern, revealedLetters);
        }

        function findMatchingStations(pattern, revealedLetters = '') {
            const revealedSet = new Set(revealedLetters.replace(/[^a-z]/g, '').split(''));
            
            return stationDatabase.filter(station => {
                const name = station.station_en.toLowerCase();
                if (name.length !== pattern.length) return false;
                
                for (let i = 0; i < pattern.length; i++) {
                    if (pattern[i] !== '*' && pattern[i] !== name[i]) {
                        return false;
                    }
                    if (pattern[i] === '*' && revealedSet.has(name[i])) {
                        return false;
                    }
                }
                
                return true;
            });
        }

        function renderReverseResults(matches, pattern, revealedLetters = '') {
            elements.reverseResults.classList.remove('hidden');
            elements.reverseResultsList.innerHTML = '';
            
            if (matches.length === 0) {
                elements.reverseResultsList.innerHTML = `
                    <div class="text-slate-500 text-center py-4">
                        æœªæ‰¾åˆ°åŒ¹é…çš„ç«™å
                    </div>
                `;
                return;
            }
            
            matches.slice(0, 20).forEach(station => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-3 bg-white rounded-lg border border-slate-200 hover:border-blue-300 transition-all cursor-pointer';
                item.innerHTML = `
                    <div>
                        <p class="font-medium text-slate-800">${station.station_en}</p>
                        <p class="text-sm text-slate-500">${station.station_cn} Â· ${station.city_cn}</p>
                    </div>
                    <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">åŒ¹é…</span>
                `;
                elements.reverseResultsList.appendChild(item);
            });
            
            if (matches.length > 20) {
                const more = document.createElement('div');
                more.className = 'text-center text-slate-500 text-sm py-2';
                more.textContent = `è¿˜æœ‰ ${matches.length - 20} ä¸ªç»“æœ...`;
                elements.reverseResultsList.appendChild(more);
            }
            
            const revealedInfo = revealedLetters ? `ï¼Œå·²æ­å¼€å­—æ¯: ${revealedLetters}` : '';
            addToHistory(`é€†å‘çŒœæµ‹: ${pattern}${revealedInfo}`, 'info', `æ‰¾åˆ° ${matches.length} ä¸ªåŒ¹é…`);
        }

        function addToHistory(action, type, detail = '') {
            const timestamp = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            const historyItem = { action, type, detail, timestamp };
            gameState.guessHistory.push(historyItem);
            renderGuessHistory();
        }

        function renderGuessHistory() {
            if (gameState.guessHistory.length === 0) {
                elements.guessHistory.innerHTML = '<p class="text-slate-400 text-sm italic">æš‚æ— è®°å½•</p>';
                return;
            }
            
            elements.guessHistory.innerHTML = '';
            [...gameState.guessHistory].reverse().forEach(item => {
                const div = document.createElement('div');
                div.className = 'guess-history-item flex items-center justify-between p-2 rounded-lg text-sm';
                
                let typeClass = '';
                let typeIcon = '';
                switch (item.type) {
                    case 'success':
                        typeClass = 'bg-green-50 text-green-800';
                        typeIcon = 'âœ“';
                        break;
                    case 'error':
                        typeClass = 'bg-red-50 text-red-800';
                        typeIcon = 'âœ—';
                        break;
                    default:
                        typeClass = 'bg-slate-50 text-slate-700';
                        typeIcon = 'â€¢';
                }
                
                div.className += ` ${typeClass}`;
                div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="font-medium">${typeIcon}</span>
                        <span>${item.action}</span>
                        ${item.detail ? `<span class="text-xs opacity-75">- ${item.detail}</span>` : ''}
                    </div>
                    <span class="text-xs opacity-50">${item.timestamp}</span>
                `;
                elements.guessHistory.appendChild(div);
            });
        }

        function updateStats() {
            elements.guessCount.textContent = gameState.guessCount;
            elements.hintsLeft.textContent = gameState.hintsLeft;
        }

        function switchMode(mode) {
            gameState.mode = mode;
            
            elements.modeNormal.classList.remove('active');
            elements.modeReverse.classList.remove('active');
            elements.modeLeaderboard.classList.remove('active');
            elements.modeMultiplayer.classList.remove('active');
            elements.normalModeArea.classList.add('hidden');
            elements.reverseModeArea.classList.add('hidden');
            elements.leaderboardArea.classList.add('hidden');
            elements.multiplayerArea.classList.add('hidden');
            
            if (mode === 'normal') {
                elements.modeNormal.classList.add('active');
                elements.normalModeArea.classList.remove('hidden');
                elements.guessInput.focus();
            } else if (mode === 'reverse') {
                elements.modeReverse.classList.add('active');
                elements.reverseModeArea.classList.remove('hidden');
                elements.reverseInput.focus();
            } else if (mode === 'leaderboard') {
                elements.modeLeaderboard.classList.add('active');
                elements.leaderboardArea.classList.remove('hidden');
                renderLeaderboard('normal');
                updateStatsDisplay();
            } else if (mode === 'multiplayer') {
                elements.modeMultiplayer.classList.add('active');
                elements.multiplayerArea.classList.remove('hidden');
            }
        }

        function renderLeaderboard(difficulty) {
            const board = stats.leaderboards[difficulty] || [];
            elements.leaderboardList.innerHTML = '';
            
            document.querySelectorAll('.leaderboard-tab').forEach(tab => {
                tab.classList.remove('active', 'bg-blue-500', 'text-white');
                tab.classList.add('bg-white', 'text-slate-700');
                if (tab.dataset.board === difficulty) {
                    tab.classList.add('active', 'bg-blue-500', 'text-white');
                    tab.classList.remove('bg-white', 'text-slate-700');
                }
            });
            
            if (board.length === 0) {
                elements.leaderboardList.innerHTML = '<p class="text-slate-500 text-center py-4">æš‚æ— è®°å½•</p>';
                return;
            }
            
            board.slice(0, 10).forEach((entry, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item flex items-center justify-between p-3 bg-white rounded-lg border border-slate-200';
                item.style.animationDelay = `${index * 0.1}s`;
                
                const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}.`;
                
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-xl">${medal}</span>
                        <div>
                            <p class="font-medium text-slate-800">${entry.name}</p>
                            <p class="text-xs text-slate-500">${entry.date}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-green-600">${entry.score}</p>
                        <p class="text-xs text-slate-500">${formatTime(entry.time)} Â· ${entry.guesses}æ¬¡</p>
                    </div>
                `;
                elements.leaderboardList.appendChild(item);
            });
        }

        function saveScore() {
            const name = elements.playerName.value.trim() || 'åŒ¿åç©å®¶';
            const entry = {
                name,
                score: gameState.score,
                time: gameState.elapsedTime,
                guesses: gameState.guessCount,
                hints: gameState.hintsUsed,
                date: new Date().toLocaleDateString('zh-CN')
            };
            
            if (!stats.leaderboards[gameState.difficulty]) {
                stats.leaderboards[gameState.difficulty] = [];
            }
            
            stats.leaderboards[gameState.difficulty].push(entry);
            stats.leaderboards[gameState.difficulty].sort((a, b) => b.score - a.score);
            stats.leaderboards[gameState.difficulty] = stats.leaderboards[gameState.difficulty].slice(0, 10);
            
            saveStats();
            showToast('æˆç»©å·²ä¿å­˜ï¼', 'success');
            
            elements.victoryModal.classList.add('hidden');
            switchMode('leaderboard');
            renderLeaderboard(gameState.difficulty);
        }

        function saveGameState() {
            const stateToSave = {
                ...gameState,
                revealedLetters: Object.fromEntries(
                    Object.entries(gameState.revealedLetters).map(([k, v]) => [k, Array.from(v)])
                ),
                solvedStations: Array.from(gameState.solvedStations),
                usedLetters: Array.from(gameState.usedLetters),
                foundLetters: Array.from(gameState.foundLetters)
            };
            localStorage.setItem('subwayGameState', JSON.stringify(stateToSave));
            addToHistory('ä¿å­˜æ¸¸æˆ', 'info', 'æ¸¸æˆçŠ¶æ€å·²ä¿å­˜');
            showToast('æ¸¸æˆå·²ä¿å­˜ï¼', 'success');
        }

        function loadGameState() {
            const saved = localStorage.getItem('subwayGameState');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    gameState = {
                        ...parsed,
                        revealedLetters: Object.fromEntries(
                            Object.entries(parsed.revealedLetters || {}).map(([k, v]) => [k, new Set(v)])
                        ),
                        solvedStations: new Set(parsed.solvedStations || []),
                        usedLetters: new Set(parsed.usedLetters || []),
                        foundLetters: new Set(parsed.foundLetters || [])
                    };
                    
                    switchMode(gameState.mode);
                    renderStations();
                    renderLetterKeyboard();
                    updateStats();
                    updateScoreDisplay();
                    updateProgressBar();
                    renderGuessHistory();
                    
                    if (gameState.gameWon) {
                        elements.victoryModal.classList.remove('hidden');
                    }
                    
                    addToHistory('åŠ è½½æ¸¸æˆ', 'info', 'æ¸¸æˆçŠ¶æ€å·²åŠ è½½');
                    showToast('æ¸¸æˆå·²åŠ è½½ï¼', 'success');
                } catch (e) {
                    console.error('Failed to load game state:', e);
                    showToast('åŠ è½½å¤±è´¥ï¼', 'error');
                }
            } else {
                showToast('æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„æ¸¸æˆï¼', 'error');
            }
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark', isDarkMode);
            
            if (isDarkMode) {
                document.body.classList.remove('bg-gradient-to-br', 'from-slate-50', 'via-blue-50', 'to-indigo-100');
                document.body.classList.add('bg-gradient-to-br', 'from-slate-900', 'via-slate-800', 'to-slate-900', 'text-slate-200');
                elements.themeIcon.textContent = 'â˜€ï¸';
            } else {
                document.body.classList.remove('bg-gradient-to-br', 'from-slate-900', 'via-slate-800', 'to-slate-900', 'text-slate-200');
                document.body.classList.add('bg-gradient-to-br', 'from-slate-50', 'via-blue-50', 'to-indigo-100', 'text-slate-800');
                elements.themeIcon.textContent = 'ğŸŒ™';
            }
            showToast(isDarkMode ? 'å·²åˆ‡æ¢åˆ°æš—è‰²æ¨¡å¼' : 'å·²åˆ‡æ¢åˆ°äº®è‰²æ¨¡å¼', 'info');
        }

        function setupEventListeners() {
            elements.btnSubmit.addEventListener('click', handleGuess);
            elements.guessInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleGuess();
            });
            
            elements.btnReverseGuess.addEventListener('click', handleReverseGuess);
            elements.btnReverseClear.addEventListener('click', () => {
                elements.reverseInput.value = '';
                elements.revealedLettersInput.value = '';
                elements.reverseResults.classList.add('hidden');
            });
            elements.reverseInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleReverseGuess();
            });
            
            elements.btnNewGame.addEventListener('click', () => {
                stats.currentStreak = 0;
                startNewGame();
                showToast('æ–°æ¸¸æˆå¼€å§‹ï¼', 'success');
            });
            
            elements.btnSave.addEventListener('click', saveGameState);
            elements.btnLoad.addEventListener('click', loadGameState);
            elements.btnHint.addEventListener('click', useHint);
            elements.btnTheme.addEventListener('click', toggleTheme);
            elements.soundToggle.addEventListener('click', toggleSound);
            
            elements.btnPlayAgain.addEventListener('click', () => {
                elements.victoryModal.classList.add('hidden');
                startNewGame();
            });
            
            elements.btnSaveScore.addEventListener('click', saveScore);
            
            elements.modeNormal.addEventListener('click', () => switchMode('normal'));
            elements.modeReverse.addEventListener('click', () => switchMode('reverse'));
            elements.modeLeaderboard.addEventListener('click', () => switchMode('leaderboard'));
            elements.modeMultiplayer.addEventListener('click', () => switchMode('multiplayer'));
            
            document.getElementById('btn-create-room').addEventListener('click', createRoom);
            document.getElementById('btn-quick-match').addEventListener('click', quickMatch);
            document.getElementById('btn-join-room').addEventListener('click', () => {
                joinRoom(elements.roomCodeInput.value);
            });
            document.getElementById('btn-ready').addEventListener('click', toggleReady);
            document.getElementById('btn-leave-room').addEventListener('click', leaveRoom);
            document.getElementById('btn-start-game').addEventListener('click', startGame);
            document.getElementById('btn-copy-room').addEventListener('click', copyRoomCode);
            document.getElementById('btn-send-chat').addEventListener('click', sendChatMessage);
            elements.chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendChatMessage();
            });
            elements.roomCodeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') joinRoom(elements.roomCodeInput.value);
            });
            
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameState.difficulty = btn.dataset.difficulty;
                    stats.currentStreak = 0;
                    startNewGame();
                    showToast(`éš¾åº¦å·²åˆ‡æ¢åˆ°${btn.textContent}`, 'info');
                });
            });
            
            elements.citySelect.addEventListener('change', (e) => {
                gameState.selectedCity = e.target.value;
                stats.currentStreak = 0;
                startNewGame();
                showToast(`åŸå¸‚å·²åˆ‡æ¢åˆ°${e.target.options[e.target.selectedIndex].text}`, 'info');
            });
            
            document.getElementById('station-count').addEventListener('change', (e) => {
                const count = parseInt(e.target.value);
                if (count >= 1 && count <= 20) {
                    stats.currentStreak = 0;
                    startNewGame();
                    showToast(`ç«™åæ•°å·²è®¾ç½®ä¸º${count}`, 'info');
                }
            });
            
            document.querySelectorAll('.leaderboard-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    renderLeaderboard(tab.dataset.board);
                });
            });
            
            document.addEventListener('keydown', (e) => {
                if (gameState.mode !== 'normal' || gameState.gameWon) return;
                
                if (document.activeElement === elements.guessInput) return;
                
                if (e.key.length === 1 && /[a-zA-Z]/.test(e.key)) {
                    e.preventDefault();
                    revealLetter(e.key.toLowerCase());
                }
            });
            
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey || e.altKey) return;
                
                if (e.key === 'n' || e.key === 'N') {
                    if (document.activeElement.tagName !== 'INPUT') {
                        e.preventDefault();
                        stats.currentStreak = 0;
                        startNewGame();
                        showToast('æ–°æ¸¸æˆå¼€å§‹ï¼', 'success');
                    }
                }
                
                if (e.key === 's' || e.key === 'S') {
                    if (document.activeElement.tagName !== 'INPUT') {
                        e.preventDefault();
                        saveGameState();
                    }
                }
                
                if (e.key === 'l' || e.key === 'L') {
                    if (document.activeElement.tagName !== 'INPUT') {
                        e.preventDefault();
                        loadGameState();
                    }
                }
                
                if (e.key === 'h' || e.key === 'H') {
                    if (document.activeElement.tagName !== 'INPUT') {
                        e.preventDefault();
                        useHint();
                    }
                }
                
                if (e.key === 't' || e.key === 'T') {
                    if (document.activeElement.tagName !== 'INPUT') {
                        e.preventDefault();
                        toggleTheme();
                    }
                }
                
                if (e.key === 'Escape') {
                    elements.victoryModal.classList.add('hidden');
                }
            });
        }

        init();
    </script>
</body>
</html>
